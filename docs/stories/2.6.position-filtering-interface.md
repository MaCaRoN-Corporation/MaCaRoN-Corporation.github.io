# Story 2.6: Position Filtering Interface

**Status:** Pending  
**Epic:** 2 - Data Management & Configuration  
**Story Number:** 2.6

---

## Story

**As a** user,  
**I want** to filtrer par position (Suwariwaza, Hanmi Handachi, Tashiwaza, Armes),  
**so that** je peux me concentrer sur certaines catégories de techniques.

---

## Acceptance Criteria

1. La page de configuration affiche une section "Filtres de position"
2. Les positions disponibles sont affichées selon le grade sélectionné (via GradeService)
3. Chaque position peut être incluse ou exclue via des checkboxes ou toggles
4. Par défaut, toutes les positions disponibles pour le grade sont incluses
5. Les filtres sont sauvegardés dans le composant ConfigComponent
6. L'interface permet de sélectionner/désélectionner toutes les positions rapidement (bouton "Tout sélectionner/Désélectionner")
7. Les filtres sont clairement étiquetés et organisés
8. La liste des positions est dynamique selon le grade sélectionné
9. Les positions affichées excluent "Randori" (car c'est une annonce audio, pas une position)
10. Le design est responsive et fonctionne sur mobile et desktop

---

## Tasks / Subtasks

- [ ] **Task 1: Create Position Filtering Section** (AC: 1, 7)
  - [ ] Ajouter une section "Filtres de position" dans le template ConfigComponent
  - [ ] Utiliser un titre clair (h2 ou h3)
  - [ ] Structurer avec des checkboxes organisées

- [ ] **Task 2: Integrate GradeService to Get Positions** (AC: 2, 8)
  - [ ] Utiliser GradeService.getPositionsForGrade(grade) pour obtenir les positions
  - [ ] Stocker les positions disponibles dans une propriété (availablePositions: Position[])
  - [ ] Mettre à jour la liste des positions lorsque le grade change
  - [ ] Filtrer "Randori" de la liste (s'assurer qu'il n'est pas retourné par GradeService)

- [ ] **Task 3: Implement Position Checkboxes/Toggles** (AC: 3, 9)
  - [ ] Créer des checkboxes pour chaque position disponible
  - [ ] Utiliser le type Position pour le typage
  - [ ] Afficher les labels clairs pour chaque position
  - [ ] S'assurer que "Randori" n'apparaît pas dans la liste

- [ ] **Task 4: Implement Position Selection Logic** (AC: 5)
  - [ ] Créer une propriété selectedPositions: Position[] dans le composant
  - [ ] Initialiser avec toutes les positions disponibles (par défaut toutes sélectionnées)
  - [ ] Créer une méthode onPositionToggle(position: Position) pour ajouter/retirer
  - [ ] Sauvegarder les positions sélectionnées dans le composant

- [ ] **Task 5: Implement "Select All / Deselect All" Feature** (AC: 6)
  - [ ] Créer un bouton "Tout sélectionner" / "Tout désélectionner"
  - [ ] Implémenter la logique pour sélectionner/désélectionner toutes les positions
  - [ ] Changer le label du bouton selon l'état (toutes sélectionnées ou non)
  - [ ] Mettre à jour selectedPositions en conséquence

- [ ] **Task 6: Handle Grade Change and Update Positions** (AC: 8)
  - [ ] Écouter les changements du grade sélectionné (Story 2.3)
  - [ ] Quand le grade change, récupérer les nouvelles positions disponibles
  - [ ] Réinitialiser selectedPositions avec toutes les nouvelles positions (par défaut)
  - [ ] Mettre à jour l'affichage des checkboxes

- [ ] **Task 7: Implement Default Selection** (AC: 4)
  - [ ] S'assurer que toutes les positions disponibles sont sélectionnées par défaut
  - [ ] Appliquer la sélection par défaut lors du chargement initial
  - [ ] Appliquer la sélection par défaut lors du changement de grade

- [ ] **Task 8: Add Visual Feedback** (AC: 7)
  - [ ] Style pour les checkboxes sélectionnées
  - [ ] Style pour les checkboxes non sélectionnées
  - [ ] Style pour hover/focus (accessibilité)
  - [ ] Utiliser les variables CSS du thème

- [ ] **Task 9: Implement Responsive Design** (AC: 10)
  - [ ] Adapter le layout pour mobile (une colonne, checkboxes empilées)
  - [ ] Adapter le layout pour desktop (deux colonnes ou grille si beaucoup de positions)
  - [ ] Utiliser media queries
  - [ ] Tester sur différentes tailles d'écran

- [ ] **Task 10: Add Accessibility Features** (AC: 7)
  - [ ] Ajouter des labels appropriés pour chaque checkbox
  - [ ] Assurer la navigation au clavier (tab, espace)
  - [ ] Ajouter aria-label ou aria-labelledby si nécessaire
  - [ ] Grouper les checkboxes avec fieldset/legend si approprié
  - [ ] Tester avec un lecteur d'écran

- [ ] **Task 11: Handle Empty Selection Validation** (AC: 5)
  - [ ] Valider qu'au moins une position est sélectionnée
  - [ ] Afficher un message d'erreur si aucune position n'est sélectionnée
  - [ ] Empêcher la génération du passage si aucune position n'est sélectionnée (Story 2.9)

- [ ] **Task 12: Create Unit Tests** (AC: 1-10)
  - [ ] Tester l'affichage de la section
  - [ ] Tester le chargement des positions selon le grade
  - [ ] Tester la sélection/désélection d'une position
  - [ ] Tester "Tout sélectionner/Désélectionner"
  - [ ] Tester la mise à jour lors du changement de grade
  - [ ] Tester la sélection par défaut
  - [ ] Tester la validation (au moins une position)
  - [ ] Tester que "Randori" n'apparaît pas

---

## Dev Notes

### Previous Story Insights

**Source:** Story 2.2 - JSON Parsing and Data Structure
- GradeService.getPositionsForGrade(grade) retourne Position[]
- GradeService exclut "Randori" des positions (car c'est une annonce audio)

**Source:** Story 2.3 - Grade Selection Interface
- Le grade sélectionné est disponible dans ConfigComponent (selectedGrade)
- Il faut écouter les changements de grade pour mettre à jour les positions

**Source:** Story 1.4 - Core Services Structure
- Position type est défini dans position.model.ts

### Technical Context

**Source:** [architecture/components.md](../../architecture/components.md)

**Position Type:**
```typescript
type Position = 'Suwariwaza' | 'Hanmi Handachi' | 'Tashiwaza' | 'Armes';
// Note: 'Randori' a été retiré car c'est une annonce audio, pas une position
```

**GradeService Methods:**
- `getPositionsForGrade(grade: string): Position[]` - Retourne les positions pour un grade
- Cette méthode exclut "Randori" automatiquement

**ConfigComponent:**
- **Location:** `src/app/pages/config/config.ts` et `config.html`
- **Dependency:** GradeService pour obtenir les positions

**UI/UX Considerations:**
- Utiliser des checkboxes pour sélection multiple
- Organiser les positions de manière logique (ordre: Suwariwaza, Hanmi Handachi, Tashiwaza, Armes)
- Bouton "Tout sélectionner/Désélectionner" pour meilleure UX

**Default Behavior:**
- Par défaut, toutes les positions disponibles sont sélectionnées
- Lors du changement de grade, réinitialiser avec toutes les nouvelles positions sélectionnées

**Validation:**
- Au moins une position doit être sélectionnée pour générer un passage
- Cette validation sera utilisée dans Story 2.9 (validation complète)

### Implementation Details

**Component Structure:**
```typescript
export class ConfigComponent {
  availablePositions: Position[] = [];
  selectedPositions: Position[] = [];
  allPositionsSelected: boolean = true;

  constructor(private gradeService: GradeService) {}

  ngOnInit() {
    // Initialiser avec le grade par défaut
    this.updatePositionsForGrade(this.selectedGrade);
  }

  onGradeChange(grade: string) {
    this.updatePositionsForGrade(grade);
  }

  private updatePositionsForGrade(grade: string) {
    this.availablePositions = this.gradeService.getPositionsForGrade(grade);
    // Sélectionner toutes les positions par défaut
    this.selectedPositions = [...this.availablePositions];
    this.updateAllSelectedState();
  }

  onPositionToggle(position: Position) {
    const index = this.selectedPositions.indexOf(position);
    if (index > -1) {
      this.selectedPositions.splice(index, 1);
    } else {
      this.selectedPositions.push(position);
    }
    this.updateAllSelectedState();
  }

  toggleAllPositions() {
    if (this.allPositionsSelected) {
      this.selectedPositions = [];
    } else {
      this.selectedPositions = [...this.availablePositions];
    }
    this.updateAllSelectedState();
  }

  private updateAllSelectedState() {
    this.allPositionsSelected = 
      this.selectedPositions.length === this.availablePositions.length;
  }

  isPositionSelected(position: Position): boolean {
    return this.selectedPositions.includes(position);
  }
}
```

**Template Structure:**
```html
<section class="position-filters">
  <h2>Filtres de position</h2>
  
  <div class="select-all-control">
    <button 
      type="button"
      (click)="toggleAllPositions()">
      {{ allPositionsSelected ? 'Tout désélectionner' : 'Tout sélectionner' }}
    </button>
  </div>

  <div class="positions-list">
    <label 
      *ngFor="let position of availablePositions"
      class="position-checkbox">
      <input 
        type="checkbox"
        [checked]="isPositionSelected(position)"
        (change)="onPositionToggle(position)">
      <span>{{ position }}</span>
    </label>
  </div>

  <div *ngIf="selectedPositions.length === 0" class="error-message">
    Veuillez sélectionner au moins une position.
  </div>
</section>
```

**Styling:**
- Utiliser les variables CSS du thème
- Style pour les checkboxes (taille, espacement)
- Style pour le bouton "Tout sélectionner"
- Message d'erreur si aucune position sélectionnée
- Responsive avec media queries (grille ou colonne selon écran)

---

## Dependencies

- ✅ Story 2.2 complétée (getPositionsForGrade())
- ✅ Story 2.3 complétée (grade sélectionné disponible)
- ✅ Position type défini (Story 1.4)

---

## Testing Checklist

- [ ] Test: Section position filters s'affiche
- [ ] Test: Positions sont chargées selon le grade sélectionné
- [ ] Test: "Randori" n'apparaît pas dans la liste
- [ ] Test: Toutes les positions sont sélectionnées par défaut
- [ ] Test: Sélection/désélection d'une position fonctionne
- [ ] Test: "Tout sélectionner/Désélectionner" fonctionne
- [ ] Test: Positions se mettent à jour lors du changement de grade
- [ ] Test: Validation (au moins une position) fonctionne
- [ ] Test: Responsive design fonctionne
- [ ] Test: Accessibilité (navigation clavier, labels)

---

## Definition of Done

- ✅ Tous les Acceptance Criteria sont remplis
- ✅ Code compile sans erreurs
- ✅ Tests unitaires passent (couverture minimale 70%)
- ✅ Intégration GradeService fonctionne
- ✅ "Randori" est exclu de la liste
- ✅ Interface responsive
- ✅ Accessibilité de base respectée
- ✅ Code review effectué
- ✅ Documentation du code (JSDoc) ajoutée
