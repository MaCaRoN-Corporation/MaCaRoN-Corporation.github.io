# Story 2.9: Configuration Page Complete Integration

**Status:** ✅ Done  
**Epic:** 2 - Data Management & Configuration  
**Story Number:** 2.9

---

## Story

**As a** user,  
**I want** to avoir une interface complète pour configurer mon passage avec les paramètres sur la page config et le démarrage sur la page principale,  
**so that** je peux configurer mon passage de manière complète et le démarrer facilement.

---

## Acceptance Criteria

1. ✅ La page principale (`/`) permet la sélection du mode de passage (classique, progression, aléatoire, révision)
2. ✅ La page principale affiche les filtres de techniques/attaques/positions uniquement en mode révision (via TechniqueFilterComponent)
3. ✅ La page principale contient un bouton "Hajime" bien visible pour démarrer le passage
4. ✅ La page de configuration (`/config`) intègre les sections de paramétrage : Grade, Timing, Audio, Options avancées (armes/Randori)
5. ✅ Le bouton "Hajime" génère le passage via PassageService (structure de base) et redirige vers `/passage` avec la configuration
6. ✅ La configuration est sauvegardée dans ConfigService et accessible depuis les deux pages
7. ✅ Les valeurs configurées sont stockées dans un objet PassageFilters et PassageConfig pour la génération
8. ✅ La page principale est responsive et fonctionne sur tous les appareils (mobile, tablette, desktop)
9. ✅ La page config est responsive et fonctionne sur tous les appareils (mobile, tablette, desktop)
10. ✅ Le design est cohérent avec le reste de l'application (thème, style, couleurs)
11. ✅ La navigation entre les pages est fluide et intuitive
12. ✅ Les filtres de techniques sont accessibles uniquement en mode révision sur la page principale

---

## Tasks / Subtasks

- [x] **Task 1: Organize Home Page Layout** (AC: 1, 2, 3) ✅ **IMPLÉMENTÉ**
  - [x] Page principale avec sélection du mode de passage (carousel)
  - [x] Affichage conditionnel des filtres de techniques uniquement en mode révision
  - [x] Bouton "Hajime" pour démarrer le passage
  - [x] Intégration de TechniqueFilterComponent pour les filtres (mode révision)

- [x] **Task 2: Organize Config Page Layout** (AC: 4) ✅ **IMPLÉMENTÉ**
  - [x] Page config avec sections organisées:
    1. Sélection du grade (Story 2.3)
    2. Options supplémentaires - armes/Randori (Story 2.8)
    3. Configuration du temps (Story 2.4)
    4. Sélection de la voix (Story 2.5)
  - [x] Utilisation de sections HTML sémantiques (<section>)
  - [x] Séparateurs visuels entre les sections

- [x] **Task 3: Create Configuration Object** (AC: 7) ✅ **IMPLÉMENTÉ**
  - [x] ConfigService gère la configuration complète (PassageConfig)
  - [x] PassageFilters et PassageConfig définis dans les modèles
  - [x] Configuration accessible depuis HomeComponent et ConfigComponent

- [x] **Task 4: Implement "Start Passage" Button** (AC: 3, 5) ✅ **IMPLÉMENTÉ**
  - [x] Bouton "Hajime" bien visible sur la page principale
  - [x] Style attractif (primary color, grande taille)
  - [x] Méthode startPassage() implémentée dans HomeComponent
  - [x] Sauvegarde de la configuration avant démarrage
  - [x] Redirection vers `/passage` avec le mode sélectionné

- [x] **Task 5: Implement Mode Selection** (AC: 1) ✅ **IMPLÉMENTÉ**
  - [x] Carousel de sélection des modes de passage (classique, progression, aléatoire, révision)
  - [x] Navigation entre modes (précédent/suivant)
  - [x] Sauvegarde du mode sélectionné dans ConfigService

- [x] **Task 6: Implement Conditional Technique Filters** (AC: 2, 12) ✅ **IMPLÉMENTÉ**
  - [x] TechniqueFilterComponent intégré dans HomeComponent
  - [x] Affichage conditionnel uniquement en mode révision
  - [x] Filtres hiérarchiques (positions → attaques → techniques)
  - [x] Sauvegarde des sélections dans localStorage

- [x] **Task 7: Integrate Config Page Sections** (AC: 4) ✅ **IMPLÉMENTÉ**
  - [x] Story 2.3 (Grade Selection) intégrée
  - [x] Story 2.4 (Time Configuration) intégrée
  - [x] Story 2.5 (Voice Selection) intégrée
  - [x] Story 2.8 (Weapons/Randori) intégrée
  - [x] Toutes les sections fonctionnent ensemble

- [x] **Task 8: Implement Responsive Layout** (AC: 8, 9) ✅ **IMPLÉMENTÉ**
  - [x] Layout responsive pour page principale (mobile/tablette/desktop)
  - [x] Layout responsive pour page config (mobile/tablette/desktop)
  - [x] CSS Grid/Flexbox utilisé pour le layout
  - [x] Testé sur différentes tailles d'écran

- [x] **Task 9: Ensure Design Consistency** (AC: 10) ✅ **IMPLÉMENTÉ**
  - [x] Variables CSS du thème utilisées partout
  - [x] Couleurs, espacements, typographie cohérents
  - [x] Cohérence avec le reste de l'application

- [x] **Task 10: Handle Navigation** (AC: 5, 11) ✅ **IMPLÉMENTÉ**
  - [x] Navigation fluide entre pages (home ↔ config)
  - [x] Configuration partagée via ConfigService
  - [x] Navigation vers `/passage` avec queryParams (mode)

---

## Dev Notes

### Previous Story Insights

**Source:** Story 2.3 - Grade Selection Interface
- Section de sélection de grade avec selectedGrade

**Source:** Story 2.4 - Time Configuration Controls
- Contrôles timeBetweenTechniques et totalDuration

**Source:** Story 2.5 - Voice Selection Interface
- Sélection de voix avec SettingsService

**Source:** Story 2.6 - Position Filtering Interface
- Filtres de position avec selectedPositions

**Source:** Story 2.7 - Attack and Technique Filtering Interface
- Filtres avancés avec selectedAttacks et selectedTechniques

**Source:** Story 2.8 - Weapons and Randori Configuration
- Options includeWeapons, includeRandori, randoriTime

**Source:** Story 1.4 - Core Services Structure
- PassageService a une méthode generatePassage() (structure de base)
- PassageFilters interface est définie

### Technical Context

**Source:** [architecture/components.md](../../architecture/components.md)

**ConfigComponent:**
- **Location:** `src/app/pages/config/config.ts` et `config.html`
- **Responsibility:** Page de configuration complète avant génération du passage

**PassageService:**
- **Location:** `src/app/services/passage.service.ts`
- **Method:** `generatePassage(grade: string, filters: PassageFilters, config: PassageConfig): Passage`
- **Note:** L'implémentation complète sera dans Epic 3, mais la structure de base existe

**PassageFilters Interface:**
```typescript
interface PassageFilters {
  positions: Position[];
  attacks: string[];  // Vide = toutes
  techniques: string[];  // Vide = toutes
  includeWeapons: boolean;
  includeRandori: boolean;
}
```

**PassageConfig (à créer ou utiliser Passage model properties):**
```typescript
interface PassageConfig {
  grade: string;
  timeBetweenTechniques: number;  // secondes
  totalDuration: number;  // minutes
  voice: 'masculin' | 'féminin';
  randoriTime?: number;  // secondes, si includeRandori
}
```

**Routing:**
- Route `/config` existe (Story 1.2)
- Route `/passage` existe (Story 1.2)
- Router Angular disponible

**UI/UX Considerations:**
- Organiser les sections de manière logique (du général au spécifique)
- Utiliser des cards ou sections visuellement distinctes
- Bouton "Générer" bien visible et accessible
- Messages d'erreur clairs et actionnables

**Layout Structure:**
```
Config Page
├── Header/Title
├── Grade Selection (Story 2.3)
├── Time Configuration (Story 2.4)
├── Voice Selection (Story 2.5)
├── Position Filters (Story 2.6)
├── Advanced Filters - Attacks/Techniques (Story 2.7)
├── Advanced Options - Weapons/Randori (Story 2.8)
├── Error Messages (if any)
└── Action Buttons (Generate, Reset)
```

### Implementation Details

**Component Structure:**
```typescript
export class ConfigComponent {
  // Configuration values (from previous stories)
  selectedGrade: string = '6e Kyū';
  timeBetweenTechniques: number = 5;
  totalDuration: number = 10;
  selectedVoice: 'masculin' | 'féminin' = 'masculin';
  selectedPositions: Position[] = [];
  selectedAttacks: string[] = [];
  selectedTechniques: string[] = [];
  includeWeapons: boolean = false;
  includeRandori: boolean = false;
  randoriTime: number = 10;

  validationErrors: string[] = [];
  isGenerating: boolean = false;

  constructor(
    private gradeService: GradeService,
    private passageService: PassageService,
    private router: Router,
    private settingsService: SettingsService
  ) {}

  validateConfiguration(): { valid: boolean, errors: string[] } {
    const errors: string[] = [];

    // Grade validation
    if (!this.selectedGrade || !this.gradeService.validateGrade(this.selectedGrade)) {
      errors.push('Veuillez sélectionner un grade valide.');
    }

    // Position validation
    if (this.selectedPositions.length === 0) {
      errors.push('Veuillez sélectionner au moins une position.');
    }

    // Time validation
    if (this.timeBetweenTechniques < 3 || this.timeBetweenTechniques > 30) {
      errors.push('Le temps entre techniques doit être entre 3 et 30 secondes.');
    }

    if (this.totalDuration < 5 || this.totalDuration > 60) {
      errors.push('La durée totale doit être entre 5 et 60 minutes.');
    }

    // Randori time validation
    if (this.includeRandori && (this.randoriTime < 3 || this.randoriTime > 60)) {
      errors.push('Le temps Randori doit être entre 3 et 60 secondes.');
    }

    return {
      valid: errors.length === 0,
      errors
    };
  }

  async onGeneratePassage() {
    // Validate configuration
    const validation = this.validateConfiguration();
    if (!validation.valid) {
      this.validationErrors = validation.errors;
      // Scroll to top to show errors
      window.scrollTo({ top: 0, behavior: 'smooth' });
      return;
    }

    this.isGenerating = true;
    this.validationErrors = [];

    try {
      // Build PassageFilters
      const filters: PassageFilters = {
        positions: this.selectedPositions,
        attacks: this.selectedAttacks.length > 0 ? this.selectedAttacks : [],
        techniques: this.selectedTechniques.length > 0 ? this.selectedTechniques : [],
        includeWeapons: this.includeWeapons,
        includeRandori: this.includeRandori
      };

      // Build PassageConfig
      const config: PassageConfig = {
        grade: this.selectedGrade,
        timeBetweenTechniques: this.timeBetweenTechniques,
        totalDuration: this.totalDuration,
        voice: this.selectedVoice,
        randoriTime: this.includeRandori ? this.randoriTime : undefined
      };

      // Generate passage (structure de base - implémentation complète dans Epic 3)
      const passage = this.passageService.generatePassage(
        config.grade,
        filters,
        config
      );

      // Navigate to passage page
      this.router.navigate(['/passage'], {
        state: { passage, config, filters }
      });
    } catch (error) {
      console.error('Error generating passage:', error);
      this.validationErrors = ['Une erreur est survenue lors de la génération du passage.'];
    } finally {
      this.isGenerating = false;
    }
  }

  resetConfiguration() {
    // Reset all values to defaults
    this.selectedGrade = '6e Kyū';
    this.timeBetweenTechniques = 5;
    this.totalDuration = 10;
    this.selectedVoice = 'masculin';
    this.selectedPositions = [];
    this.selectedAttacks = [];
    this.selectedTechniques = [];
    this.includeWeapons = false;
    this.includeRandori = false;
    this.randoriTime = 10;
    this.validationErrors = [];
    // Trigger updates for dependent sections
    this.updatePositionsForGrade(this.selectedGrade);
  }
}
```

**Template Structure:**
```html
<div class="config-page">
  <header class="page-header">
    <h1>Configuration du passage</h1>
    <button *ngIf="hasCustomizations()" (click)="resetConfiguration()" class="reset-button">
      Réinitialiser
    </button>
  </header>

  <!-- Error Messages -->
  <div *ngIf="validationErrors.length > 0" class="error-alert">
    <h3>Erreurs de configuration</h3>
    <ul>
      <li *ngFor="let error of validationErrors">{{ error }}</li>
    </ul>
    <button (click)="validationErrors = []">Fermer</button>
  </div>

  <!-- Grade Selection (Story 2.3) -->
  <section class="config-section">
    <!-- ... Grade selection content ... -->
  </section>

  <!-- Time Configuration (Story 2.4) -->
  <section class="config-section">
    <!-- ... Time configuration content ... -->
  </section>

  <!-- Voice Selection (Story 2.5) -->
  <section class="config-section">
    <!-- ... Voice selection content ... -->
  </section>

  <!-- Position Filters (Story 2.6) -->
  <section class="config-section">
    <!-- ... Position filters content ... -->
  </section>

  <!-- Advanced Filters (Story 2.7) -->
  <section class="config-section">
    <!-- ... Advanced filters content ... -->
  </section>

  <!-- Advanced Options (Story 2.8) -->
  <section class="config-section">
    <!-- ... Advanced options content ... -->
  </section>

  <!-- Action Buttons -->
  <footer class="config-actions">
    <button 
      class="generate-button primary"
      (click)="onGeneratePassage()"
      [disabled]="isGenerating">
      <span *ngIf="!isGenerating">Générer le passage</span>
      <span *ngIf="isGenerating">Génération en cours...</span>
    </button>
  </footer>
</div>
```

**Styling:**
- Utiliser CSS Grid ou Flexbox pour le layout
- Sections avec cards ou background distinct
- Bouton "Générer" avec style primary (grand, visible)
- Messages d'erreur avec style alert (rouge, icône)
- Responsive avec media queries
- Utiliser les variables CSS du thème partout

---

## Dependencies

- ✅ Toutes les stories 2.1-2.8 complétées
- ✅ PassageService existe (structure de base)
- ✅ Router Angular configuré
- ✅ Routes /config et /passage existent

---

## Testing Checklist

- [ ] Test: Toutes les sections sont intégrées et affichées
- [ ] Test: Layout est organisé et logique
- [ ] Test: Validation fonctionne (tous les cas)
- [ ] Test: Messages d'erreur s'affichent correctement
- [ ] Test: Bouton "Générer" fonctionne
- [ ] Test: Navigation vers /passage fonctionne
- [ ] Test: Configuration est passée correctement
- [ ] Test: Responsive design fonctionne (mobile/tablette/desktop)
- [ ] Test: Design est cohérent avec le reste de l'app
- [ ] Test: Reset fonctionne (si implémenté)
- [ ] Test: Loading state fonctionne
- [ ] Test: Accessibilité (navigation clavier, landmarks)

---

## Definition of Done

- ✅ Tous les Acceptance Criteria sont remplis
- ✅ Code compile sans erreurs
- ✅ Page principale avec sélection du mode et bouton "Hajime" fonctionnels
- ✅ Page config avec toutes les sections de paramétrage intégrées
- ✅ Filtres de techniques accessibles uniquement en mode révision
- ✅ Configuration partagée via ConfigService entre les deux pages
- ✅ Navigation vers /passage fonctionne avec le mode sélectionné
- ✅ Interface responsive (mobile/tablette/desktop)
- ✅ Design cohérent avec le thème
- ✅ Accessibilité de base respectée
- ✅ Code review effectué
- ✅ Documentation du code (JSDoc) ajoutée

---

## Notes

**Architecture finale:**
- **Page principale (`/`)**: Sélection du mode de passage, filtres de techniques (mode révision uniquement), bouton "Hajime" pour démarrer
- **Page config (`/config`)**: Paramétrage avancé (grade, temps, voix, armes/randori)
- **Configuration partagée**: Via ConfigService, accessible depuis les deux pages
- **Génération**: Le bouton "Hajime" sur la page principale sauvegarde la configuration et redirige vers `/passage`

**Important:** L'implémentation complète de PassageService.generatePassage() sera dans Epic 3. Pour cette story, on utilise la structure de base et on prépare la configuration pour la génération future.
