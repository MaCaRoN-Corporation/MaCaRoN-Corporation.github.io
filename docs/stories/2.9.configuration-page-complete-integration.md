# Story 2.9: Configuration Page Complete Integration

**Status:** Pending  
**Epic:** 2 - Data Management & Configuration  
**Story Number:** 2.9

---

## Story

**As a** user,  
**I want** to voir toutes les options de configuration sur une seule page organisée,  
**so that** je peux configurer mon passage de manière complète avant de le générer.

---

## Acceptance Criteria

1. La page de configuration (`/config`) intègre toutes les sections précédentes de manière organisée
2. Les sections sont logiquement groupées (Grade, Timing, Audio, Filtres, Options avancées)
3. Un bouton "Générer le passage" bien visible est présent en bas de la page
4. Le bouton génère le passage via PassageService (structure de base) et redirige vers `/passage` avec la configuration
5. La configuration est validée avant la génération (grade sélectionné, au moins une position incluse, etc.)
6. Des messages d'erreur clairs sont affichés si la configuration est invalide
7. La page est responsive et fonctionne sur tous les appareils (mobile, tablette, desktop)
8. Le design est cohérent avec le reste de l'application (thème, style, couleurs)
9. Un indicateur de progression ou stepper peut être ajouté pour montrer les étapes (optionnel)
10. La navigation est fluide et intuitive entre les sections
11. Un bouton "Réinitialiser" permet de remettre les valeurs par défaut (optionnel)
12. Les valeurs configurées sont stockées dans un objet PassageFilters et PassageConfig pour la génération

---

## Tasks / Subtasks

- [ ] **Task 1: Organize Sections Layout** (AC: 1, 2, 10)
  - [ ] Organiser les sections dans un ordre logique:
    1. Sélection du grade (Story 2.3)
    2. Configuration du temps (Story 2.4)
    3. Sélection de la voix (Story 2.5)
    4. Filtres de position (Story 2.6)
    5. Filtres avancés - attaques/techniques (Story 2.7)
    6. Options avancées - armes/Randori (Story 2.8)
  - [ ] Utiliser des sections HTML sémantiques (<section>)
  - [ ] Ajouter des séparateurs visuels entre les sections

- [ ] **Task 2: Create Configuration Object** (AC: 12)
  - [ ] Créer un objet de configuration dans le composant
  - [ ] Inclure toutes les valeurs: grade, timeBetweenTechniques, totalDuration, voice, filters, etc.
  - [ ] Créer un type/interface TypeScript pour la configuration complète
  - [ ] Préparer PassageFilters et PassageConfig pour PassageService

- [ ] **Task 3: Implement "Generate Passage" Button** (AC: 3, 4)
  - [ ] Ajouter un bouton "Générer le passage" bien visible en bas de la page
  - [ ] Style le bouton pour qu'il soit attractif (primary color, grande taille)
  - [ ] Implémenter la méthode onGeneratePassage()
  - [ ] Valider la configuration avant de générer
  - [ ] Appeler PassageService.generatePassage() (structure de base)
  - [ ] Rediriger vers `/passage` avec la configuration via Router

- [ ] **Task 4: Implement Comprehensive Validation** (AC: 5, 6)
  - [ ] Valider que le grade est sélectionné
  - [ ] Valider qu'au moins une position est sélectionnée
  - [ ] Valider timeBetweenTechniques (min/max)
  - [ ] Valider totalDuration (min/max)
  - [ ] Valider randoriTime si includeRandori est activé (min/max)
  - [ ] Afficher des messages d'erreur clairs pour chaque validation échouée
  - [ ] Empêcher la génération si la configuration est invalide

- [ ] **Task 5: Create Validation Methods** (AC: 5, 6)
  - [ ] Créer validateConfiguration(): { valid: boolean, errors: string[] }
  - [ ] Implémenter chaque règle de validation
  - [ ] Retourner une liste d'erreurs claires et descriptives
  - [ ] Afficher les erreurs dans le template

- [ ] **Task 6: Display Error Messages** (AC: 6)
  - [ ] Créer une section d'affichage des erreurs en haut de la page
  - [ ] Afficher les erreurs sous forme de liste ou d'alertes
  - [ ] Utiliser un style d'erreur cohérent (rouge, icône d'erreur)
  - [ ] Permettre de fermer/dismiss les erreurs après correction

- [ ] **Task 7: Implement Responsive Layout** (AC: 7)
  - [ ] Adapter le layout pour mobile (sections empilées verticalement)
  - [ ] Adapter le layout pour tablette (sections en colonnes si approprié)
  - [ ] Adapter le layout pour desktop (sections organisées, peut-être colonnes)
  - [ ] Utiliser CSS Grid ou Flexbox pour le layout responsive
  - [ ] Tester sur différentes tailles d'écran

- [ ] **Task 8: Ensure Design Consistency** (AC: 8)
  - [ ] Utiliser les variables CSS du thème partout
  - [ ] S'assurer que les couleurs, espacements, typographie sont cohérents
  - [ ] Utiliser les composants de style existants si disponibles
  - [ ] Vérifier la cohérence avec HomeComponent et autres pages

- [ ] **Task 9: Add Optional Stepper/Progress Indicator** (AC: 9, optionnel)
  - [ ] Créer un indicateur de progression si souhaité (ex: étapes 1/6)
  - [ ] Permettre la navigation entre sections si nécessaire
  - [ ] Marquer les sections complétées

- [ ] **Task 10: Implement "Reset" Functionality** (AC: 11, optionnel)
  - [ ] Ajouter un bouton "Réinitialiser" (en haut ou bas de page)
  - [ ] Implémenter resetConfiguration() pour remettre les valeurs par défaut
  - [ ] Confirmer avant réinitialisation (dialog ou confirmation)

- [ ] **Task 11: Integrate All Previous Stories** (AC: 1)
  - [ ] Intégrer Story 2.3 (Grade Selection) dans le layout
  - [ ] Intégrer Story 2.4 (Time Configuration) dans le layout
  - [ ] Intégrer Story 2.5 (Voice Selection) dans le layout
  - [ ] Intégrer Story 2.6 (Position Filters) dans le layout
  - [ ] Intégrer Story 2.7 (Attack/Technique Filters) dans le layout
  - [ ] Intégrer Story 2.8 (Weapons/Randori) dans le layout
  - [ ] S'assurer que toutes les sections fonctionnent ensemble

- [ ] **Task 12: Handle Navigation to Passage Page** (AC: 4)
  - [ ] Utiliser Angular Router pour naviguer vers `/passage`
  - [ ] Passer la configuration via:
    - Route state (routerState)
    - Service (PassageService ou ConfigService)
    - Query parameters (si nécessaire)
  - [ ] S'assurer que PassageComponent peut récupérer la configuration

- [ ] **Task 13: Add Loading State for Generation** (AC: 4)
  - [ ] Afficher un indicateur de chargement pendant la génération
  - [ ] Désactiver le bouton "Générer" pendant la génération
  - [ ] Gérer les erreurs de génération si elles se produisent

- [ ] **Task 14: Add Accessibility Features** (AC: 7, 10)
  - [ ] Assurer la navigation au clavier entre les sections
  - [ ] Ajouter des landmarks ARIA appropriés
  - [ ] S'assurer que tous les contrôles sont accessibles
  - [ ] Tester avec un lecteur d'écran

- [ ] **Task 15: Create Unit Tests** (AC: 1-12)
  - [ ] Tester l'intégration de toutes les sections
  - [ ] Tester la validation complète
  - [ ] Tester l'affichage des erreurs
  - [ ] Tester le bouton "Générer le passage"
  - [ ] Tester la navigation vers /passage
  - [ ] Tester le responsive design (si possible)
  - [ ] Tester la fonctionnalité de reset (si implémentée)

---

## Dev Notes

### Previous Story Insights

**Source:** Story 2.3 - Grade Selection Interface
- Section de sélection de grade avec selectedGrade

**Source:** Story 2.4 - Time Configuration Controls
- Contrôles timeBetweenTechniques et totalDuration

**Source:** Story 2.5 - Voice Selection Interface
- Sélection de voix avec SettingsService

**Source:** Story 2.6 - Position Filtering Interface
- Filtres de position avec selectedPositions

**Source:** Story 2.7 - Attack and Technique Filtering Interface
- Filtres avancés avec selectedAttacks et selectedTechniques

**Source:** Story 2.8 - Weapons and Randori Configuration
- Options includeWeapons, includeRandori, randoriTime

**Source:** Story 1.4 - Core Services Structure
- PassageService a une méthode generatePassage() (structure de base)
- PassageFilters interface est définie

### Technical Context

**Source:** [architecture/components.md](../../architecture/components.md)

**ConfigComponent:**
- **Location:** `src/app/pages/config/config.ts` et `config.html`
- **Responsibility:** Page de configuration complète avant génération du passage

**PassageService:**
- **Location:** `src/app/services/passage.service.ts`
- **Method:** `generatePassage(grade: string, filters: PassageFilters, config: PassageConfig): Passage`
- **Note:** L'implémentation complète sera dans Epic 3, mais la structure de base existe

**PassageFilters Interface:**
```typescript
interface PassageFilters {
  positions: Position[];
  attacks: string[];  // Vide = toutes
  techniques: string[];  // Vide = toutes
  includeWeapons: boolean;
  includeRandori: boolean;
}
```

**PassageConfig (à créer ou utiliser Passage model properties):**
```typescript
interface PassageConfig {
  grade: string;
  timeBetweenTechniques: number;  // secondes
  totalDuration: number;  // minutes
  voice: 'masculin' | 'féminin';
  randoriTime?: number;  // secondes, si includeRandori
}
```

**Routing:**
- Route `/config` existe (Story 1.2)
- Route `/passage` existe (Story 1.2)
- Router Angular disponible

**UI/UX Considerations:**
- Organiser les sections de manière logique (du général au spécifique)
- Utiliser des cards ou sections visuellement distinctes
- Bouton "Générer" bien visible et accessible
- Messages d'erreur clairs et actionnables

**Layout Structure:**
```
Config Page
├── Header/Title
├── Grade Selection (Story 2.3)
├── Time Configuration (Story 2.4)
├── Voice Selection (Story 2.5)
├── Position Filters (Story 2.6)
├── Advanced Filters - Attacks/Techniques (Story 2.7)
├── Advanced Options - Weapons/Randori (Story 2.8)
├── Error Messages (if any)
└── Action Buttons (Generate, Reset)
```

### Implementation Details

**Component Structure:**
```typescript
export class ConfigComponent {
  // Configuration values (from previous stories)
  selectedGrade: string = '6e Kyū';
  timeBetweenTechniques: number = 5;
  totalDuration: number = 10;
  selectedVoice: 'masculin' | 'féminin' = 'masculin';
  selectedPositions: Position[] = [];
  selectedAttacks: string[] = [];
  selectedTechniques: string[] = [];
  includeWeapons: boolean = false;
  includeRandori: boolean = false;
  randoriTime: number = 10;

  validationErrors: string[] = [];
  isGenerating: boolean = false;

  constructor(
    private gradeService: GradeService,
    private passageService: PassageService,
    private router: Router,
    private settingsService: SettingsService
  ) {}

  validateConfiguration(): { valid: boolean, errors: string[] } {
    const errors: string[] = [];

    // Grade validation
    if (!this.selectedGrade || !this.gradeService.validateGrade(this.selectedGrade)) {
      errors.push('Veuillez sélectionner un grade valide.');
    }

    // Position validation
    if (this.selectedPositions.length === 0) {
      errors.push('Veuillez sélectionner au moins une position.');
    }

    // Time validation
    if (this.timeBetweenTechniques < 3 || this.timeBetweenTechniques > 30) {
      errors.push('Le temps entre techniques doit être entre 3 et 30 secondes.');
    }

    if (this.totalDuration < 5 || this.totalDuration > 60) {
      errors.push('La durée totale doit être entre 5 et 60 minutes.');
    }

    // Randori time validation
    if (this.includeRandori && (this.randoriTime < 3 || this.randoriTime > 60)) {
      errors.push('Le temps Randori doit être entre 3 et 60 secondes.');
    }

    return {
      valid: errors.length === 0,
      errors
    };
  }

  async onGeneratePassage() {
    // Validate configuration
    const validation = this.validateConfiguration();
    if (!validation.valid) {
      this.validationErrors = validation.errors;
      // Scroll to top to show errors
      window.scrollTo({ top: 0, behavior: 'smooth' });
      return;
    }

    this.isGenerating = true;
    this.validationErrors = [];

    try {
      // Build PassageFilters
      const filters: PassageFilters = {
        positions: this.selectedPositions,
        attacks: this.selectedAttacks.length > 0 ? this.selectedAttacks : [],
        techniques: this.selectedTechniques.length > 0 ? this.selectedTechniques : [],
        includeWeapons: this.includeWeapons,
        includeRandori: this.includeRandori
      };

      // Build PassageConfig
      const config: PassageConfig = {
        grade: this.selectedGrade,
        timeBetweenTechniques: this.timeBetweenTechniques,
        totalDuration: this.totalDuration,
        voice: this.selectedVoice,
        randoriTime: this.includeRandori ? this.randoriTime : undefined
      };

      // Generate passage (structure de base - implémentation complète dans Epic 3)
      const passage = this.passageService.generatePassage(
        config.grade,
        filters,
        config
      );

      // Navigate to passage page
      this.router.navigate(['/passage'], {
        state: { passage, config, filters }
      });
    } catch (error) {
      console.error('Error generating passage:', error);
      this.validationErrors = ['Une erreur est survenue lors de la génération du passage.'];
    } finally {
      this.isGenerating = false;
    }
  }

  resetConfiguration() {
    // Reset all values to defaults
    this.selectedGrade = '6e Kyū';
    this.timeBetweenTechniques = 5;
    this.totalDuration = 10;
    this.selectedVoice = 'masculin';
    this.selectedPositions = [];
    this.selectedAttacks = [];
    this.selectedTechniques = [];
    this.includeWeapons = false;
    this.includeRandori = false;
    this.randoriTime = 10;
    this.validationErrors = [];
    // Trigger updates for dependent sections
    this.updatePositionsForGrade(this.selectedGrade);
  }
}
```

**Template Structure:**
```html
<div class="config-page">
  <header class="page-header">
    <h1>Configuration du passage</h1>
    <button *ngIf="hasCustomizations()" (click)="resetConfiguration()" class="reset-button">
      Réinitialiser
    </button>
  </header>

  <!-- Error Messages -->
  <div *ngIf="validationErrors.length > 0" class="error-alert">
    <h3>Erreurs de configuration</h3>
    <ul>
      <li *ngFor="let error of validationErrors">{{ error }}</li>
    </ul>
    <button (click)="validationErrors = []">Fermer</button>
  </div>

  <!-- Grade Selection (Story 2.3) -->
  <section class="config-section">
    <!-- ... Grade selection content ... -->
  </section>

  <!-- Time Configuration (Story 2.4) -->
  <section class="config-section">
    <!-- ... Time configuration content ... -->
  </section>

  <!-- Voice Selection (Story 2.5) -->
  <section class="config-section">
    <!-- ... Voice selection content ... -->
  </section>

  <!-- Position Filters (Story 2.6) -->
  <section class="config-section">
    <!-- ... Position filters content ... -->
  </section>

  <!-- Advanced Filters (Story 2.7) -->
  <section class="config-section">
    <!-- ... Advanced filters content ... -->
  </section>

  <!-- Advanced Options (Story 2.8) -->
  <section class="config-section">
    <!-- ... Advanced options content ... -->
  </section>

  <!-- Action Buttons -->
  <footer class="config-actions">
    <button 
      class="generate-button primary"
      (click)="onGeneratePassage()"
      [disabled]="isGenerating">
      <span *ngIf="!isGenerating">Générer le passage</span>
      <span *ngIf="isGenerating">Génération en cours...</span>
    </button>
  </footer>
</div>
```

**Styling:**
- Utiliser CSS Grid ou Flexbox pour le layout
- Sections avec cards ou background distinct
- Bouton "Générer" avec style primary (grand, visible)
- Messages d'erreur avec style alert (rouge, icône)
- Responsive avec media queries
- Utiliser les variables CSS du thème partout

---

## Dependencies

- ✅ Toutes les stories 2.1-2.8 complétées
- ✅ PassageService existe (structure de base)
- ✅ Router Angular configuré
- ✅ Routes /config et /passage existent

---

## Testing Checklist

- [ ] Test: Toutes les sections sont intégrées et affichées
- [ ] Test: Layout est organisé et logique
- [ ] Test: Validation fonctionne (tous les cas)
- [ ] Test: Messages d'erreur s'affichent correctement
- [ ] Test: Bouton "Générer" fonctionne
- [ ] Test: Navigation vers /passage fonctionne
- [ ] Test: Configuration est passée correctement
- [ ] Test: Responsive design fonctionne (mobile/tablette/desktop)
- [ ] Test: Design est cohérent avec le reste de l'app
- [ ] Test: Reset fonctionne (si implémenté)
- [ ] Test: Loading state fonctionne
- [ ] Test: Accessibilité (navigation clavier, landmarks)

---

## Definition of Done

- ✅ Tous les Acceptance Criteria sont remplis
- ✅ Code compile sans erreurs
- ✅ Tests unitaires passent (couverture minimale 70%)
- ✅ Toutes les sections sont intégrées et fonctionnent ensemble
- ✅ Validation complète fonctionne
- ✅ Navigation vers /passage fonctionne
- ✅ Interface responsive
- ✅ Design cohérent avec le thème
- ✅ Accessibilité de base respectée
- ✅ Code review effectué
- ✅ Documentation du code (JSDoc) ajoutée

---

## Notes

**Important:** L'implémentation complète de PassageService.generatePassage() sera dans Epic 3. Pour cette story, on utilise la structure de base et on prépare la configuration pour la génération future.
