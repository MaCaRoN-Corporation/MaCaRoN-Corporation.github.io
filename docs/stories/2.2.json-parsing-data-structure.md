# Story 2.2: JSON Parsing and Data Structure

**Status:** Pending  
**Epic:** 2 - Data Management & Configuration  
**Story Number:** 2.2

---

## Story

**As a** developer,  
**I want** to parser et structurer les données JSON chargées,  
**so that** je peux accéder facilement aux grades, positions, attaques et techniques.

---

## Acceptance Criteria

1. Le `GradeService` parse correctement le fichier `nomenclature.json` et crée une structure de données TypeScript typée
2. La structure de données représente correctement la hiérarchie : Grade → Position → Attaque → Technique[]
3. Le service parse correctement le fichier `videos.json` avec la structure "attaque-technique" → string[] (liste d'URLs)
4. Des méthodes helper sont créées pour accéder aux données par grade, position, attaque, technique
5. Le service peut filtrer les données selon différents critères (grade, position, etc.)
6. La validation des données JSON est effectuée (structure attendue, types corrects, valeurs non null)
7. Les erreurs de parsing sont gérées et rapportées clairement
8. Des méthodes utilitaires sont créées pour obtenir la liste des grades, positions, attaques disponibles
9. Les données sont typées correctement avec les interfaces TypeScript existantes
10. Le service peut vérifier si une technique existe pour un grade/position/attaque donné

---

## Tasks / Subtasks

- [ ] **Task 1: Validate Nomenclature Structure** (AC: 1, 6, 9)
  - [ ] Vérifier que nomenclature.json a la structure attendue (Grade → Position → Attack → Techniques[])
  - [ ] Valider que tous les grades ont au moins une position
  - [ ] Valider que toutes les positions ont au moins une attaque
  - [ ] Valider que toutes les attaques ont au moins une technique
  - [ ] Gérer les cas d'erreur (structure invalide, données manquantes)

- [ ] **Task 2: Validate Videos Structure** (AC: 3, 6, 9)
  - [ ] Vérifier que videos.json a la structure attendue ("attaque-technique": string[])
  - [ ] Valider que les valeurs sont des tableaux de strings (URLs)
  - [ ] Valider que les clés correspondent au format "Attaque-Technique"
  - [ ] Gérer les cas où certaines techniques n'ont pas de vidéos (optionnel)

- [ ] **Task 3: Implement getGrades() Method** (AC: 8)
  - [ ] Créer méthode qui retourne la liste de tous les grades disponibles
  - [ ] Retourner un tableau de strings trié si nécessaire
  - [ ] Utiliser les données de nomenclature pour extraire les grades

- [ ] **Task 4: Implement getPositionsForGrade() Method** (AC: 4, 5, 8)
  - [ ] Créer méthode qui retourne les positions disponibles pour un grade donné
  - [ ] Retourner Position[] (type défini dans position.model.ts)
  - [ ] Gérer le cas où le grade n'existe pas
  - [ ] Exclure "Randori" de la liste (car c'est une annonce audio, pas une position)

- [ ] **Task 5: Implement getAttacksForGradeAndPosition() Method** (AC: 4, 5)
  - [ ] Créer méthode qui retourne les attaques pour un grade et une position donnés
  - [ ] Retourner string[]
  - [ ] Gérer les cas d'erreur (grade/position invalides)

- [ ] **Task 6: Implement getTechniquesForGradePositionAttack() Method** (AC: 4, 5, 10)
  - [ ] Créer méthode qui retourne les techniques pour grade/position/attaque
  - [ ] Retourner string[]
  - [ ] Filtrer "Jiyu Waza" si nécessaire (selon les besoins métier)
  - [ ] Gérer les cas d'erreur

- [ ] **Task 7: Implement getVideoUrls() Method** (AC: 3, 4)
  - [ ] Créer méthode qui retourne les URLs vidéo pour une attaque-technique
  - [ ] Format clé: "Attaque-Technique" (ex: "Shomen Uchi-Ikkyo")
  - [ ] Retourner string[] | null (liste d'URLs ou null si pas de vidéo)
  - [ ] Utiliser les données de videos.json parsées

- [ ] **Task 8: Implement validateGrade() Method** (AC: 10)
  - [ ] Vérifier si un grade existe dans la nomenclature
  - [ ] Retourner boolean
  - [ ] Utiliser les données chargées pour la validation

- [ ] **Task 9: Implement Filtering Methods** (AC: 5)
  - [ ] Créer méthode pour filtrer par position
  - [ ] Créer méthode pour filtrer par attaque
  - [ ] Créer méthode pour filtrer par technique
  - [ ] Créer méthode combinée qui applique plusieurs filtres à la fois

- [ ] **Task 10: Implement getWeaponPositions() Method** (AC: 4, 8)
  - [ ] Identifier les positions qui sont des armes (dans "Armes")
  - [ ] Créer méthode qui retourne les positions d'armes disponibles pour un grade
  - [ ] Vérifier les règles: armes à partir du 1er Dan (Tanto Dori, Jo Dori, Jo Nage), armes supplémentaires à partir du 3e Dan (Ken Taï Ken, Jo Taï Jo, Tachi Dori)
  - [ ] Retourner Position[] ou string[]

- [ ] **Task 11: Handle Jiyu Waza Special Case** (AC: 6)
  - [ ] Noter que "Jiyu Waza" est présent dans les listes de techniques pour les Dan
  - [ ] Décider si "Jiyu Waza" doit être inclus ou exclu dans les filtres (selon besoins)
  - [ ] Implémenter la logique appropriée

- [ ] **Task 12: Implement Error Handling for Parsing** (AC: 7)
  - [ ] Créer des messages d'erreur clairs pour chaque type d'erreur de parsing
  - [ ] Logger les erreurs avec console.error
  - [ ] Retourner des valeurs par défaut appropriées (tableaux vides, null, etc.)

- [ ] **Task 13: Create Unit Tests** (AC: 1-10)
  - [ ] Tester getGrades()
  - [ ] Tester getPositionsForGrade()
  - [ ] Tester getAttacksForGradeAndPosition()
  - [ ] Tester getTechniquesForGradePositionAttack()
  - [ ] Tester getVideoUrls()
  - [ ] Tester validateGrade()
  - [ ] Tester les méthodes de filtrage
  - [ ] Tester la gestion d'erreurs
  - [ ] Tester getWeaponPositions() avec différents grades

---

## Dev Notes

### Previous Story Insights

**Source:** Story 2.1 - JSON Data Loading Service

- Les données sont chargées via loadNomenclature() et loadVideos()
- Les données sont mises en cache dans des BehaviorSubjects
- Les données sont typées avec NomenclatureData et VideosData

### Technical Context

**Source:** [architecture/components.md](../../architecture/components.md)

**Nomenclature Structure:**
```typescript
NomenclatureData = {
  [grade: string]: {
    [position: string]: {
      [attack: string]: string[]; // Liste des techniques
    };
  };
}
```

**Videos Structure:**
```typescript
VideosData = {
  [key: string]: string[]; // "Attaque-Technique": ["url1", "url2", ...]
}
```

**Position Type:**
```typescript
type Position = 'Suwariwaza' | 'Hanmi Handachi' | 'Tashiwaza' | 'Armes';
// Note: 'Randori' a été retiré car c'est une annonce audio, pas une position
```

**Grades Available:**
- 6e Kyū, 5e Kyū, 4e Kyū, 3e Kyū, 2e Kyū, 1er Kyū
- 1er Dan, 2e Dan, 3e Dan, 4e Dan, 5e Dan

**Weapon Rules (from nomenclature.json):**
- **1er et 2e Dan:** Tanto Dori, Jo Dori, Jo Nage
- **3e, 4e, 5e Dan:** Tanto Dori, Jo Dori, Jo Nage, Ken Taï Ken (Jiyu Waza, pas de techniques), Jo Taï Jo (Jiyu Waza, pas de techniques), Tachi Dori

**Special Cases:**
- "Jiyu Waza" est ajouté à toutes les listes de techniques pour les grades Dan
- "Ken Taï Ken" et "Jo Taï Jo" ont des tableaux vides [] car ce sont du Jiyu Waza (pas de techniques spécifiques)

### Implementation Details

**Grade Order:**
Les grades doivent être accessibles dans l'ordre logique (6e Kyū → 5e Dan). Utiliser un tableau ordonné ou trier lors de l'extraction.

**Key Format for Videos:**
Les clés dans videos.json sont au format "Attaque-Technique" avec des espaces (ex: "Shomen Uchi-Ikkyo"). Assurer la correspondance exacte.

**Null Safety:**
Toutes les méthodes doivent gérer les cas où les données ne sont pas encore chargées ou sont null. Retourner des valeurs par défaut appropriées.

**Weapon Detection:**
Les armes sont dans la position "Armes". Identifier les sous-positions d'armes disponibles selon le grade.

---

## Dependencies

- ✅ Story 2.1 complétée (données JSON chargées)
- ✅ Models TypeScript définis
- ✅ Fichiers JSON avec structure correcte

---

## Testing Checklist

- [ ] Test: getGrades() retourne tous les grades dans l'ordre
- [ ] Test: getPositionsForGrade() retourne les positions correctes
- [ ] Test: getAttacksForGradeAndPosition() retourne les attaques correctes
- [ ] Test: getTechniquesForGradePositionAttack() retourne les techniques correctes
- [ ] Test: getVideoUrls() retourne les URLs ou null
- [ ] Test: validateGrade() fonctionne correctement
- [ ] Test: Filtrage par position fonctionne
- [ ] Test: Filtrage par attaque fonctionne
- [ ] Test: getWeaponPositions() selon le grade
- [ ] Test: Gestion d'erreurs (grade/position/attaque invalides)
- [ ] Test: "Jiyu Waza" est géré correctement
- [ ] Test: "Randori" n'apparaît pas dans les positions

---

## Definition of Done

- ✅ Tous les Acceptance Criteria sont remplis
- ✅ Code compile sans erreurs
- ✅ Tests unitaires passent (couverture minimale 80%)
- ✅ Toutes les méthodes helper sont implémentées et testées
- ✅ Validation des données fonctionne
- ✅ Gestion d'erreurs implémentée et testée
- ✅ Code review effectué
- ✅ Documentation du code (JSDoc) ajoutée
