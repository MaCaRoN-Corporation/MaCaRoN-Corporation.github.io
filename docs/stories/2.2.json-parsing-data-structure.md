# Story 2.2: JSON Parsing and Data Structure

**Status:** Done  
**Epic:** 2 - Data Management & Configuration  
**Story Number:** 2.2  
**Implementation Date:** 2025-01-10

---

## Story

**As a** developer,  
**I want** to parser et structurer les données JSON chargées,  
**so that** je peux accéder facilement aux grades, positions, attaques et techniques.

---

## Acceptance Criteria

1. Le `GradeService` parse correctement le fichier `nomenclature.json` et crée une structure de données TypeScript typée
2. La structure de données représente correctement la hiérarchie : Grade → Position → Attaque → Technique[]
3. Le service parse correctement le fichier `videos.json` avec la structure "attaque-technique" → string[] (liste d'URLs)
4. Des méthodes helper sont créées pour accéder aux données par grade, position, attaque, technique
5. Le service peut filtrer les données selon différents critères (grade, position, etc.)
6. La validation des données JSON est effectuée (structure attendue, types corrects, valeurs non null)
7. Les erreurs de parsing sont gérées et rapportées clairement
8. Des méthodes utilitaires sont créées pour obtenir la liste des grades, positions, attaques disponibles
9. Les données sont typées correctement avec les interfaces TypeScript existantes
10. Le service peut vérifier si une technique existe pour un grade/position/attaque donné

---

## Tasks / Subtasks

- [x] **Task 1: Validate Nomenclature Structure** (AC: 1, 6, 9)
  - [x] Vérifier que nomenclature.json a la structure attendue (Grade → Position → Attack → Techniques[])
  - [x] Valider que tous les grades ont au moins une position
  - [x] Valider que toutes les positions ont au moins une attaque
  - [x] Valider que toutes les attaques ont au moins une technique
  - [x] Gérer les cas d'erreur (structure invalide, données manquantes)

- [x] **Task 2: Validate Videos Structure** (AC: 3, 6, 9)
  - [x] Vérifier que videos.json a la structure attendue ("attaque-technique": string[])
  - [x] Valider que les valeurs sont des tableaux de strings (URLs)
  - [x] Valider que les clés correspondent au format "Attaque-Technique"
  - [x] Gérer les cas où certaines techniques n'ont pas de vidéos (optionnel)

- [x] **Task 3: Implement getGrades() Method** (AC: 8)
  - [x] Créer méthode qui retourne la liste de tous les grades disponibles
  - [x] Retourner un tableau de strings trié si nécessaire
  - [x] Utiliser les données de nomenclature pour extraire les grades

- [x] **Task 4: Implement getPositionsForGrade() Method** (AC: 4, 5, 8)
  - [x] Créer méthode qui retourne les positions disponibles pour un grade donné
  - [x] Retourner Position[] (type défini dans position.model.ts)
  - [x] Gérer le cas où le grade n'existe pas
  - [x] Exclure "Randori" de la liste (car c'est une annonce audio, pas une position)

- [x] **Task 5: Implement getAttacksForGradeAndPosition() Method** (AC: 4, 5)
  - [x] Créer méthode qui retourne les attaques pour un grade et une position donnés
  - [x] Retourner string[]
  - [x] Gérer les cas d'erreur (grade/position invalides)
  - [x] Gérer la structure complexe des armes (formats différents: direct ou avec attaques)

- [x] **Task 6: Implement getTechniquesForGradePositionAttack() Method** (AC: 4, 5, 10)
  - [x] Créer méthode qui retourne les techniques pour grade/position/attaque
  - [x] Retourner string[]
  - [x] Filtrer "Jiyu Waza" si nécessaire (selon les besoins métier - inclus pour l'instant)
  - [x] Gérer les cas d'erreur
  - [x] Gérer la structure complexe des armes

- [x] **Task 7: Implement getVideoUrls() Method** (AC: 3, 4)
  - [x] Créer méthode qui retourne les URLs vidéo pour une attaque-technique
  - [x] Format clé: "Attaque-Technique" (ex: "Shomen Uchi-Ikkyo")
  - [x] Retourner string[] | null (liste d'URLs ou null si pas de vidéo)
  - [x] Utiliser les données de videos.json parsées
  - [x] Gérer le format spécial des armes avec attaques (extraire la partie attaque réelle)

- [x] **Task 8: Implement validateGrade() Method** (AC: 10)
  - [x] Vérifier si un grade existe dans la nomenclature
  - [x] Retourner boolean
  - [x] Utiliser les données chargées pour la validation

- [x] **Task 9: Implement Filtering Methods** (AC: 5)
  - [x] Créer méthode pour filtrer par position (intégré dans getTechniquesForGrade)
  - [x] Créer méthode pour filtrer par attaque (intégré dans getTechniquesForGrade)
  - [x] Créer méthode pour filtrer par technique (intégré dans getTechniquesForGrade)
  - [x] Créer méthode combinée qui applique plusieurs filtres à la fois (getTechniquesForGrade)

- [x] **Task 10: Implement getWeaponPositions() Method** (AC: 4, 8)
  - [x] Identifier les positions qui sont des armes (dans "Armes")
  - [x] Créer méthode qui retourne les positions d'armes disponibles pour un grade
  - [x] Vérifier les règles: armes à partir du 1er Dan (Tanto Dori, Jo Dori, Jo Nage), armes supplémentaires à partir du 3e Dan (Ken Taï Ken, Jo Taï Jo, Tachi Dori)
  - [x] Retourner string[] (liste des armes disponibles)

- [x] **Task 11: Handle Jiyu Waza Special Case** (AC: 6)
  - [x] Noter que "Jiyu Waza" est présent dans les listes de techniques pour les Dan
  - [x] Décider si "Jiyu Waza" doit être inclus ou exclu dans les filtres (inclus pour l'instant)
  - [x] Implémenter la logique appropriée (commentaire ajouté pour référence future)

- [x] **Task 12: Implement Error Handling for Parsing** (AC: 7)
  - [x] Créer des messages d'erreur clairs pour chaque type d'erreur de parsing
  - [x] Logger les erreurs avec console.error (déjà géré dans loadNomenclature/loadVideos)
  - [x] Retourner des valeurs par défaut appropriées (tableaux vides, null, etc.)

- [x] **Task 13: Create Unit Tests** (AC: 1-10)
  - [x] Tester getGrades()
  - [x] Tester getPositionsForGrade()
  - [x] Tester getAttacksForGradeAndPosition()
  - [x] Tester getTechniquesForGradePositionAttack()
  - [x] Tester getVideoUrls()
  - [x] Tester validateGrade()
  - [x] Tester les méthodes de filtrage (via getTechniquesForGrade)
  - [x] Tester la gestion d'erreurs
  - [x] Tester getWeaponPositions() avec différents grades
  - [x] Tester hasTechnique()

---

## Dev Notes

### Previous Story Insights

**Source:** Story 2.1 - JSON Data Loading Service

- Les données sont chargées via loadNomenclature() et loadVideos()
- Les données sont mises en cache dans des BehaviorSubjects
- Les données sont typées avec NomenclatureData et VideosData

### Technical Context

**Source:** [architecture/components.md](../../architecture/components.md)

**Nomenclature Structure:**
```typescript
NomenclatureData = {
  [grade: string]: {
    [position: string]: {
      [attack: string]: string[]; // Liste des techniques
    };
  };
}
```

**Videos Structure:**
```typescript
VideosData = {
  [key: string]: string[]; // "Attaque-Technique": ["url1", "url2", ...]
}
```

**Position Type:**
```typescript
type Position = 'Suwariwaza' | 'Hanmi Handachi' | 'Tashiwaza' | 'Armes';
// Note: 'Randori' a été retiré car c'est une annonce audio, pas une position
```

**Grades Available:**
- 6e Kyū, 5e Kyū, 4e Kyū, 3e Kyū, 2e Kyū, 1er Kyū
- 1er Dan, 2e Dan, 3e Dan, 4e Dan, 5e Dan

**Weapon Rules (from nomenclature.json):**
- **1er et 2e Dan:** Tanto Dori, Jo Dori, Jo Nage
- **3e, 4e, 5e Dan:** Tanto Dori, Jo Dori, Jo Nage, Ken Taï Ken (Jiyu Waza, pas de techniques), Jo Taï Jo (Jiyu Waza, pas de techniques), Tachi Dori

**Special Cases:**
- "Jiyu Waza" est ajouté à toutes les listes de techniques pour les grades Dan
- "Ken Taï Ken" et "Jo Taï Jo" ont des tableaux vides [] car ce sont du Jiyu Waza (pas de techniques spécifiques)

### Implementation Details

**Grade Order:**
Les grades doivent être accessibles dans l'ordre logique (6e Kyū → 5e Dan). Utiliser un tableau ordonné ou trier lors de l'extraction.

**Key Format for Videos:**
Les clés dans videos.json sont au format "Attaque-Technique" avec des espaces (ex: "Shomen Uchi-Ikkyo"). Assurer la correspondance exacte.

**Null Safety:**
Toutes les méthodes doivent gérer les cas où les données ne sont pas encore chargées ou sont null. Retourner des valeurs par défaut appropriées.

**Weapon Detection:**
Les armes sont dans la position "Armes". Identifier les sous-positions d'armes disponibles selon le grade.

---

## Dependencies

- ✅ Story 2.1 complétée (données JSON chargées)
- ✅ Models TypeScript définis
- ✅ Fichiers JSON avec structure correcte

---

## Testing Checklist

- [x] Test: getGrades() retourne tous les grades dans l'ordre
- [x] Test: getPositionsForGrade() retourne les positions correctes
- [x] Test: getAttacksForGradeAndPosition() retourne les attaques correctes
- [x] Test: getTechniquesForGradePositionAttack() retourne les techniques correctes
- [x] Test: getVideoUrls() retourne les URLs ou null
- [x] Test: validateGrade() fonctionne correctement
- [x] Test: Filtrage par position fonctionne (via getTechniquesForGrade)
- [x] Test: Filtrage par attaque fonctionne (via getTechniquesForGrade)
- [x] Test: getWeaponPositions() selon le grade
- [x] Test: Gestion d'erreurs (grade/position/attaque invalides)
- [x] Test: "Jiyu Waza" est géré correctement (inclus par défaut)
- [x] Test: "Randori" n'apparaît pas dans les positions (filtré dans getPositionsForGrade)
- [x] Test: hasTechnique() fonctionne correctement

---

## Definition of Done

- ✅ Tous les Acceptance Criteria sont remplis
- ✅ Code compile sans erreurs
- ✅ Tests unitaires passent (couverture minimale 80%)
- ✅ Toutes les méthodes helper sont implémentées et testées
- ✅ Validation des données fonctionne
- ✅ Gestion d'erreurs implémentée et testée
- ✅ Code review effectué
- ✅ Documentation du code (JSDoc) ajoutée

---

## QA Review

**QA Date:** 2025-01-10  
**QA Agent:** Auto (QA Agent)  
**Status:** ✅ **APPROVED - PASS**

### Gate Status

**Gate: PASS** → `docs/qa/gates/2.2-json-parsing-data-structure.yml`

**Quality Score:** 96/100

**Trace des critères d'acceptation:**
- ✅ AC1: Parsing nomenclature.json correct avec structure TypeScript typée (NomenclatureData)
- ✅ AC2: Hiérarchie correctement représentée (Grade → Position → Attaque → Technique[])
- ✅ AC3: Parsing videos.json correct avec format "attaque-technique" → string[]
- ✅ AC4: 9 méthodes helper créées pour accès aux données (getGrades, validateGrade, getPositionsForGrade, getAttacksForGradeAndPosition, getTechniquesForGradePositionAttack, getVideoUrls, getWeaponPositions, hasTechnique, plus getTechniquesForGrade)
- ✅ AC5: Filtrage complet implémenté dans getTechniquesForGrade (positions, attaques, techniques, armes)
- ✅ AC6: Validation des données à chaque niveau (grade, position, attaque, structure)
- ✅ AC7: Gestion d'erreurs robuste avec valeurs par défaut appropriées (tableaux vides, null)
- ✅ AC8: Méthodes utilitaires pour grades, positions, attaques disponibles
- ✅ AC9: Données typées correctement avec interfaces TypeScript (NomenclatureData, VideosData, Position, Technique, PassageFilters)
- ✅ AC10: Méthode hasTechnique() pour vérifier existence d'une technique

**Observations techniques:**
- Gestion correcte de la structure complexe des armes (formats direct et avec attaques intermédiaires)
- Extraction correcte de l'attaque pour videos.json (format "arme-attaque" → "attaque")
- Tri des grades dans l'ordre logique (6e Kyū → 5e Dan)
- Null safety complète pour données non chargées
- Filtrage combiné performant avec ordre de techniques numéroté
- Tests unitaires complets (14+ tests) couvrant tous les scénarios
- Build production réussi sans erreurs
- Documentation JSDoc complète pour toutes les méthodes publiques

### Recommended Status

✅ **Ready for Done**

Tous les critères sont remplis. La story peut être marquée comme "Done". L'implémentation est complète et de haute qualité, avec une gestion sophistiquée de la structure hiérarchique et des cas spéciaux (armes, Jiyu Waza), prête pour les stories suivantes.
