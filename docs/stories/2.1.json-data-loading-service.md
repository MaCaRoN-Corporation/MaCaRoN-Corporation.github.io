# Story 2.1: JSON Data Loading Service

**Status:** Pending  
**Epic:** 2 - Data Management & Configuration  
**Story Number:** 2.1

---

## Story

**As a** developer,  
**I want** to charger les fichiers JSON (nomenclature.json et videos.json) depuis les assets,  
**so that** l'application peut accéder aux données des grades et des vidéos.

---

## Acceptance Criteria

1. Le `GradeService` implémente `loadNomenclature()` pour charger `nomenclature.json` depuis `src/assets/data/`
2. Le service implémente `loadVideos()` pour charger `videos.json` depuis `src/assets/data/`
3. Le chargement utilise HttpClient Angular de manière asynchrone avec Observable
4. Les fichiers JSON sont chargés une seule fois au démarrage de l'application (singleton pattern, cache)
5. Les données chargées sont mises en cache dans le service via BehaviorSubjects
6. Les erreurs de chargement sont gérées gracieusement avec des messages d'erreur appropriés (catchError)
7. Un état de chargement (loading) est exposé via un Observable pour afficher un indicateur
8. Le service expose des observables RxJS (nomenclature$, videos$) pour notifier lorsque les données sont prêtes
9. Le chargement est déclenché automatiquement au premier appel (lazy loading)
10. Les méthodes retournent des Observables typés (Observable<NomenclatureData>, Observable<VideosData>)

---

## Tasks / Subtasks

- [ ] **Task 1: Implement loadNomenclature() Method** (AC: 1, 3, 4, 5, 8, 10)
  - [ ] Utiliser HttpClient.get() pour charger `assets/data/nomenclature.json`
  - [ ] Retourner Observable<NomenclatureData>
  - [ ] Implémenter cache avec BehaviorSubject (ne charger qu'une fois)
  - [ ] Mettre à jour nomenclature$ BehaviorSubject avec les données chargées
  - [ ] Retourner le BehaviorSubject.asObservable() après chargement initial

- [ ] **Task 2: Implement loadVideos() Method** (AC: 2, 3, 4, 5, 8, 10)
  - [ ] Utiliser HttpClient.get() pour charger `assets/data/videos.json`
  - [ ] Retourner Observable<VideosData>
  - [ ] Implémenter cache avec BehaviorSubject (ne charger qu'une fois)
  - [ ] Mettre à jour videos$ BehaviorSubject avec les données chargées
  - [ ] Retourner le BehaviorSubject.asObservable() après chargement initial
  - [ ] Note: videos.json contient maintenant des listes d'URLs (string[]) par technique

- [ ] **Task 3: Implement Error Handling** (AC: 6)
  - [ ] Utiliser catchError de RxJS pour gérer les erreurs HTTP
  - [ ] Logger les erreurs avec console.error
  - [ ] Retourner un Observable avec une valeur par défaut ou une erreur claire
  - [ ] Gérer les cas: 404, réseau, parsing JSON invalide

- [ ] **Task 4: Implement Loading State** (AC: 7)
  - [ ] Créer un BehaviorSubject<boolean> pour l'état de chargement
  - [ ] Exposer un Observable<boolean> pour l'état loading
  - [ ] Mettre à jour l'état lors du début et de la fin du chargement
  - [ ] Gérer l'état séparément pour nomenclature et videos (ou combiné)

- [ ] **Task 5: Initialize Data Loading** (AC: 4)
  - [ ] Créer une méthode `initialize()` privée ou publique pour déclencher le chargement
  - [ ] Appeler cette méthode dans le constructeur OU au premier appel des méthodes load
  - [ ] S'assurer que le chargement ne se fait qu'une seule fois (singleton pattern)

- [ ] **Task 6: Update Service Structure** (AC: 5, 8)
  - [ ] Vérifier que les BehaviorSubjects sont correctement initialisés
  - [ ] Exposer les observables via getters ou méthodes publiques si nécessaire
  - [ ] S'assurer que les types sont corrects (NomenclatureData | null, VideosData | null)

- [ ] **Task 7: Create Unit Tests** (AC: 1-10)
  - [ ] Créer des tests pour loadNomenclature() avec HttpClient mock
  - [ ] Créer des tests pour loadVideos() avec HttpClient mock
  - [ ] Tester le cache (vérifier qu'un seul appel HTTP est fait)
  - [ ] Tester la gestion d'erreurs (404, réseau, JSON invalide)
  - [ ] Tester l'état de chargement (loading state)
  - [ ] Tester que les Observables retournent les bonnes données

---

## Dev Notes

### Previous Story Insights

**Source:** Story 1.4 - Core Services Structure

- GradeService est créé avec structure de base
- BehaviorSubjects nomenclature$ et videos$ sont déjà déclarés
- HttpClient est injecté dans le constructeur
- Les méthodes loadNomenclature() et loadVideos() existent mais retournent des Observables vides

### Technical Context

**Source:** [architecture/components.md](../../architecture/components.md)

**GradeService:**
- **Responsibility:** Chargement et parsing des fichiers JSON (nomenclature.json, videos.json)
- **Dependencies:** HttpClient Angular pour charger les fichiers JSON
- **Technology Stack:** Angular Service, RxJS Observables, BehaviorSubject, TypeScript

**File Paths:**
- `src/assets/data/nomenclature.json` - Structure: Grade → Position → Attack → Techniques[]
- `src/assets/data/videos.json` - Structure: "Attaque-Technique": string[] (liste d'URLs)

**Models:**
- `NomenclatureData`: Interface définie dans `src/app/models/nomenclature.model.ts`
- `VideosData`: Interface définie dans `src/app/models/videos.model.ts` (structure: `[key: string]: string[]`)

**HttpClient Configuration:**
- HttpClient est configuré dans `app.config.ts` avec `provideHttpClient()`
- Les fichiers JSON sont dans `assets/` et seront servis statiquement

### Implementation Details

**Singleton Pattern:**
- Utiliser des flags privés pour vérifier si les données sont déjà chargées
- Ne faire l'appel HTTP qu'une seule fois
- Retourner le BehaviorSubject existant si déjà chargé

**Error Handling:**
```typescript
catchError((error: HttpErrorResponse) => {
  console.error('Error loading nomenclature:', error);
  // Retourner un Observable avec une valeur par défaut ou throwError
  return throwError(() => new Error('Failed to load nomenclature data'));
})
```

**Loading State:**
```typescript
private loadingNomenclature$ = new BehaviorSubject<boolean>(false);
private loadingVideos$ = new BehaviorSubject<boolean>(false);

get isLoadingNomenclature$(): Observable<boolean> {
  return this.loadingNomenclature$.asObservable();
}
```

**Cache Pattern:**
```typescript
private nomenclatureCache: NomenclatureData | null = null;
private videosCache: VideosData | null = null;

loadNomenclature(): Observable<NomenclatureData> {
  if (this.nomenclatureCache) {
    return of(this.nomenclatureCache);
  }
  // Sinon, charger via HTTP et mettre en cache
}
```

---

## Dependencies

- ✅ HttpClient configuré dans app.config.ts
- ✅ Fichiers JSON existants (nomenclature.json, videos.json)
- ✅ Models TypeScript définis (NomenclatureData, VideosData)
- ✅ GradeService structure de base créée (Story 1.4)

---

## Testing Checklist

- [ ] Test: loadNomenclature() charge les données correctement
- [ ] Test: loadVideos() charge les données correctement
- [ ] Test: Les données sont mises en cache (un seul appel HTTP)
- [ ] Test: Gestion erreur 404
- [ ] Test: Gestion erreur réseau
- [ ] Test: Gestion JSON invalide
- [ ] Test: État de chargement correct (true → false)
- [ ] Test: Observables retournent les bonnes données typées
- [ ] Test: Retourne les données depuis le cache si déjà chargé

---

## Definition of Done

- ✅ Tous les Acceptance Criteria sont remplis
- ✅ Code compile sans erreurs
- ✅ Tests unitaires passent (couverture minimale 80%)
- ✅ Gestion d'erreurs implémentée et testée
- ✅ Cache fonctionne correctement (un seul appel HTTP)
- ✅ Loading state fonctionne
- ✅ Code review effectué
- ✅ Documentation du code (JSDoc) ajoutée
