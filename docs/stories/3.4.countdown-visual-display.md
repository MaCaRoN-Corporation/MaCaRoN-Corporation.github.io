# Story 3.4: Countdown Visual Display

**Status:** Draft  
**Epic:** 3 - Passage Generation & Core Execution  
**Story Number:** 3.4  

---

## Story

**As a** user,  
**I want** voir un compte à rebours visuel avant chaque technique,  
**so that** je peux me préparer à l'exécution de la prochaine technique.

---

## Acceptance Criteria

1. Un compte à rebours visuel est affiché avant l'annonce de chaque technique
2. Le compte à rebours utilise un cercle animé, une barre, ou un affichage numérique
3. Le compte à rebours démarre au temps configuré entre techniques et descend jusqu'à zéro
4. L'animation est fluide et visuellement claire
5. Le compte à rebours est bien visible et centré
6. Quand le compte à rebours atteint zéro, la prochaine technique est annoncée
7. Le compte à rebours utilise Angular Animations pour une animation fluide

---

## Tasks / Subtasks

- [ ] **Task 1: Create Countdown Display Component/Section** (AC: 1, 5)
  - [ ] Créer la section/composant pour le compte à rebours
  - [ ] Positionner le compte à rebours de manière visible et centrée
  - [ ] Intégrer dans PassageComponent template

- [ ] **Task 2: Implement Countdown Visual Element** (AC: 2, 4, 7)
  - [ ] Choisir le type d'affichage (cercle animé, barre, ou numérique)
  - [ ] Implémenter l'élément visuel (SVG pour cercle, div pour barre, texte pour numérique)
  - [ ] Utiliser Angular Animations pour l'animation fluide
  - [ ] Créer les animations avec @angular/animations

- [ ] **Task 3: Implement Countdown Logic** (AC: 3, 6)
  - [ ] Récupérer le temps entre techniques depuis PassageConfig (via ConfigService ou PassageService)
  - [ ] Démarrer le compte à rebours au temps configuré
  - [ ] Décrémenter le compte à rebours toutes les secondes
  - [ ] Gérer la transition vers la prochaine technique quand le compte atteint zéro
  - [ ] Intégrer avec PassageService pour déclencher nextTechnique()

- [ ] **Task 4: Integrate with PassageService** (AC: 6)
  - [ ] Écouter les changements de technique dans PassageService
  - [ ] Déclencher le compte à rebours avant chaque nouvelle technique
  - [ ] Appeler nextTechnique() quand le compte à rebours atteint zéro
  - [ ] Gérer la synchronisation avec l'état du passage

- [ ] **Task 5: Implement Angular Animations** (AC: 7, 4)
  - [ ] Définir les animations avec trigger(), state(), transition()
  - [ ] Animer la progression (cercle qui se remplit/vide, barre qui se remplit/vide)
  - [ ] Animation fluide et continue
  - [ ] Utiliser animate() avec easing approprié

- [ ] **Task 6: Handle Countdown States** (AC: 3, 6)
  - [ ] Gérer l'état initial (démarrer au temps configuré)
  - [ ] Gérer la décrémentation
  - [ ] Gérer l'état final (zéro) et transition
  - [ ] Gérer pause/resume si nécessaire

- [ ] **Task 7: Style Countdown Display** (AC: 2, 5)
  - [ ] Styles CSS pour le compte à rebours (visibilité, centrage)
  - [ ] Styles pour l'animation (couleurs, tailles)
  - [ ] Responsive design (mobile et desktop)
  - [ ] Utiliser les variables CSS du thème

- [ ] **Task 8: Create Unit Tests** (AC: 1-7)
  - [ ] Tester l'affichage du compte à rebours
  - [ ] Tester le démarrage au temps configuré
  - [ ] Tester la décrémentation
  - [ ] Tester la transition à zéro
  - [ ] Tester l'intégration avec PassageService
  - [ ] Tester les animations Angular

---

## Dev Notes

### Previous Story Insights

**Source:** Story 3.3 - Passage Page Layout and Timer
- PassageComponent layout en place
- PassageService intégré
- Structure de base pour affichage

**Source:** Epic 2 - Data Management & Configuration
- PassageConfig contient timeBetweenTechniques (temps entre techniques)
- ConfigService ou PassageService expose la configuration

### Technical Context

**Source:** [architecture/frontend-architecture.md](../../architecture/frontend-architecture.md)

**PassageComponent:**
- **Location:** `src/app/pages/passage/passage.ts`, `passage.html`, `passage.scss`
- **Dependencies:** PassageService, Angular Animations

**Angular Animations:**
- Utiliser @angular/animations (trigger, state, transition, animate)
- Importer BrowserAnimationsModule dans app config
- Définir animations dans @Component decorator

**Countdown Options:**
1. **Cercle animé (SVG):** Cercle qui se vide progressivement (stroke-dasharray)
2. **Barre de progression:** Barre horizontale qui se remplit/vide
3. **Affichage numérique:** Nombre qui décrémente (ex: "3, 2, 1, 0")

**Time Between Techniques:**
- Disponible dans PassageConfig.timeBetweenTechniques
- Temps en secondes (ex: 5 secondes par défaut)
- Utilisé pour la durée du compte à rebours

### Implementation Details

**Angular Animations Example:**
```typescript
import { trigger, state, style, transition, animate } from '@angular/animations';

@Component({
  animations: [
    trigger('countdown', [
      state('100', style({ width: '100%' })),
      state('0', style({ width: '0%' })),
      transition('100 => 0', animate('5s linear'))
    ])
  ]
})
```

**Countdown Logic:**
```typescript
startCountdown(duration: number): void {
  this.countdownValue = duration;
  const interval = setInterval(() => {
    this.countdownValue--;
    if (this.countdownValue <= 0) {
      clearInterval(interval);
      this.passageService.nextTechnique();
    }
  }, 1000);
}
```

**SVG Circle Countdown:**
```html
<svg class="countdown-circle">
  <circle 
    [style.stroke-dashoffset]="circleDashoffset"
    [style.stroke-dasharray]="circumference"
  />
</svg>
```

**Barre de progression:**
```html
<div class="countdown-bar">
  <div 
    class="countdown-progress"
    [style.width.%]="countdownPercent"
    [@countdown]="countdownState"
  ></div>
</div>
```

**Timing:**
- Déclencher le compte à rebours avant chaque technique
- Durée = PassageConfig.timeBetweenTechniques
- Quand le compte atteint zéro → nextTechnique()

---

## Dependencies

- ✅ Story 3.3 complétée (PassageComponent layout)
- ✅ Story 3.2 complétée (PassageService.nextTechnique())
- ✅ Epic 2 complétée (PassageConfig avec timeBetweenTechniques)
- ✅ Angular Animations module disponible
- ✅ PassageService intégré dans PassageComponent

---

## Testing Checklist

- [ ] Test: Compte à rebours affiché avant chaque technique
- [ ] Test: Type d'affichage choisi (cercle/barre/numérique) fonctionne
- [ ] Test: Démarre au temps configuré (timeBetweenTechniques)
- [ ] Test: Animation fluide et visuellement claire
- [ ] Test: Compte à rebours visible et centré
- [ ] Test: Transition vers prochaine technique à zéro
- [ ] Test: Angular Animations fonctionnent correctement
- [ ] Test: Intégration avec PassageService
- [ ] Test: Gestion pause/resume si nécessaire

---

## Definition of Done

- ✅ Tous les Acceptance Criteria sont remplis
- ✅ Code compile sans erreurs
- ✅ Tests unitaires passent (couverture minimale 70%)
- ✅ Compte à rebours visuel fonctionne
- ✅ Animation fluide avec Angular Animations
- ✅ Intégration avec PassageService fonctionne
- ✅ Transition vers prochaine technique fonctionne
- ✅ Code review effectué
- ✅ Documentation du code (JSDoc) ajoutée

---
