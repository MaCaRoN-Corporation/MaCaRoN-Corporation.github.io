# Story 2.7: Attack and Technique Filtering Interface

**Status:** Pending  
**Epic:** 2 - Data Management & Configuration  
**Story Number:** 2.7

---

## Story

**As a** user,  
**I want** to filtrer par type d'attaque ou technique spécifique,  
**so that** je peux créer des entraînements ultra-ciblés (ex: seulement Shomen Uchi).

---

## Acceptance Criteria

1. La page de configuration affiche une section "Filtres avancés" pour les attaques et techniques
2. Les attaques disponibles sont affichées selon le grade et les positions sélectionnées (via GradeService)
3. Les techniques disponibles sont affichées selon le grade, position et attaque sélectionnés
4. Les filtres utilisent des listes avec recherche ou sélection multiple (checkboxes/multi-select)
5. Les options de filtrage sont dynamiques selon le grade et positions sélectionnées
6. Les filtres permettent de sélectionner plusieurs attaques/techniques
7. Un indicateur montre combien d'attaques/techniques sont sélectionnées (ex: "3 attaques sélectionnées")
8. Les filtres sont sauvegardés dans le composant ConfigComponent
9. Par défaut, aucun filtre n'est appliqué (toutes les attaques/techniques disponibles)
10. L'interface est claire, organisée et responsive

---

## Tasks / Subtasks

- [ ] **Task 1: Create Advanced Filters Section** (AC: 1, 10)
  - [ ] Ajouter une section "Filtres avancés" dans le template ConfigComponent
  - [ ] Utiliser un titre clair (h2 ou h3)
  - [ ] Organiser en sous-sections: "Filtres d'attaques" et "Filtres de techniques"
  - [ ] Optionnel: utiliser un accordéon ou sections collapsibles pour économiser l'espace

- [ ] **Task 2: Implement Attack Filtering** (AC: 2, 5, 6, 8)
  - [ ] Utiliser GradeService.getAttacksForGradeAndPosition() pour obtenir les attaques
  - [ ] Agréger les attaques de toutes les positions sélectionnées (éviter les doublons)
  - [ ] Créer une liste de checkboxes pour les attaques disponibles
  - [ ] Stocker les attaques sélectionnées (selectedAttacks: string[])
  - [ ] Mettre à jour la liste des attaques lorsque le grade ou les positions changent

- [ ] **Task 3: Implement Technique Filtering** (AC: 3, 5, 6, 8)
  - [ ] Utiliser GradeService.getTechniquesForGradePositionAttack() pour obtenir les techniques
  - [ ] Agréger les techniques selon les positions et attaques sélectionnées
  - [ ] Créer une liste de checkboxes pour les techniques disponibles
  - [ ] Optionnel: grouper par attaque pour meilleure organisation
  - [ ] Stocker les techniques sélectionnées (selectedTechniques: string[])
  - [ ] Mettre à jour la liste des techniques lorsque grade/positions/attaques changent

- [ ] **Task 4: Implement Search/Filter Functionality** (AC: 4)
  - [ ] Ajouter un champ de recherche pour filtrer les attaques par nom
  - [ ] Ajouter un champ de recherche pour filtrer les techniques par nom
  - [ ] Implémenter la logique de filtrage en temps réel
  - [ ] Afficher uniquement les attaques/techniques correspondant à la recherche

- [ ] **Task 5: Implement Selection Indicators** (AC: 7)
  - [ ] Afficher le nombre d'attaques sélectionnées (ex: "3 attaques sélectionnées")
  - [ ] Afficher le nombre de techniques sélectionnées (ex: "12 techniques sélectionnées")
  - [ ] Mettre à jour les compteurs en temps réel
  - [ ] Afficher "Toutes" si aucun filtre n'est appliqué (par défaut)

- [ ] **Task 6: Handle Dynamic Updates** (AC: 5)
  - [ ] Écouter les changements du grade sélectionné
  - [ ] Écouter les changements des positions sélectionnées
  - [ ] Quand le grade/positions changent, récupérer les nouvelles attaques/techniques
  - [ ] Réinitialiser les sélections (optionnel: conserver si toujours valides)
  - [ ] Mettre à jour l'affichage

- [ ] **Task 7: Implement Default Behavior** (AC: 9)
  - [ ] Par défaut, aucun filtre d'attaque n'est appliqué (selectedAttacks vide = toutes)
  - [ ] Par défaut, aucun filtre de technique n'est appliqué (selectedTechniques vide = toutes)
  - [ ] Afficher "Toutes les attaques/techniques" par défaut
  - [ ] Appliquer les filtres seulement si des sélections sont faites

- [ ] **Task 8: Add "Select All / Clear All" Buttons** (AC: 6, 9)
  - [ ] Ajouter un bouton "Tout sélectionner" / "Tout désélectionner" pour les attaques
  - [ ] Ajouter un bouton "Tout sélectionner" / "Tout désélectionner" pour les techniques
  - [ ] Ajouter un bouton "Réinitialiser les filtres" pour tout effacer

- [ ] **Task 9: Implement Filter Logic Integration** (AC: 8)
  - [ ] Créer un objet PassageFilters avec les filtres sélectionnés
  - [ ] Inclure selectedPositions, selectedAttacks, selectedTechniques
  - [ ] Préparer pour utilisation dans la génération du passage (Story 2.9)

- [ ] **Task 10: Add Visual Organization** (AC: 10)
  - [ ] Grouper les techniques par attaque si possible (sections expandables)
  - [ ] Utiliser des séparateurs visuels pour clarifier les groupes
  - [ ] Style cohérent avec le reste de l'application
  - [ ] Utiliser les variables CSS du thème

- [ ] **Task 11: Implement Responsive Design** (AC: 10)
  - [ ] Adapter le layout pour mobile (sections empilées, recherche visible)
  - [ ] Adapter le layout pour desktop (sections côte à côte si espace)
  - [ ] Utiliser des accordéons ou sections collapsibles pour économiser l'espace mobile
  - [ ] Tester sur différentes tailles d'écran

- [ ] **Task 12: Handle Empty State** (AC: 5)
  - [ ] Afficher un message si aucune attaque/technique n'est disponible (grade/position invalide)
  - [ ] Gérer le cas où les données ne sont pas encore chargées (loading state)

- [ ] **Task 13: Add Accessibility Features** (AC: 10)
  - [ ] Ajouter des labels appropriés
  - [ ] Assurer la navigation au clavier
  - [ ] Ajouter aria-label ou aria-labelledby
  - [ ] Grouper les contrôles avec fieldset/legend si approprié
  - [ ] Tester avec un lecteur d'écran

- [ ] **Task 14: Filter Out "Jiyu Waza" if Needed** (AC: 3)
  - [ ] Décider si "Jiyu Waza" doit apparaître dans les filtres de techniques
  - [ ] Si non, filtrer "Jiyu Waza" de la liste des techniques disponibles
  - [ ] Implémenter la logique de filtrage

- [ ] **Task 15: Create Unit Tests** (AC: 1-10)
  - [ ] Tester l'affichage de la section
  - [ ] Tester le chargement des attaques selon grade/positions
  - [ ] Tester le chargement des techniques selon grade/position/attaque
  - [ ] Tester la recherche/filtrage
  - [ ] Tester la sélection multiple
  - [ ] Tester les compteurs de sélection
  - [ ] Tester les mises à jour dynamiques
  - [ ] Tester le comportement par défaut (aucun filtre)

---

## Dev Notes

### Previous Story Insights

**Source:** Story 2.2 - JSON Parsing and Data Structure
- GradeService.getAttacksForGradeAndPosition(grade, position) retourne string[]
- GradeService.getTechniquesForGradePositionAttack(grade, position, attack) retourne string[]
- "Jiyu Waza" est présent dans certaines listes de techniques pour les Dan

**Source:** Story 2.3 - Grade Selection Interface
- Le grade sélectionné est disponible dans ConfigComponent

**Source:** Story 2.6 - Position Filtering Interface
- Les positions sélectionnées sont disponibles dans ConfigComponent (selectedPositions)

### Technical Context

**Source:** [architecture/components.md](../../architecture/components.md)

**GradeService Methods:**
- `getAttacksForGradeAndPosition(grade: string, position: Position): string[]`
- `getTechniquesForGradePositionAttack(grade: string, position: Position, attack: string): string[]`

**PassageFilters Interface:**
```typescript
interface PassageFilters {
  positions: Position[];
  attacks: string[];  // Vide = toutes les attaques
  techniques: string[];  // Vide = toutes les techniques
  includeWeapons: boolean;
  includeRandori: boolean;
}
```

**ConfigComponent:**
- **Location:** `src/app/pages/config/config.ts` et `config.html`
- **Dependency:** GradeService pour obtenir attaques/techniques

**UI/UX Considerations:**
- Utiliser des sections collapsibles/accordéons pour économiser l'espace
- Champ de recherche pour faciliter la sélection dans de longues listes
- Grouper les techniques par attaque pour meilleure organisation
- Indicateurs visuels pour montrer ce qui est sélectionné

**Default Behavior:**
- Par défaut, aucun filtre (tableaux vides = toutes les attaques/techniques)
- Les filtres sont optionnels et permettent de restreindre la génération

**Special Cases:**
- "Jiyu Waza" peut être présent dans certaines listes de techniques
- Décider si "Jiyu Waza" doit être filtrable ou exclu automatiquement

### Implementation Details

**Component Structure:**
```typescript
export class ConfigComponent {
  // Attaques
  availableAttacks: string[] = [];
  selectedAttacks: string[] = [];
  attackSearchTerm: string = '';

  // Techniques
  availableTechniques: string[] = [];
  selectedTechniques: string[] = [];
  techniqueSearchTerm: string = '';

  get filteredAttacks(): string[] {
    if (!this.attackSearchTerm) return this.availableAttacks;
    return this.availableAttacks.filter(attack => 
      attack.toLowerCase().includes(this.attackSearchTerm.toLowerCase())
    );
  }

  get filteredTechniques(): string[] {
    if (!this.techniqueSearchTerm) return this.availableTechniques;
    return this.availableTechniques.filter(technique => 
      technique.toLowerCase().includes(this.techniqueSearchTerm.toLowerCase())
    );
  }

  get selectedAttacksCount(): number {
    return this.selectedAttacks.length;
  }

  get selectedTechniquesCount(): number {
    return this.selectedTechniques.length;
  }

  updateAttacksAndTechniques() {
    // Agréger les attaques de toutes les positions sélectionnées
    const allAttacks = new Set<string>();
    this.selectedPositions.forEach(position => {
      const attacks = this.gradeService.getAttacksForGradeAndPosition(
        this.selectedGrade, 
        position
      );
      attacks.forEach(attack => allAttacks.add(attack));
    });
    this.availableAttacks = Array.from(allAttacks).sort();

    // Agréger les techniques selon positions et attaques
    const allTechniques = new Set<string>();
    this.selectedPositions.forEach(position => {
      this.availableAttacks.forEach(attack => {
        const techniques = this.gradeService.getTechniquesForGradePositionAttack(
          this.selectedGrade,
          position,
          attack
        );
        techniques.forEach(technique => {
          // Filtrer "Jiyu Waza" si nécessaire
          if (technique !== 'Jiyu Waza') {
            allTechniques.add(technique);
          }
        });
      });
    });
    this.availableTechniques = Array.from(allTechniques).sort();
  }

  onGradeOrPositionChange() {
    // Réinitialiser les filtres ou les adapter
    this.updateAttacksAndTechniques();
    // Optionnel: réinitialiser selectedAttacks et selectedTechniques
  }

  clearAllFilters() {
    this.selectedAttacks = [];
    this.selectedTechniques = [];
  }
}
```

**Template Structure:**
```html
<section class="advanced-filters">
  <h2>Filtres avancés (optionnel)</h2>

  <!-- Filtres d'attaques -->
  <div class="filter-group">
    <h3>Filtres d'attaques</h3>
    <div class="filter-summary">
      {{ selectedAttacksCount > 0 ? selectedAttacksCount + ' attaque(s) sélectionnée(s)' : 'Toutes les attaques' }}
      <button (click)="clearAttackFilters()" *ngIf="selectedAttacksCount > 0">Réinitialiser</button>
    </div>
    <input 
      type="text" 
      placeholder="Rechercher une attaque..."
      [(ngModel)]="attackSearchTerm">
    <div class="attacks-list">
      <label *ngFor="let attack of filteredAttacks" class="attack-checkbox">
        <input 
          type="checkbox"
          [checked]="selectedAttacks.includes(attack)"
          (change)="onAttackToggle(attack)">
        <span>{{ attack }}</span>
      </label>
    </div>
  </div>

  <!-- Filtres de techniques -->
  <div class="filter-group">
    <h3>Filtres de techniques</h3>
    <div class="filter-summary">
      {{ selectedTechniquesCount > 0 ? selectedTechniquesCount + ' technique(s) sélectionnée(s)' : 'Toutes les techniques' }}
      <button (click)="clearTechniqueFilters()" *ngIf="selectedTechniquesCount > 0">Réinitialiser</button>
    </div>
    <input 
      type="text" 
      placeholder="Rechercher une technique..."
      [(ngModel)]="techniqueSearchTerm">
    <div class="techniques-list">
      <label *ngFor="let technique of filteredTechniques" class="technique-checkbox">
        <input 
          type="checkbox"
          [checked]="selectedTechniques.includes(technique)"
          (change)="onTechniqueToggle(technique)">
        <span>{{ technique }}</span>
      </label>
    </div>
  </div>
</section>
```

**Styling:**
- Utiliser les variables CSS du thème
- Style pour les listes de checkboxes (scrollable si longues)
- Style pour les champs de recherche
- Indicateurs de comptage (badges ou texte)
- Sections collapsibles si nécessaire
- Responsive avec media queries

---

## Dependencies

- ✅ Story 2.2 complétée (getAttacksForGradeAndPosition, getTechniquesForGradePositionAttack)
- ✅ Story 2.3 complétée (grade sélectionné)
- ✅ Story 2.6 complétée (positions sélectionnées)

---

## Testing Checklist

- [ ] Test: Section advanced filters s'affiche
- [ ] Test: Attaques sont chargées selon grade/positions
- [ ] Test: Techniques sont chargées selon grade/position/attaque
- [ ] Test: Recherche/filtrage fonctionne
- [ ] Test: Sélection multiple d'attaques fonctionne
- [ ] Test: Sélection multiple de techniques fonctionne
- [ ] Test: Compteurs de sélection fonctionnent
- [ ] Test: Mises à jour dynamiques lors du changement de grade/positions
- [ ] Test: Comportement par défaut (aucun filtre)
- [ ] Test: "Jiyu Waza" est filtré si nécessaire
- [ ] Test: Responsive design fonctionne
- [ ] Test: Accessibilité (navigation clavier, recherche)

---

## Definition of Done

- ✅ Tous les Acceptance Criteria sont remplis
- ✅ Code compile sans erreurs
- ✅ Tests unitaires passent (couverture minimale 70%)
- ✅ Intégration GradeService fonctionne
- ✅ Recherche/filtrage fonctionne
- ✅ Interface responsive
- ✅ Accessibilité de base respectée
- ✅ Code review effectué
- ✅ Documentation du code (JSDoc) ajoutée
