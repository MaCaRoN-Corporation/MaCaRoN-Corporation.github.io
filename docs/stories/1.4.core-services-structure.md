# Story 1.4: Core Services Structure

**Status:** Done  
**Epic:** 1 - Foundation & Project Setup  
**Story Number:** 1.4

---

## Story

**As a** developer,  
**I want** to créer la structure de base des services Angular,  
**so that** je peux commencer à implémenter la logique métier de manière organisée.

---

## Acceptance Criteria

1. Les services suivants sont créés (vides pour l'instant) : `GradeService`, `PassageService`, `AudioService`, `SettingsService`, `ExportService`
2. Chaque service est injectable et fourni au niveau approprié (root ou module)
3. RxJS est importé et configuré pour l'utilisation de BehaviorSubject
4. Les services sont organisés dans un dossier `src/app/services/`
5. Chaque service a une structure de base avec des méthodes vides documentées
6. Les services peuvent être injectés dans les composants sans erreur

---

## Tasks / Subtasks

- [x] **Task 1: Create Services Directory Structure** (AC: 4)
  - [x] Créer le dossier `src/app/services/` s'il n'existe pas
  - [x] Vérifier que la structure est conforme à l'architecture

- [x] **Task 2: Create GradeService** (AC: 1, 2, 3, 5, 6)
  - [x] Créer `grade.service.ts` dans `src/app/services/`
  - [x] Décorer avec `@Injectable({ providedIn: 'root' })`
  - [x] Importer `BehaviorSubject` et `Observable` de RxJS
  - [x] Créer la structure de base avec méthodes vides documentées :
    - `loadNomenclature(): Observable<NomenclatureData>`
    - `loadVideos(): Observable<VideosData>`
    - `getTechniquesForGrade(grade: string, filters: PassageFilters): Technique[]`
    - `validateGrade(grade: string): boolean`
  - [x] Ajouter un constructeur avec HttpClient injecté
  - [x] Vérifier que le service peut être injecté sans erreur

- [x] **Task 3: Create PassageService** (AC: 1, 2, 3, 5, 6)
  - [x] Créer `passage.service.ts` dans `src/app/services/`
  - [x] Décorer avec `@Injectable({ providedIn: 'root' })`
  - [x] Importer `BehaviorSubject` et `Observable` de RxJS
  - [x] Créer la structure de base avec méthodes vides documentées :
    - `generatePassage(grade: string, filters: PassageFilters, config: PassageConfig): Passage`
    - `startPassage(passage: Passage): void`
    - `pausePassage(): void`
    - `resumePassage(): void`
    - `getCurrentTechnique(): Technique | null`
    - `getPassageState(): Observable<PassageState>`
  - [x] Ajouter un constructeur avec BehaviorSubject initialisé
  - [x] Vérifier que le service peut être injecté sans erreur

- [x] **Task 4: Create AudioService** (AC: 1, 2, 3, 5, 6)
  - [x] Créer `audio.service.ts` dans `src/app/services/`
  - [x] Décorer avec `@Injectable({ providedIn: 'root' })`
  - [x] Importer `BehaviorSubject` et `Observable` de RxJS (préparé pour usage futur)
  - [x] Créer la structure de base avec méthodes vides documentées :
    - `playTechnique(technique: Technique, voice: 'masculin' | 'féminin'): Promise<void>`
    - `pauseAudio(): void`
    - `resumeAudio(): void`
    - `repeatLastTechnique(): void`
    - `useElevenlabs(apiKey: string): void`
  - [x] Ajouter un constructeur vide pour l'instant
  - [x] Vérifier que le service peut être injecté sans erreur

- [x] **Task 5: Create SettingsService** (AC: 1, 2, 3, 5, 6)
  - [x] Créer `settings.service.ts` dans `src/app/services/`
  - [x] Décorer avec `@Injectable({ providedIn: 'root' })`
  - [x] Importer `BehaviorSubject` et `Observable` de RxJS
  - [x] Créer la structure de base avec méthodes vides documentées :
    - `getSettings(): Observable<UserSettings>`
    - `updateSettings(settings: Partial<UserSettings>): void`
    - `resetSettings(): void`
    - `applyTheme(theme: 'clair' | 'sombre'): void`
  - [x] Ajouter un constructeur avec BehaviorSubject initialisé
  - [x] Vérifier que le service peut être injecté sans erreur

- [x] **Task 6: Create ExportService** (AC: 1, 2, 3, 5, 6)
  - [x] Créer `export.service.ts` dans `src/app/services/`
  - [x] Décorer avec `@Injectable({ providedIn: 'root' })`
  - [x] RxJS non nécessaire pour ce service (méthodes synchrones)
  - [x] Créer la structure de base avec méthodes vides documentées :
    - `exportPassage(passage: Passage): void`
    - `formatPassageText(passage: Passage): string`
  - [x] Ajouter un constructeur vide pour l'instant
  - [x] Vérifier que le service peut être injecté sans erreur

- [x] **Task 7: Create Model Interfaces** (AC: 5)
  - [x] Créer le dossier `src/app/models/` s'il n'existe pas
  - [x] Créer les interfaces TypeScript de base (complètes selon architecture) :
    - `position.model.ts` - Type `Position`
    - `technique.model.ts` - Interface `Technique`
    - `passage.model.ts` - Interfaces `Passage`, `PassageState`, `PassageConfig`
    - `passage-filters.model.ts` - Interface `PassageFilters`
    - `nomenclature.model.ts` - Interface `NomenclatureData`
    - `videos.model.ts` - Interface `VideosData`
    - `settings.model.ts` - Interface `UserSettings`
  - [x] Importer ces interfaces dans les services correspondants

- [x] **Task 8: Test Service Injection** (AC: 6)
  - [x] Créer des tests unitaires basiques pour chaque service
  - [x] Vérifier que chaque service peut être injecté dans TestBed
  - [x] Vérifier que les services sont créés sans erreur

---

## Dev Notes

### Previous Story Insights

**Source:** Story 1.2 - Routing Setup and Navigation

- Le routing est configuré et fonctionnel
- Les composants de pages existent (même s'ils sont vides pour l'instant)
- La structure de base du projet est en place

**Source:** Story 1.3 - Home Page with Quick Start Button

- HomeComponent est créé et fonctionnel
- La navigation vers `/config` fonctionne

### Technical Context

**Source:** [architecture/components.md](docs/architecture/components.md)

**GradeService:**
- **Responsibility:** Chargement et parsing des fichiers JSON (nomenclature.json, videos.json), gestion de la logique de génération de passages selon les grades et filtres
- **Key Interfaces:**
  - `loadNomenclature(): Observable<NomenclatureData>`
  - `loadVideos(): Observable<VideosData>`
  - `getTechniquesForGrade(grade: string, filters: PassageFilters): Technique[]`
  - `validateGrade(grade: string): boolean`
- **Dependencies:** HttpClient Angular pour charger les fichiers JSON
- **Technology Stack:** Angular Service, RxJS Observables, TypeScript

**PassageService:**
- **Responsibility:** Gestion de l'état du passage en cours (techniques, timer, progression), logique de génération aléatoire respectant l'ordre strict traditionnel
- **Key Interfaces:**
  - `generatePassage(grade: string, filters: PassageFilters, config: PassageConfig): Passage`
  - `startPassage(passage: Passage): void`
  - `pausePassage(): void`
  - `resumePassage(): void`
  - `getCurrentTechnique(): Technique | null`
  - `getPassageState(): Observable<PassageState>`
- **Dependencies:** GradeService pour récupérer les techniques, AudioService pour les annonces
- **Technology Stack:** Angular Service, RxJS BehaviorSubject, TypeScript

**AudioService:**
- **Responsibility:** Gestion de la lecture audio (audios locaux et option Elevenlabs), contrôle de la lecture, pause, répétition
- **Key Interfaces:**
  - `playTechnique(technique: Technique, voice: 'masculin' | 'féminin'): Promise<void>`
  - `pauseAudio(): void`
  - `resumeAudio(): void`
  - `repeatLastTechnique(): void`
  - `useElevenlabs(apiKey: string): void`
- **Dependencies:** SettingsService pour la voix par défaut, fichiers audio dans assets/
- **Technology Stack:** Angular Service, Web Audio API, Fetch API (pour Elevenlabs)

**SettingsService:**
- **Responsibility:** Gestion des réglages utilisateur (thème, couleurs, voix), persistance dans localStorage
- **Key Interfaces:**
  - `getSettings(): Observable<UserSettings>`
  - `updateSettings(settings: Partial<UserSettings>): void`
  - `resetSettings(): void`
  - `applyTheme(theme: 'clair' | 'sombre'): void`
- **Dependencies:** localStorage API, CSS Variables pour application des couleurs
- **Technology Stack:** Angular Service, RxJS BehaviorSubject, localStorage API

**ExportService:**
- **Responsibility:** Génération du fichier .txt avec les techniques et liens vidéo
- **Key Interfaces:**
  - `exportPassage(passage: Passage): void`
  - `formatPassageText(passage: Passage): string`
- **Dependencies:** Passage pour les données, VideosData pour les liens vidéo
- **Technology Stack:** Angular Service, Blob API, File Download API

**Source:** [architecture/frontend-architecture.md](docs/architecture/frontend-architecture.md)

**Service Example:**
```typescript
import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { BehaviorSubject, Observable } from 'rxjs';
import { map } from 'rxjs/operators';

@Injectable({
  providedIn: 'root'
})
export class GradeService {
  private nomenclature$ = new BehaviorSubject<NomenclatureData | null>(null);
  private videos$ = new BehaviorSubject<VideosData | null>(null);

  constructor(private http: HttpClient) {
    this.loadData();
  }

  private loadData(): void {
    // Implementation will be in future stories
  }

  getTechniquesForGrade(grade: string, filters: PassageFilters): Technique[] {
    // Implementation will be in future stories
    return [];
  }
}
```

**Source:** [architecture/coding-standards.md](docs/architecture/coding-standards.md)

**Standards critiques:**
- **Service Injection:** Toujours utiliser `providedIn: 'root'` pour les services Angular
- **State Management:** Utiliser BehaviorSubject pour l'état réactif, éviter les mutations directes
- **Type Safety:** Utiliser TypeScript strict mode, éviter `any`, typer toutes les interfaces
- **Naming Conventions:**
  - Services: camelCase with 'Service' (ex: `gradeService`)
  - Models/Interfaces: PascalCase (ex: `Passage`, `Technique`)

**Source:** [architecture/data-models.md](docs/architecture/data-models.md)

**Data Models (seront créés dans cette story comme structures vides):**
- `Passage` - Représente un passage de grade généré
- `Technique` - Représente une technique individuelle
- `UserSettings` - Réglages utilisateur persistés
- `PassageFilters` - Filtres appliqués lors de la génération
- `NomenclatureData` - Structure des données de nomenclature
- `VideosData` - Mapping des techniques vers leurs URLs vidéo

### File Locations

**Source:** [architecture/unified-project-structure.md](docs/architecture/unified-project-structure.md)

- **Services:** `src/app/services/`
  - `grade.service.ts`
  - `passage.service.ts`
  - `audio.service.ts`
  - `settings.service.ts`
  - `export.service.ts`
- **Models:** `src/app/models/`
  - `passage.model.ts`
  - `technique.model.ts`
  - `settings.model.ts`

### Testing Requirements

**Source:** [architecture/testing-strategy.md](docs/architecture/testing-strategy.md)

**Pour cette story:**
- Tests unitaires basiques pour chaque service
- Vérifier que les services peuvent être injectés
- Vérifier que les services sont créés sans erreur
- Framework: Jasmine + Karma (inclus avec Angular CLI)

**Test Scenarios:**
- Chaque service peut être injecté dans TestBed
- Les services sont créés sans erreur
- Les méthodes existent (même si elles sont vides pour l'instant)

### Technical Constraints

**Source:** [architecture/coding-standards.md](docs/architecture/coding-standards.md)

- **Service Injection:** Toujours utiliser `providedIn: 'root'`
- **RxJS:** Importer BehaviorSubject et Observable de RxJS
- **TypeScript:** Typer toutes les interfaces, éviter `any`

**Source:** [architecture/tech-stack.md](docs/architecture/tech-stack.md)

- **State Management:** RxJS BehaviorSubject (inclus avec Angular)
- **Pas de NgRx:** Services suffisants pour cette taille d'application

### Project Structure Notes

**Source:** [architecture/unified-project-structure.md](docs/architecture/unified-project-structure.md)

La structure doit suivre exactement le schéma défini dans l'architecture. Les services doivent être créés dans `src/app/services/` et les modèles dans `src/app/models/`.

**Note importante:**
- Les services sont créés avec des méthodes vides pour l'instant
- L'implémentation complète sera faite dans les stories suivantes
- Les interfaces TypeScript seront créées de manière basique et complétées dans les stories suivantes

---

## Testing

### Testing Standards

**Source:** [architecture/testing-strategy.md](docs/architecture/testing-strategy.md)

**Test File Location:**
- Tests unitaires: À côté des fichiers source avec extension `.spec.ts`
- Exemple: `grade.service.spec.ts` à côté de `grade.service.ts`

**Testing Framework:**
- Jasmine + Karma (inclus avec Angular CLI)

**Testing Patterns:**
- Utiliser `TestBed` pour la configuration des tests
- Tester l'injection des services

**Pour cette story:**
- Tests unitaires basiques pour chaque service
- Vérifier que les services peuvent être injectés
- Vérifier que les services sont créés sans erreur

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-19 | 1.0 | Création initiale de la story | Bob (SM) |
| 2025-01-09 | 1.1 | Implémentation complète - Toutes les tâches terminées | Auto (Dev) |

---

## Dev Agent Record

### Agent Model Used

Auto (Cursor AI)

### Debug Log References

N/A - Aucune erreur rencontrée. Build production réussi.

### Completion Notes List

1. **Dossiers créés** : `src/app/services/` et `src/app/models/` créés
2. **Modèles créés** : Tous les modèles TypeScript créés avec interfaces complètes selon l'architecture :
   - `position.model.ts` - Type `Position`
   - `technique.model.ts` - Interface `Technique`
   - `passage.model.ts` - Interfaces `Passage`, `PassageState`, `PassageConfig`
   - `passage-filters.model.ts` - Interface `PassageFilters`
   - `nomenclature.model.ts` - Interface `NomenclatureData`
   - `videos.model.ts` - Interface `VideosData`
   - `settings.model.ts` - Interface `UserSettings`
3. **GradeService créé** : Service avec HttpClient injecté, BehaviorSubjects pour nomenclature et videos, méthodes vides documentées
4. **PassageService créé** : Service avec BehaviorSubject pour l'état du passage, toutes les méthodes vides documentées
5. **AudioService créé** : Service avec méthodes vides documentées pour la gestion audio
6. **SettingsService créé** : Service avec BehaviorSubject pour les réglages, méthodes vides documentées
7. **ExportService créé** : Service avec méthodes vides documentées pour l'export
8. **Tests unitaires créés** : Tests basiques pour tous les services vérifiant l'injection et l'existence des méthodes
9. **Build réussi** : `ng build --configuration production` fonctionne sans erreurs (209.79 KB raw, 56.68 KB gzipped)
10. **Aucune erreur de linting** : Code conforme aux standards

### File List

**Fichiers créés - Modèles:**
- `src/app/models/position.model.ts` - Type Position
- `src/app/models/technique.model.ts` - Interface Technique
- `src/app/models/passage.model.ts` - Interfaces Passage, PassageState, PassageConfig
- `src/app/models/passage-filters.model.ts` - Interface PassageFilters
- `src/app/models/nomenclature.model.ts` - Interface NomenclatureData
- `src/app/models/videos.model.ts` - Interface VideosData
- `src/app/models/settings.model.ts` - Interface UserSettings

**Fichiers créés - Services:**
- `src/app/services/grade.service.ts` - GradeService avec HttpClient
- `src/app/services/passage.service.ts` - PassageService avec BehaviorSubject
- `src/app/services/audio.service.ts` - AudioService
- `src/app/services/settings.service.ts` - SettingsService avec BehaviorSubject
- `src/app/services/export.service.ts` - ExportService

**Fichiers créés - Tests:**
- `src/app/services/grade.service.spec.ts` - Tests unitaires pour GradeService
- `src/app/services/passage.service.spec.ts` - Tests unitaires pour PassageService
- `src/app/services/audio.service.spec.ts` - Tests unitaires pour AudioService
- `src/app/services/settings.service.spec.ts` - Tests unitaires pour SettingsService
- `src/app/services/export.service.spec.ts` - Tests unitaires pour ExportService

---

## QA Results

### Review Date: 2025-01-09

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Assessment:** ✅ **EXCELLENT**

L'implémentation de la story 1.4 est de très haute qualité. Tous les critères d'acceptation sont remplis avec une attention particulière à la structure, la documentation, et la conformité aux standards Angular. Tous les services sont correctement créés, injectables, et prêts pour l'implémentation future de la logique métier.

**Points forts:**
- ✅ Tous les 5 services créés : `GradeService`, `PassageService`, `AudioService`, `SettingsService`, `ExportService`
- ✅ Tous les services utilisent `@Injectable({ providedIn: 'root' })` correctement
- ✅ RxJS correctement importé et configuré (BehaviorSubject et Observable)
- ✅ Services organisés dans `src/app/services/` conformément à l'architecture
- ✅ Toutes les méthodes sont documentées avec JSDoc
- ✅ Tous les modèles TypeScript créés avec interfaces complètes
- ✅ Tests unitaires complets pour tous les services
- ✅ Build production réussi sans erreurs (229.34 KB raw, 60.07 KB gzipped)
- ✅ Aucune erreur de linting
- ✅ Conformité totale aux standards de codage Angular

### Refactoring Performed

Aucun refactoring nécessaire. Le code est déjà bien structuré et conforme aux standards Angular modernes.

**Note sur la structure:**
- Les services sont créés avec des méthodes vides comme prévu (implémentation dans stories suivantes)
- Les modèles sont complets et bien typés
- La documentation JSDoc est présente sur toutes les méthodes
- Les imports sont corrects et organisés

### Compliance Check

- **Coding Standards:** ✅ **PASS** - Conventions de nommage respectées, architecture standalone moderne, `providedIn: 'root'` utilisé partout
- **Project Structure:** ✅ **PASS** - Structure conforme à `unified-project-structure.md`, services et modèles dans les bons dossiers
- **Testing Strategy:** ✅ **PASS** - Tests unitaires complets créés pour tous les services, couverture de tous les scénarios de base
- **All ACs Met:** ✅ **PASS** - Tous les 6 critères d'acceptation sont remplis

### Improvements Checklist

- [x] Vérification des services créés - ✅ Tous les 5 services présents et correctement structurés
- [x] Vérification de l'injection - ✅ Tous utilisent `providedIn: 'root'`
- [x] Vérification de RxJS - ✅ BehaviorSubject et Observable importés correctement
- [x] Vérification de la structure - ✅ Services dans `src/app/services/`, modèles dans `src/app/models/`
- [x] Vérification de la documentation - ✅ Toutes les méthodes documentées avec JSDoc
- [x] Vérification des modèles - ✅ Tous les modèles créés avec interfaces complètes
- [x] Vérification des tests - ✅ Tests unitaires complets pour tous les services
- [x] Vérification du build - ✅ Build production réussi

### Security Review

✅ **Aucun problème de sécurité identifié**

Les services sont des structures de base sans logique métier implémentée. Aucune manipulation de données sensibles pour l'instant. Les services utilisent l'injection de dépendances standard Angular, sécurisée par défaut.

### Performance Considerations

✅ **Performance excellente**

- Bundle initial: 229.34 KB raw, 60.07 KB gzipped (excellent, légère augmentation due aux nouveaux services et modèles)
- Services légers avec méthodes vides (pas d'impact sur les performances)
- Structure prête pour l'implémentation future
- Aucun problème de performance identifié

### Files Modified During Review

Aucun fichier modifié lors de la review. L'implémentation est déjà complète et conforme.

### Gate Status

**Gate: PASS** → `docs/qa/gates/1.4-core-services-structure.yml`

**Quality Score:** 99/100

**Risques identifiés:** Aucun

**Trace des critères d'acceptation:**
- ✅ AC1: Tous les 5 services créés (`GradeService`, `PassageService`, `AudioService`, `SettingsService`, `ExportService`)
- ✅ AC2: Tous les services utilisent `@Injectable({ providedIn: 'root' })` correctement
- ✅ AC3: RxJS importé et configuré (BehaviorSubject et Observable) dans tous les services nécessaires
- ✅ AC4: Services organisés dans `src/app/services/` conformément à l'architecture
- ✅ AC5: Toutes les méthodes sont documentées avec JSDoc et ont une structure de base
- ✅ AC6: Tous les services peuvent être injectés sans erreur (vérifié par tests unitaires et build)

**Observations techniques:**
- Architecture standalone moderne utilisée (meilleure pratique)
- Tous les modèles TypeScript créés avec interfaces complètes et bien typées
- Tests unitaires complets avec couverture de tous les services
- Documentation JSDoc présente sur toutes les méthodes publiques
- Structure prête pour l'implémentation de la logique métier dans les stories suivantes
- Conformité totale aux standards de codage Angular

### Recommended Status

✅ **Ready for Done**

Tous les critères sont remplis. La story peut être marquée comme "Done". L'implémentation est de très haute qualité avec une structure solide prête pour le développement futur.
