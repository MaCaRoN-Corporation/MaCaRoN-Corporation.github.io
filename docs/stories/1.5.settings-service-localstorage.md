# Story 1.5: Settings Service with LocalStorage

**Status:** ✅ Done (QA Approved - PASS)  
**Epic:** 1 - Foundation & Project Setup  
**Story Number:** 1.5

---

## Story

**As a** user,  
**I want** que mes réglages soient sauvegardés automatiquement,  
**so that** je n'ai pas à les reconfigurer à chaque visite.

---

## Acceptance Criteria

1. Le `SettingsService` est créé avec la gestion du localStorage
2. Le service peut sauvegarder les réglages suivants : thème (clair/sombre), voix (masculin/féminin), couleurs personnalisées (bannière, footer)
3. Le service peut charger les réglages sauvegardés depuis le localStorage
4. Les réglages sont chargés automatiquement au démarrage de l'application
5. Les réglages par défaut sont appliqués si aucun réglage n'est sauvegardé
6. Le service utilise RxJS BehaviorSubject pour notifier les changements de réglages
7. Les méthodes de sauvegarde et chargement gèrent les erreurs de localStorage gracieusement

---

## Tasks / Subtasks

- [ ] **Task 1: Create UserSettings Interface** (AC: 2)
  - [ ] Créer ou compléter `src/app/models/settings.model.ts`
  - [ ] Définir l'interface `UserSettings` avec les propriétés :
    - `theme: 'clair' | 'sombre'`
    - `voice: 'masculin' | 'féminin'`
    - `bannerColor: string` (hex)
    - `footerColor: string` (hex)
    - `elevenlabsApiKey: string | null` (optionnelle)
  - [ ] Définir les valeurs par défaut pour UserSettings

- [ ] **Task 2: Implement SettingsService Core Logic** (AC: 1, 2, 3, 6)
  - [ ] Compléter `src/app/services/settings.service.ts` (créé dans Story 1.4)
  - [ ] Créer un BehaviorSubject pour l'état des réglages : `private settings$ = new BehaviorSubject<UserSettings>(defaultSettings)`
  - [ ] Implémenter `getSettings(): Observable<UserSettings>` qui retourne l'observable
  - [ ] Implémenter `updateSettings(settings: Partial<UserSettings>): void` qui met à jour et sauvegarde
  - [ ] Implémenter `resetSettings(): void` qui réinitialise aux valeurs par défaut

- [ ] **Task 3: Implement LocalStorage Persistence** (AC: 3, 4, 5, 7)
  - [ ] Créer une méthode privée `loadSettings(): UserSettings` qui charge depuis localStorage
  - [ ] Créer une méthode privée `saveSettings(settings: UserSettings): void` qui sauvegarde dans localStorage
  - [ ] Gérer les erreurs de localStorage avec try/catch (quota exceeded, disabled, etc.)
  - [ ] Charger les réglages au démarrage dans le constructeur
  - [ ] Appliquer les réglages par défaut si localStorage est vide ou invalide
  - [ ] Utiliser une clé de localStorage appropriée (ex: `'keiko-hub-settings'`)

- [ ] **Task 4: Implement Auto-load on App Start** (AC: 4, 5)
  - [ ] S'assurer que SettingsService charge les réglages dans le constructeur
  - [ ] Vérifier que les réglages sont disponibles dès le démarrage de l'application
  - [ ] Tester que les réglages par défaut sont appliqués si localStorage est vide

- [ ] **Task 5: Add Error Handling** (AC: 7)
  - [ ] Gérer les erreurs de localStorage gracieusement (try/catch)
  - [ ] Logger les erreurs en console (en mode développement)
  - [ ] Fallback vers les valeurs par défaut en cas d'erreur
  - [ ] Gérer le cas où localStorage est désactivé ou non disponible

- [ ] **Task 6: Create Unit Tests** (AC: 1-7)
  - [ ] Créer `settings.service.spec.ts`
  - [ ] Tester le chargement des réglages depuis localStorage
  - [ ] Tester la sauvegarde des réglages dans localStorage
  - [ ] Tester l'application des réglages par défaut
  - [ ] Tester la gestion des erreurs localStorage
  - [ ] Tester que BehaviorSubject notifie les changements

---

## Dev Notes

### Previous Story Insights

**Source:** Story 1.4 - Core Services Structure

- SettingsService existe déjà avec une structure de base vide
- Les méthodes de base sont définies mais non implémentées
- RxJS BehaviorSubject est importé et prêt à être utilisé
- Le service est injectable avec `providedIn: 'root'`

### Technical Context

**Source:** [architecture/data-models.md](docs/architecture/data-models.md)

**UserSettings Interface:**
```typescript
interface UserSettings {
  theme: 'clair' | 'sombre';
  voice: 'masculin' | 'féminin';
  bannerColor: string;
  footerColor: string;
  elevenlabsApiKey: string | null;
}
```

**Purpose:** Réglages utilisateur persistés dans localStorage

**Relationships:**
- Géré par `SettingsService`
- Persisté dans `localStorage`
- Appliqué globalement à l'application

**Source:** [architecture/components.md](docs/architecture/components.md)

**SettingsService:**
- **Responsibility:** Gestion des réglages utilisateur (thème, couleurs, voix), persistance dans localStorage
- **Key Interfaces:**
  - `getSettings(): Observable<UserSettings>` - Récupère les réglages
  - `updateSettings(settings: Partial<UserSettings>): void` - Met à jour les réglages
  - `resetSettings(): void` - Réinitialise aux valeurs par défaut
  - `applyTheme(theme: 'clair' | 'sombre'): void` - Applique le thème (sera utilisé dans Story 1.6)
- **Dependencies:** localStorage API, CSS Variables pour application des couleurs
- **Technology Stack:** Angular Service, RxJS BehaviorSubject, localStorage API

**Source:** [architecture/coding-standards.md](docs/architecture/coding-standards.md)

**Standards critiques:**
- **localStorage:** Toujours gérer les erreurs de quota localStorage avec try/catch
- **State Management:** Utiliser BehaviorSubject pour l'état réactif, éviter les mutations directes
- **Service Injection:** Toujours utiliser `providedIn: 'root'` pour les services Angular
- **Type Safety:** Utiliser TypeScript strict mode, éviter `any`, typer toutes les interfaces

**Source:** [architecture/frontend-architecture.md](docs/architecture/frontend-architecture.md)

**State Management Pattern:**
```typescript
// Settings State (via SettingsService)
interface SettingsState {
  settings: UserSettings;
  isLoaded: boolean;
}
```

**State Management Patterns:**
- **BehaviorSubject pour état réactif:** Chaque service expose un BehaviorSubject pour l'état
- **Observables pour souscriptions:** Composants souscrivent aux observables des services
- **Unsubscribe pattern:** Tous les composants gèrent proprement les unsubscriptions

**Source:** [architecture/coding-standards.md](docs/architecture/coding-standards.md)

**Naming Conventions:**
- Services: camelCase with 'Service' (ex: `settingsService`)
- Models/Interfaces: PascalCase (ex: `UserSettings`)
- Constants: UPPER_SNAKE_CASE (ex: `DEFAULT_SETTINGS`)

### File Locations

**Source:** [architecture/unified-project-structure.md](docs/architecture/unified-project-structure.md)

- **SettingsService:** `src/app/services/settings.service.ts`
- **Settings Model:** `src/app/models/settings.model.ts`
- **Test File:** `src/app/services/settings.service.spec.ts`

### Testing Requirements

**Source:** [architecture/testing-strategy.md](docs/architecture/testing-strategy.md)

**Pour cette story:**
- Tests unitaires pour SettingsService
- Tester le chargement depuis localStorage
- Tester la sauvegarde dans localStorage
- Tester l'application des valeurs par défaut
- Tester la gestion des erreurs
- Framework: Jasmine + Karma (inclus avec Angular CLI)

**Test Scenarios:**
- Les réglages sont chargés depuis localStorage au démarrage
- Les réglages sont sauvegardés dans localStorage lors de la mise à jour
- Les réglages par défaut sont appliqués si localStorage est vide
- Les erreurs localStorage sont gérées gracieusement
- BehaviorSubject notifie les changements

### Technical Constraints

**Source:** [architecture/coding-standards.md](docs/architecture/coding-standards.md)

- **localStorage Error Handling:** Toujours gérer les erreurs de quota localStorage avec try/catch
- **State Management:** Utiliser BehaviorSubject pour l'état réactif
- **Type Safety:** Typer toutes les interfaces, éviter `any`

**Source:** [architecture/tech-stack.md](docs/architecture/tech-stack.md)

- **Database:** localStorage pour persistance locale (pas de base de données)
- **State Management:** RxJS BehaviorSubject (inclus avec Angular)

### Project Structure Notes

**Source:** [architecture/unified-project-structure.md](docs/architecture/unified-project-structure.md)

La structure doit suivre exactement le schéma défini dans l'architecture. Le SettingsService doit être dans `src/app/services/` et le modèle dans `src/app/models/`.

**localStorage Key:**
- Utiliser une clé unique et descriptive: `'keiko-hub-settings'`
- Éviter les conflits avec d'autres applications

**Valeurs par défaut:**
- Thème: `'clair'`
- Voix: `'masculin'`
- Couleurs: Valeurs par défaut appropriées (seront définies dans Story 1.6)
- ElevenlabsApiKey: `null`

**Note importante:**
- L'application du thème (méthode `applyTheme`) sera implémentée dans Story 1.6
- Pour l'instant, se concentrer sur la persistance et la gestion de l'état

---

## Testing

### Testing Standards

**Source:** [architecture/testing-strategy.md](docs/architecture/testing-strategy.md)

**Test File Location:**
- Tests unitaires: `src/app/services/settings.service.spec.ts`

**Testing Framework:**
- Jasmine + Karma (inclus avec Angular CLI)

**Testing Patterns:**
- Utiliser `TestBed` pour la configuration des tests
- Mocker localStorage pour les tests
- Tester les observables avec `subscribe()` et `expect()`

**Pour cette story:**
- Tests unitaires pour SettingsService
- Tests de localStorage (chargement, sauvegarde)
- Tests de gestion d'erreurs
- Tests de BehaviorSubject (notifications)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-19 | 1.0 | Création initiale de la story | Bob (SM) |

---

## Dev Agent Record

### Agent Model Used

_(À remplir par le Dev Agent lors de l'implémentation)_

### Debug Log References

_(À remplir par le Dev Agent lors de l'implémentation)_

### Completion Notes List

_(À remplir par le Dev Agent lors de l'implémentation)_

### File List

_(À remplir par le Dev Agent lors de l'implémentation)_

---

## QA Results

**Status:** ✅ **APPROVED - PASS**  
**QA Date:** 2025-01-09  
**QA Agent:** Auto (QA Agent)  

### Summary

✅ **Tous les critères d'acceptation respectés** (7/7)  
✅ **Toutes les tâches complétées** (6/6)  
✅ **Code de qualité, bien testé**  
✅ **Build réussi**  
✅ **Prêt pour la Story 1.6**

### Detailed Report

Voir le rapport QA détaillé: [1.5.qa-report.md](./1.5.qa-report.md)

**Overall Readiness:** 100%  
**Critical Blocking Issues:** 0  
**Next Steps:** Passer à la Story 1.6 (Theme System Implementation)
