# Story 3.8: Passage Completion and End Screen

**Status:** Draft  
**Epic:** 3 - Passage Generation & Core Execution  
**Story Number:** 3.8  

---

## Story

**As a** user,  
**I want** voir un message de fin quand le passage est terminé,  
**so that** je sais que l'entraînement est complet.

---

## Acceptance Criteria

1. Quand toutes les techniques ont été énoncées (et l'annonce Randori si activée), un écran de fin s'affiche
2. L'écran de fin affiche un message de félicitations/completion
3. Un résumé du passage est affiché (nombre de techniques, durée totale, incluant le temps Randori si activé)
4. Un bouton "Exporter" est disponible pour exporter le passage
5. Un bouton "Nouveau passage" permet de générer un nouveau passage
6. Un bouton "Retour à l'accueil" permet de revenir à la page d'accueil
7. L'écran de fin est clair et encourageant
8. **Randori:** Si `includeRandoriTime` était activé, l'écran de fin indique que l'annonce Randori a été incluse dans le passage

---

## Tasks / Subtasks

- [ ] **Task 1: Detect Passage Completion** (AC: 1)
  - [ ] Détecter quand toutes les techniques sont terminées
  - [ ] Gérer la fin du Randori si activé
  - [ ] Intégrer avec PassageService pour détecter l'état "terminé"
  - [ ] Déclencher l'affichage de l'écran de fin

- [ ] **Task 2: Create End Screen Component/Section** (AC: 2, 7)
  - [ ] Créer l'écran de fin (composant ou section dans PassageComponent)
  - [ ] Message de félicitations/completion clair et encourageant
  - [ ] Design attrayant et positif
  - [ ] Intégrer dans PassageComponent template

- [ ] **Task 3: Display Passage Summary** (AC: 3, 8)
  - [ ] Afficher le nombre total de techniques
  - [ ] Afficher la durée totale du passage (elapsedTime)
  - [ ] Indiquer si Randori a été inclus (si includeRandoriTime était activé)
  - [ ] Format du résumé clair et lisible

- [ ] **Task 4: Implement Export Button** (AC: 4)
  - [ ] Créer le bouton "Exporter"
  - [ ] Intégrer avec ExportService (sera implémenté dans Epic 5)
  - [ ] Préparer l'appel à exportPassage() (peut être placeholder pour Epic 5)
  - [ ] Gérer l'état de chargement si nécessaire

- [ ] **Task 5: Implement New Passage Button** (AC: 5)
  - [ ] Créer le bouton "Nouveau passage"
  - [ ] Rediriger vers la page de configuration (/config)
  - [ ] Ou réinitialiser le passage actuel et générer un nouveau
  - [ ] Gérer la navigation avec Router

- [ ] **Task 6: Implement Home Button** (AC: 6)
  - [ ] Créer le bouton "Retour à l'accueil"
  - [ ] Rediriger vers la page d'accueil (/)
  - [ ] Utiliser Router.navigate()
  - [ ] Optionnel: Réinitialiser l'état du passage

- [ ] **Task 7: Handle Completion State** (AC: 1)
  - [ ] Gérer l'état "completed" dans PassageService ou composant
  - [ ] Afficher l'écran de fin uniquement quand terminé
  - [ ] Masquer les autres éléments (timer, technique, etc.) ou les remplacer
  - [ ] Transition fluide vers l'écran de fin

- [ ] **Task 8: Style End Screen** (AC: 7)
  - [ ] Styles CSS pour l'écran de fin
  - [ ] Design encourageant et positif
  - [ ] Styles pour les boutons
  - [ ] Responsive design (mobile et desktop)
  - [ ] Utiliser les variables CSS du thème

- [ ] **Task 9: Create Unit Tests** (AC: 1-8)
  - [ ] Tester la détection de fin de passage
  - [ ] Tester l'affichage de l'écran de fin
  - [ ] Tester le résumé (nombre, durée, Randori)
  - [ ] Tester les boutons (Exporter, Nouveau passage, Accueil)
  - [ ] Tester l'intégration avec PassageService
  - [ ] Tester la navigation

---

## Dev Notes

### Previous Story Insights

**Source:** Story 3.7 - Progress Indicator
- PassageComponent structure complète
- PassageService intégré
- PassageState avec progression disponible

**Source:** Story 3.2 - Passage State Management
- PassageService gère l'état du passage
- Détection de fin: currentTechniqueIndex >= total techniques
- elapsedTime disponible pour la durée totale

**Source:** Epic 5 - Personalization & Export (future)
- ExportService sera créé dans Epic 5
- Pour cette story, préparer l'intégration (placeholder si nécessaire)

### Technical Context

**Source:** [architecture/components.md](../../architecture/components.md)

**PassageComponent:**
- **Location:** `src/app/pages/passage/passage.ts`, `passage.html`, `passage.scss`
- **Dependencies:** PassageService, Router, ExportService (Epic 5)

**Completion Detection:**
- Passage terminé quand: currentTechniqueIndex >= total techniques (incluant Randori si activé)
- PassageState peut avoir un flag `isCompleted` ou le détecter dynamiquement

**End Screen Display:**
- Afficher quand isCompleted === true
- Masquer les autres sections (timer, technique, countdown, etc.)
- Ou overlay par-dessus

**Summary Data:**
- Nombre de techniques: currentPassage.techniques.length
- Durée totale: elapsedTime (en secondes, formater en MM:SS ou minutes)
- Randori inclus: includeRandoriTime === true

**Navigation:**
- Router.navigate(['/config']) pour nouveau passage
- Router.navigate(['/']) pour accueil
- Importer Router depuis @angular/router

### Implementation Details

**Completion Detection:**
```typescript
isCompleted(): boolean {
  const state = this.passageService.getPassageState().value;
  if (!state.currentPassage) return false;
  
  const total = state.currentPassage.techniques.length + 
    (state.currentPassage.includeRandoriTime ? 1 : 0);
  return state.currentTechniqueIndex >= total;
}
```

**Summary Data:**
```typescript
getSummary() {
  const state = this.passageService.getPassageState().value;
  if (!state.currentPassage) return null;
  
  return {
    totalTechniques: state.currentPassage.techniques.length,
    duration: state.elapsedTime,
    includeRandori: state.currentPassage.includeRandoriTime || false
  };
}
```

**Template Structure:**
```html
<div class="end-screen" *ngIf="isCompleted()">
  <div class="end-screen-content">
    <h2 class="completion-message">Félicitations !</h2>
    <p class="completion-text">Vous avez terminé le passage.</p>
    
    <div class="summary" *ngIf="summary">
      <p><strong>Techniques:</strong> {{ summary.totalTechniques }}</p>
      <p><strong>Durée:</strong> {{ formatDuration(summary.duration) }}</p>
      <p *ngIf="summary.includeRandori"><strong>Randori:</strong> Inclus</p>
    </div>
    
    <div class="end-screen-actions">
      <button class="btn btn-primary" (click)="exportPassage()">
        Exporter
      </button>
      <button class="btn btn-secondary" (click)="newPassage()">
        Nouveau passage
      </button>
      <button class="btn btn-outline" (click)="goHome()">
        Retour à l'accueil
      </button>
    </div>
  </div>
</div>
```

**Component Logic:**
```typescript
isPassageCompleted = false;
summary: any = null;

constructor(
  private passageService: PassageService,
  private router: Router,
  private exportService: ExportService // Epic 5
) {}

ngOnInit() {
  this.subscriptions.add(
    this.passageService.getPassageState().subscribe(state => {
      this.isPassageCompleted = this.isCompleted();
      if (this.isPassageCompleted) {
        this.summary = this.getSummary();
      }
    })
  );
}

exportPassage(): void {
  const state = this.passageService.getPassageState().value;
  if (state.currentPassage) {
    this.exportService.exportPassage(state.currentPassage);
  }
}

newPassage(): void {
  this.router.navigate(['/config']);
}

goHome(): void {
  this.router.navigate(['/']);
}
```

**Styles CSS:**
```scss
.end-screen {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.9);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  
  .end-screen-content {
    background: var(--background-primary);
    padding: 2rem;
    border-radius: 12px;
    text-align: center;
    max-width: 500px;
    width: 90%;
    
    .completion-message {
      font-size: 2rem;
      color: var(--primary-color);
      margin-bottom: 1rem;
    }
    
    .summary {
      margin: 2rem 0;
      padding: 1rem;
      background: var(--background-secondary);
      border-radius: 8px;
    }
    
    .end-screen-actions {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      
      button {
        padding: 1rem;
        font-size: 1rem;
      }
    }
  }
}
```

**Note ExportService:**
- ExportService sera créé dans Epic 5
- Pour cette story, créer un placeholder ou préparer l'intégration
- Si ExportService n'existe pas encore, le bouton peut être désactivé ou avoir un comportement placeholder

---

## Dependencies

- ✅ Story 3.7 complétée (PassageComponent structure complète)
- ✅ Story 3.2 complétée (PassageState, détection de fin)
- ✅ Router configuré (Story 1.2)
- ⚠️ ExportService (Epic 5) - peut être placeholder pour cette story

---

## Testing Checklist

- [ ] Test: Écran de fin s'affiche quand passage terminé
- [ ] Test: Message de félicitations affiché
- [ ] Test: Résumé affiché (nombre, durée)
- [ ] Test: Indication Randori si inclus
- [ ] Test: Bouton Exporter fonctionne (ou placeholder)
- [ ] Test: Bouton Nouveau passage redirige vers /config
- [ ] Test: Bouton Accueil redirige vers /
- [ ] Test: Design encourageant et clair
- [ ] Test: Détection de fin fonctionne (avec et sans Randori)
- [ ] Test: Transition vers écran de fin fluide

---

## Definition of Done

- ✅ Tous les Acceptance Criteria sont remplis
- ✅ Code compile sans erreurs
- ✅ Tests unitaires passent (couverture minimale 70%)
- ✅ Écran de fin s'affiche correctement
- ✅ Résumé affiché correctement
- ✅ Boutons fonctionnent (navigation et export placeholder)
- ✅ Design encourageant et clair
- ✅ Code review effectué
- ✅ Documentation du code (JSDoc) ajoutée

---
