# Story 2.8: Weapons and Randori Configuration

**Status:** Pending  
**Epic:** 2 - Data Management & Configuration  
**Story Number:** 2.8

---

## Story

**As a** user,  
**I want** to inclure ou exclure les armes dans le passage et activer une annonce audio "Randori" à la fin,  
**so that** je peux adapter le passage selon mes besoins d'entraînement.

---

## Acceptance Criteria

1. La page de configuration affiche une section "Options avancées" pour les armes et Randori
2. Une option toggle/checkbox pour inclure/exclure les armes est disponible
3. L'option armes est automatiquement désactivée/grisée si le grade ne les inclut pas (ex: Kyū grades)
4. Une option toggle/checkbox pour activer l'annonce audio finale "Randori" est disponible
5. Un champ de configuration pour le temps de l'annonce Randori est disponible (personnalisable en secondes)
6. Le temps Randori est validé (minimum 3 secondes, maximum 60 secondes, par défaut 10 secondes)
7. Les options sont clairement étiquetées avec des descriptions explicatives
8. L'interface indique clairement quelles options sont disponibles selon le grade
9. Les options sont sauvegardées dans le composant ConfigComponent
10. **Note importante:** Randori n'est pas une position avec techniques dans nomenclature.json. C'est uniquement une annonce audio finale configurable (booléen + temps personnalisable).
11. Le design est responsive et fonctionne sur mobile et desktop

---

## Tasks / Subtasks

- [ ] **Task 1: Create Advanced Options Section** (AC: 1, 7)
  - [ ] Ajouter une section "Options avancées" dans le template ConfigComponent
  - [ ] Utiliser un titre clair (h2 ou h3)
  - [ ] Organiser en deux sous-sections: "Armes" et "Randori"

- [ ] **Task 2: Implement Weapons Toggle** (AC: 2, 3, 8, 9)
  - [ ] Créer un toggle/checkbox "Inclure les armes"
  - [ ] Créer une propriété includeWeapons: boolean dans le composant
  - [ ] Initialiser avec false par défaut
  - [ ] Vérifier si le grade sélectionné permet les armes (via GradeService)
  - [ ] Désactiver/griser le toggle si le grade ne permet pas les armes
  - [ ] Afficher un message explicatif si les armes ne sont pas disponibles

- [ ] **Task 3: Integrate GradeService for Weapon Availability** (AC: 3, 8)
  - [ ] Utiliser GradeService.getWeaponPositions(grade) ou méthode similaire
  - [ ] Vérifier si des positions d'armes sont disponibles pour le grade
  - [ ] Déterminer si includeWeapons peut être activé selon le grade
  - [ ] Mettre à jour la disponibilité lors du changement de grade

- [ ] **Task 4: Implement Weapon Rules Logic** (AC: 3, 8)
  - [ ] Implémenter la logique: armes disponibles à partir du 1er Dan
  - [ ] Pour les grades Kyū: désactiver/griser l'option armes
  - [ ] Pour 1er et 2e Dan: activer l'option armes (Tanto Dori, Jo Dori, Jo Nage)
  - [ ] Pour 3e, 4e, 5e Dan: activer l'option armes (toutes les armes incluant Ken Taï Ken, Jo Taï Jo, Tachi Dori)
  - [ ] Afficher un message informatif selon le grade

- [ ] **Task 5: Implement Randori Toggle** (AC: 4, 9, 10)
  - [ ] Créer un toggle/checkbox "Activer l'annonce audio Randori à la fin"
  - [ ] Créer une propriété includeRandori: boolean dans le composant
  - [ ] Initialiser avec false par défaut
  - [ ] Ajouter une description claire: "Annonce audio finale 'Randori' (pas de techniques spécifiques)"
  - [ ] Clarifier que Randori n'est pas une position avec techniques

- [ ] **Task 6: Implement Randori Time Configuration** (AC: 5, 6, 9)
  - [ ] Créer un champ numérique pour le temps Randori (en secondes)
  - [ ] Créer une propriété randoriTime: number dans le composant
  - [ ] Définir la valeur par défaut: 10 secondes
  - [ ] Définir les limites: minimum 3 secondes, maximum 60 secondes
  - [ ] Implémenter la validation (min/max)
  - [ ] Afficher le champ uniquement si includeRandori est activé
  - [ ] Désactiver le champ si includeRandori est désactivé

- [ ] **Task 7: Add Descriptive Labels and Help Text** (AC: 7, 8, 10)
  - [ ] Ajouter des labels clairs pour chaque option
  - [ ] Ajouter du texte d'aide/explicatif pour les armes (quand disponibles selon grade)
  - [ ] Ajouter du texte d'aide pour Randori (clarifier que c'est une annonce audio, pas une position)
  - [ ] Afficher des messages informatifs selon le grade sélectionné

- [ ] **Task 8: Handle Grade Change Updates** (AC: 3, 8)
  - [ ] Écouter les changements du grade sélectionné
  - [ ] Quand le grade change, vérifier la disponibilité des armes
  - [ ] Désactiver includeWeapons si le nouveau grade ne permet pas les armes
  - [ ] Réinitialiser includeWeapons à false si nécessaire
  - [ ] Mettre à jour les messages informatifs

- [ ] **Task 9: Implement Validation** (AC: 6)
  - [ ] Valider randoriTime (3-60 secondes)
  - [ ] Afficher des messages d'erreur si les valeurs sont hors limites
  - [ ] Empêcher la soumission si les valeurs sont invalides

- [ ] **Task 10: Add Visual Feedback** (AC: 7, 8)
  - [ ] Style pour les toggles activés/désactivés
  - [ ] Style pour les champs désactivés (grisés)
  - [ ] Messages informatifs avec style distinct (info, warning)
  - [ ] Utiliser les variables CSS du thème

- [ ] **Task 11: Implement Responsive Design** (AC: 11)
  - [ ] Adapter le layout pour mobile (sections empilées)
  - [ ] Adapter le layout pour desktop
  - [ ] Utiliser media queries
  - [ ] Tester sur différentes tailles d'écran

- [ ] **Task 12: Add Accessibility Features** (AC: 7)
  - [ ] Ajouter des labels appropriés pour les toggles
  - [ ] Ajouter aria-label ou aria-labelledby
  - [ ] Ajouter aria-describedby pour les textes d'aide
  - [ ] Assurer la navigation au clavier
  - [ ] Tester avec un lecteur d'écran

- [ ] **Task 13: Update PassageFilters Model** (AC: 9)
  - [ ] S'assurer que PassageFilters inclut includeWeapons: boolean
  - [ ] S'assurer que PassageFilters inclut includeRandori: boolean
  - [ ] Ajouter randoriTime au modèle PassageFilters ou PassageConfig (si nécessaire)
  - [ ] Note: randoriTime pourrait être dans PassageConfig plutôt que PassageFilters

- [ ] **Task 14: Create Unit Tests** (AC: 1-11)
  - [ ] Tester l'affichage de la section
  - [ ] Tester le toggle includeWeapons
  - [ ] Tester la disponibilité des armes selon le grade
  - [ ] Tester le toggle includeRandori
  - [ ] Tester la configuration du temps Randori
  - [ ] Tester la validation du temps Randori
  - [ ] Tester les mises à jour lors du changement de grade
  - [ ] Tester les messages informatifs

---

## Dev Notes

### Previous Story Insights

**Source:** Story 2.2 - JSON Parsing and Data Structure
- GradeService.getWeaponPositions() ou méthode similaire pour obtenir les positions d'armes
- Les armes sont dans la position "Armes" dans nomenclature.json

**Source:** Story 2.3 - Grade Selection Interface
- Le grade sélectionné est disponible dans ConfigComponent

**Source:** Story 1.4 - Core Services Structure
- PassageFilters interface contient includeWeapons et includeRandori

### Technical Context

**Source:** [architecture/components.md](../../architecture/components.md)

**Weapon Rules (from nomenclature.json and user clarifications):**
- **Grades Kyū (6e à 1er Kyū):** Aucune arme disponible
- **1er et 2e Dan:** Tanto Dori, Jo Dori, Jo Nage disponibles
- **3e, 4e, 5e Dan:** Toutes les armes (Tanto Dori, Jo Dori, Jo Nage, Ken Taï Ken, Jo Taï Jo, Tachi Dori)
- **Note:** Ken Taï Ken et Jo Taï Jo sont du Jiyu Waza (pas de techniques spécifiques dans nomenclature.json)

**Randori:**
- **IMPORTANT:** Randori n'est PAS une position avec techniques
- Randori est uniquement une annonce audio finale optionnelle
- Configuré via un booléen (includeRandori) et un temps personnalisable (randoriTime)
- Pas de techniques "Randori" dans nomenclature.json

**PassageFilters Interface:**
```typescript
interface PassageFilters {
  positions: Position[];
  attacks: string[];
  techniques: string[];
  includeWeapons: boolean;
  /**
   * Active l'annonce audio "Randori" à la fin du passage
   * (pas de techniques spécifiques, juste une annonce finale avec temps personnalisable)
   */
  includeRandori: boolean;
}
```

**PassageConfig or Passage Model:**
- randoriTime pourrait être dans PassageConfig ou Passage model
- Passage model contient déjà duration et timeBetweenTechniques

**ConfigComponent:**
- **Location:** `src/app/pages/config/config.ts` et `config.html`
- **Dependency:** GradeService pour vérifier la disponibilité des armes

**UI/UX Considerations:**
- Utiliser des toggles pour meilleure UX (switch/toggle buttons)
- Messages informatifs clairs pour expliquer les règles selon le grade
- Champ temps Randori visible uniquement si Randori est activé

**Default Values:**
- includeWeapons: false (par défaut)
- includeRandori: false (par défaut)
- randoriTime: 10 secondes (par défaut)

**Validation:**
- randoriTime: 3-60 secondes (minimum pour annonce, maximum raisonnable)

### Implementation Details

**Component Structure:**
```typescript
export class ConfigComponent {
  includeWeapons: boolean = false;
  includeRandori: boolean = false;
  randoriTime: number = 10; // secondes

  readonly MIN_RANDORI_TIME = 3;
  readonly MAX_RANDORI_TIME = 60;

  get weaponsAvailable(): boolean {
    // Vérifier si le grade permet les armes (1er Dan et plus)
    const weaponPositions = this.gradeService.getWeaponPositions(this.selectedGrade);
    return weaponPositions.length > 0;
  }

  get canIncludeWeapons(): boolean {
    return this.weaponsAvailable && this.includeWeapons;
  }

  onWeaponsToggle() {
    if (this.weaponsAvailable) {
      this.includeWeapons = !this.includeWeapons;
    }
  }

  onRandoriToggle() {
    this.includeRandori = !this.includeRandori;
    // Réinitialiser randoriTime si désactivé (optionnel)
    if (!this.includeRandori) {
      this.randoriTime = 10;
    }
  }

  validateRandoriTime(): boolean {
    return this.randoriTime >= this.MIN_RANDORI_TIME && 
           this.randoriTime <= this.MAX_RANDORI_TIME;
  }

  onGradeChange(grade: string) {
    // Vérifier la disponibilité des armes pour le nouveau grade
    if (!this.weaponsAvailable) {
      this.includeWeapons = false; // Désactiver si pas disponible
    }
  }
}
```

**Template Structure:**
```html
<section class="advanced-options">
  <h2>Options avancées</h2>

  <!-- Option Armes -->
  <div class="option-group">
    <h3>Armes</h3>
    <div class="toggle-control">
      <label class="toggle-label">
        <input 
          type="checkbox"
          [(ngModel)]="includeWeapons"
          [disabled]="!weaponsAvailable"
          (change)="onWeaponsToggle()">
        <span>Inclure les armes dans le passage</span>
      </label>
      <p *ngIf="!weaponsAvailable" class="info-message">
        Les armes ne sont disponibles qu'à partir du 1er Dan.
      </p>
      <p *ngIf="weaponsAvailable && selectedGrade" class="info-message">
        Les armes disponibles pour {{ selectedGrade }}: Tanto Dori, Jo Dori, Jo Nage
        <span *ngIf="isHighDanGrade()">, Ken Taï Ken, Jo Taï Jo, Tachi Dori</span>
      </p>
    </div>
  </div>

  <!-- Option Randori -->
  <div class="option-group">
    <h3>Randori</h3>
    <div class="toggle-control">
      <label class="toggle-label">
        <input 
          type="checkbox"
          [(ngModel)]="includeRandori"
          (change)="onRandoriToggle()">
        <span>Activer l'annonce audio "Randori" à la fin du passage</span>
      </label>
      <p class="help-text">
        L'annonce "Randori" sera déclenchée à la fin du passage (pas de techniques spécifiques).
      </p>
    </div>
    
    <div *ngIf="includeRandori" class="randori-time-control">
      <label for="randori-time">Temps de l'annonce Randori (secondes)</label>
      <div class="input-group">
        <button (click)="decrementRandoriTime()" [disabled]="randoriTime <= MIN_RANDORI_TIME">-</button>
        <input 
          type="number" 
          id="randori-time"
          [(ngModel)]="randoriTime"
          [min]="MIN_RANDORI_TIME"
          [max]="MAX_RANDORI_TIME"
          (blur)="validateRandoriTimeInput()">
        <span>secondes</span>
        <button (click)="incrementRandoriTime()" [disabled]="randoriTime >= MAX_RANDORI_TIME">+</button>
      </div>
      <div *ngIf="!validateRandoriTime()" class="error-message">
        Le temps doit être entre {{ MIN_RANDORI_TIME }} et {{ MAX_RANDORI_TIME }} secondes.
      </div>
    </div>
  </div>
</section>
```

**Styling:**
- Utiliser les variables CSS du thème
- Style pour les toggles/checkboxes
- Style pour les champs désactivés (opacity, cursor: not-allowed)
- Messages informatifs avec style distinct (couleur info, background)
- Responsive avec media queries

---

## Dependencies

- ✅ Story 2.2 complétée (getWeaponPositions() ou logique similaire)
- ✅ Story 2.3 complétée (grade sélectionné)
- ✅ PassageFilters interface contient includeWeapons et includeRandori (Story 1.4)

---

## Testing Checklist

- [ ] Test: Section advanced options s'affiche
- [ ] Test: Toggle includeWeapons fonctionne
- [ ] Test: Toggle includeWeapons est désactivé pour les grades Kyū
- [ ] Test: Toggle includeWeapons est activé pour les grades Dan
- [ ] Test: Toggle includeRandori fonctionne
- [ ] Test: Champ temps Randori s'affiche seulement si Randori activé
- [ ] Test: Validation temps Randori fonctionne (3-60s)
- [ ] Test: Messages informatifs s'affichent correctement selon le grade
- [ ] Test: Mises à jour lors du changement de grade
- [ ] Test: Responsive design fonctionne
- [ ] Test: Accessibilité (labels, navigation clavier)

---

## Definition of Done

- ✅ Tous les Acceptance Criteria sont remplis
- ✅ Code compile sans erreurs
- ✅ Tests unitaires passent (couverture minimale 70%)
- ✅ Logique des armes selon grade fonctionne
- ✅ Randori configuré correctement (booléen + temps)
- ✅ Interface responsive
- ✅ Accessibilité de base respectée
- ✅ Code review effectué
- ✅ Documentation du code (JSDoc) ajoutée
- ✅ Clarification Randori respectée (pas une position)
