# Story 2.8: Weapons and Randori Configuration

**Status:** Pending  
**Epic:** 2 - Data Management & Configuration  
**Story Number:** 2.8

---

## Story

**As a** user,  
**I want** to activer une annonce audio "Randori" à la fin du passage,  
**so that** je peux adapter le passage selon mes besoins d'entraînement.

**Note:** Le toggle des armes (`includeWeaponTime`) est déjà implémenté avec les règles appropriées et ne doit pas être modifié. Cette story se concentre uniquement sur la configuration de Randori (si différente du système existant `includeRandoriTime`).

---

## Acceptance Criteria

1. ~~La page de configuration affiche une section "Options avancées" pour les armes et Randori~~ ✅ **DÉJÀ IMPLÉMENTÉ**
2. ~~Une option toggle/checkbox pour inclure/exclure les armes est disponible~~ ✅ **DÉJÀ IMPLÉMENTÉ**
3. ~~L'option armes est automatiquement désactivée/grisée si le grade ne les inclut pas (ex: Kyū grades)~~ ✅ **DÉJÀ IMPLÉMENTÉ**
4. Une option toggle/checkbox pour activer l'annonce audio finale "Randori" est disponible
5. Un champ de configuration pour le temps de l'annonce Randori est disponible (personnalisable en secondes)
6. Le temps Randori est validé (minimum 3 secondes, maximum 60 secondes, par défaut 10 secondes)
7. Les options sont clairement étiquetées avec des descriptions explicatives
8. ~~L'interface indique clairement quelles options sont disponibles selon le grade~~ ✅ **DÉJÀ IMPLÉMENTÉ (pour les armes)**
9. Les options sont sauvegardées dans le composant ConfigComponent
10. **Note importante:** Randori n'est pas une position avec techniques dans nomenclature.json. C'est uniquement une annonce audio finale configurable (booléen + temps personnalisable).
11. ~~Le design est responsive et fonctionne sur mobile et desktop~~ ✅ **DÉJÀ IMPLÉMENTÉ (pour les armes)**

**Note importante:** Le toggle des armes (`includeWeaponTime`) est **déjà implémenté** avec les règles appropriées (affiché uniquement si grade >= 1er Kyū) et ne doit **PAS** être modifié. Cette story se concentre uniquement sur la configuration de Randori.

---

## Tasks / Subtasks

- [x] **Task 1: Create Advanced Options Section** (AC: 1, 7) ✅ **DÉJÀ IMPLÉMENTÉ**
  - [x] Section "Options supplémentaires" existe déjà dans ConfigComponent
  - [x] Toggle des armes déjà présent et fonctionnel

- [x] **Task 2: Implement Weapons Toggle** (AC: 2, 3, 8, 9) ✅ **DÉJÀ IMPLÉMENTÉ - NE PAS MODIFIER**
  - [x] Toggle des armes (`includeWeaponTime`) déjà implémenté
  - [x] Propriété `includeWeaponTime: boolean` existe
  - [x] Règles de grade déjà en place (`shouldShowWeaponToggle`)
  - [x] Contrôle du temps dédié aux armes (`weaponTime`) déjà implémenté
  - **⚠️ NE PAS MODIFIER cette implémentation**

- [x] **Task 3: Integrate GradeService for Weapon Availability** (AC: 3, 8) ✅ **DÉJÀ IMPLÉMENTÉ**
  - [x] Logique de disponibilité selon le grade déjà en place
  - [x] `shouldShowWeaponToggle` gère l'affichage conditionnel

- [x] **Task 4: Implement Weapon Rules Logic** (AC: 3, 8) ✅ **DÉJÀ IMPLÉMENTÉ**
  - [x] Règles: armes disponibles à partir de 1er Kyū (affiché si grade >= 1er Kyū)
  - [x] Pour les grades Kyū: toggle non affiché
  - [x] Pour grades >= 1er Kyū: toggle affiché et fonctionnel

- [ ] **Task 5: Implement Randori Toggle** (AC: 4, 9, 10)
  - [ ] Créer un toggle/checkbox "Activer l'annonce audio Randori à la fin"
  - [ ] Créer une propriété includeRandori: boolean dans le composant
  - [ ] Initialiser avec false par défaut
  - [ ] Ajouter une description claire: "Annonce audio finale 'Randori' (pas de techniques spécifiques)"
  - [ ] Clarifier que Randori n'est pas une position avec techniques

- [ ] **Task 6: Implement Randori Time Configuration** (AC: 5, 6, 9)
  - [ ] Créer un champ numérique pour le temps Randori (en secondes)
  - [ ] Créer une propriété randoriTime: number dans le composant
  - [ ] Définir la valeur par défaut: 10 secondes
  - [ ] Définir les limites: minimum 3 secondes, maximum 60 secondes
  - [ ] Implémenter la validation (min/max)
  - [ ] Afficher le champ uniquement si includeRandori est activé
  - [ ] Désactiver le champ si includeRandori est désactivé

- [ ] **Task 7: Add Descriptive Labels and Help Text** (AC: 7, 8, 10)
  - [ ] Ajouter des labels clairs pour chaque option
  - [ ] Ajouter du texte d'aide/explicatif pour les armes (quand disponibles selon grade)
  - [ ] Ajouter du texte d'aide pour Randori (clarifier que c'est une annonce audio, pas une position)
  - [ ] Afficher des messages informatifs selon le grade sélectionné

- [x] **Task 8: Handle Grade Change Updates** (AC: 3, 8) ✅ **DÉJÀ IMPLÉMENTÉ (pour les armes)**
  - [x] Les changements de grade sont déjà gérés pour les armes
  - [x] `shouldShowWeaponToggle` se met à jour automatiquement
  - **⚠️ NE PAS MODIFIER cette logique pour les armes**

- [ ] **Task 9: Implement Validation** (AC: 6)
  - [ ] Valider randoriTime (3-60 secondes)
  - [ ] Afficher des messages d'erreur si les valeurs sont hors limites
  - [ ] Empêcher la soumission si les valeurs sont invalides

- [ ] **Task 10: Add Visual Feedback** (AC: 7, 8)
  - [ ] Style pour les toggles activés/désactivés
  - [ ] Style pour les champs désactivés (grisés)
  - [ ] Messages informatifs avec style distinct (info, warning)
  - [ ] Utiliser les variables CSS du thème

- [ ] **Task 11: Implement Responsive Design** (AC: 11)
  - [ ] Adapter le layout pour mobile (sections empilées)
  - [ ] Adapter le layout pour desktop
  - [ ] Utiliser media queries
  - [ ] Tester sur différentes tailles d'écran

- [ ] **Task 12: Add Accessibility Features** (AC: 7)
  - [ ] Ajouter des labels appropriés pour les toggles
  - [ ] Ajouter aria-label ou aria-labelledby
  - [ ] Ajouter aria-describedby pour les textes d'aide
  - [ ] Assurer la navigation au clavier
  - [ ] Tester avec un lecteur d'écran

- [ ] **Task 13: Update PassageFilters Model** (AC: 9)
  - [ ] S'assurer que PassageFilters inclut includeWeapons: boolean
  - [ ] S'assurer que PassageFilters inclut includeRandori: boolean
  - [ ] Ajouter randoriTime au modèle PassageFilters ou PassageConfig (si nécessaire)
  - [ ] Note: randoriTime pourrait être dans PassageConfig plutôt que PassageFilters

- [ ] **Task 14: Create Unit Tests** (AC: 1-11)
  - [x] Tester l'affichage de la section ✅ **DÉJÀ TESTÉ (armes)**
  - [x] Tester le toggle includeWeaponTime ✅ **DÉJÀ TESTÉ**
  - [x] Tester la disponibilité des armes selon le grade ✅ **DÉJÀ TESTÉ**
  - [ ] Tester le toggle includeRandori
  - [ ] Tester la configuration du temps Randori
  - [ ] Tester la validation du temps Randori
  - [x] Tester les mises à jour lors du changement de grade ✅ **DÉJÀ TESTÉ (armes)**
  - [ ] Tester les messages informatifs pour Randori

---

## Dev Notes

### Previous Story Insights

**Source:** Story 2.2 - JSON Parsing and Data Structure
- GradeService.getWeaponPositions() ou méthode similaire pour obtenir les positions d'armes
- Les armes sont dans la position "Armes" dans nomenclature.json

**Source:** Story 2.3 - Grade Selection Interface
- Le grade sélectionné est disponible dans ConfigComponent

**Source:** Story 1.4 - Core Services Structure
- PassageFilters interface contient includeWeapons et includeRandori

### Technical Context

**Source:** [architecture/components.md](../../architecture/components.md)

**⚠️ IMPORTANT - Toggle des armes DÉJÀ IMPLÉMENTÉ:**

Le toggle des armes est **déjà implémenté** dans `ConfigComponent` avec les propriétés suivantes:
- `includeWeaponTime: boolean` - Toggle pour activer/désactiver le temps dédié aux armes
- `weaponTime: number` - Temps dédié aux armes en minutes (avec MIN/MAX)
- `shouldShowWeaponToggle: boolean` - Getter qui détermine l'affichage (grade >= 1er Kyū)
- `shouldShowWeaponTime: boolean` - Getter qui détermine l'affichage du contrôle de temps
- `toggleIncludeWeaponTime()` - Méthode pour basculer le toggle
- `incrementWeaponTime()` / `decrementWeaponTime()` - Méthodes pour ajuster le temps

**Règles implémentées (NE PAS MODIFIER):**
- Toggle affiché uniquement si grade >= 1er Kyū (pas pour 6e à 2e Kyū)
- Contrôle du temps dédié aux armes visible uniquement si `includeWeaponTime` est true
- Temps dédié aux armes en minutes (pas en secondes)

**Randori:**
- **IMPORTANT:** Randori n'est PAS une position avec techniques
- Randori est uniquement une annonce audio finale optionnelle
- Configuré via un booléen (includeRandori) et un temps personnalisable (randoriTime)
- Pas de techniques "Randori" dans nomenclature.json

**PassageFilters Interface:**
```typescript
interface PassageFilters {
  positions: Position[];
  attacks: string[];
  techniques: string[];
  includeWeapons: boolean;
  /**
   * Active l'annonce audio "Randori" à la fin du passage
   * (pas de techniques spécifiques, juste une annonce finale avec temps personnalisable)
   */
  includeRandori: boolean;
}
```

**PassageConfig or Passage Model:**
- randoriTime pourrait être dans PassageConfig ou Passage model
- Passage model contient déjà duration et timeBetweenTechniques

**ConfigComponent:**
- **Location:** `src/app/pages/config/config.ts` et `config.html`
- **Dependency:** GradeService pour vérifier la disponibilité des armes

**UI/UX Considerations:**
- Utiliser des toggles pour meilleure UX (switch/toggle buttons)
- Messages informatifs clairs pour expliquer les règles selon le grade
- Champ temps Randori visible uniquement si Randori est activé

**Default Values:**
- `includeWeaponTime`: false (par défaut) ✅ **DÉJÀ IMPLÉMENTÉ**
- `weaponTime`: 5 minutes (par défaut) ✅ **DÉJÀ IMPLÉMENTÉ**
- includeRandori: false (par défaut) - À implémenter
- randoriTime: 10 secondes (par défaut) - À implémenter (en secondes, différent du système actuel)

**Validation:**
- randoriTime: 3-60 secondes (minimum pour annonce, maximum raisonnable)

### Implementation Details

**Component Structure:**

⚠️ **NOTE:** Le système des armes est déjà implémenté. Voici la structure existante (NE PAS MODIFIER):

```typescript
export class ConfigComponent {
  // ✅ DÉJÀ IMPLÉMENTÉ - NE PAS MODIFIER
  includeWeaponTime: boolean = false;
  weaponTime: number = 5; // minutes
  
  get shouldShowWeaponToggle(): boolean {
    const kyūGrades = ['6e Kyū', '5e Kyū', '4e Kyū', '3e Kyū', '2e Kyū'];
    return !kyūGrades.includes(this.selectedGrade);
  }
  
  get shouldShowWeaponTime(): boolean {
    if (!this.includeWeaponTime) return false;
    const kyūGrades = ['6e Kyū', '5e Kyū', '4e Kyū', '3e Kyū', '2e Kyū'];
    return !kyūGrades.includes(this.selectedGrade);
  }
  
  toggleIncludeWeaponTime(): void {
    this.includeWeaponTime = !this.includeWeaponTime;
    this.configService.updateIncludeWeaponTime(this.includeWeaponTime);
  }
  
  // ⏳ À IMPLÉMENTER - Randori (annonce audio finale)
  includeRandori: boolean = false;
  randoriTime: number = 10; // secondes (annonce audio, différent du système actuel includeRandoriTime)

  readonly MIN_RANDORI_TIME = 3;
  readonly MAX_RANDORI_TIME = 60;

  onRandoriToggle() {
    this.includeRandori = !this.includeRandori;
  }

  validateRandoriTime(): boolean {
    return this.randoriTime >= this.MIN_RANDORI_TIME && 
           this.randoriTime <= this.MAX_RANDORI_TIME;
  }
}
```

**Note:** Le système actuel a `includeRandoriTime` (booléen) et `randoriTime` (3 minutes fixe) qui est un temps dédié dans le passage. La Story 2.8 demande un système différent pour une annonce audio finale "Randori" avec un temps configurable en secondes. À clarifier avec l'utilisateur si c'est une nouvelle fonctionnalité ou si on utilise le système existant.

**Template Structure:**

⚠️ **NOTE:** La section des armes est déjà implémentée dans `config.html` (section "Options supplémentaires"). Ne pas modifier cette partie.

Structure actuelle des armes (déjà en place):
```html
<!-- Section Options supplémentaires - DÉJÀ IMPLÉMENTÉ -->
<section class="config-section additional-options-section">
  <h2>Options supplémentaires</h2>
  <p class="config-description">Allouer du temps spécifique aux armes ou au randori</p>
  
  <div class="pill-toggles-container-mobile">
    <button
      type="button"
      class="pill-toggle-button-mobile"
      *ngIf="shouldShowWeaponToggle"
      [class.active]="includeWeaponTime"
      (click)="toggleIncludeWeaponTime()">
      ARMES
    </button>
    <!-- ... -->
  </div>
</section>

<!-- Contrôle Temps dédié aux armes - DÉJÀ IMPLÉMENTÉ -->
<div class="time-control" *ngIf="shouldShowWeaponTime">
  <label>Temps dédié aux armes</label>
  <!-- Contrôles +/- pour weaponTime -->
</div>
```

  <!-- Option Randori -->
  <div class="option-group">
    <h3>Randori</h3>
    <div class="toggle-control">
      <label class="toggle-label">
        <input 
          type="checkbox"
          [(ngModel)]="includeRandori"
          (change)="onRandoriToggle()">
        <span>Activer l'annonce audio "Randori" à la fin du passage</span>
      </label>
      <p class="help-text">
        L'annonce "Randori" sera déclenchée à la fin du passage (pas de techniques spécifiques).
      </p>
    </div>
    
    <div *ngIf="includeRandori" class="randori-time-control">
      <label for="randori-time">Temps de l'annonce Randori (secondes)</label>
      <div class="input-group">
        <button (click)="decrementRandoriTime()" [disabled]="randoriTime <= MIN_RANDORI_TIME">-</button>
        <input 
          type="number" 
          id="randori-time"
          [(ngModel)]="randoriTime"
          [min]="MIN_RANDORI_TIME"
          [max]="MAX_RANDORI_TIME"
          (blur)="validateRandoriTimeInput()">
        <span>secondes</span>
        <button (click)="incrementRandoriTime()" [disabled]="randoriTime >= MAX_RANDORI_TIME">+</button>
      </div>
      <div *ngIf="!validateRandoriTime()" class="error-message">
        Le temps doit être entre {{ MIN_RANDORI_TIME }} et {{ MAX_RANDORI_TIME }} secondes.
      </div>
    </div>
  </div>
</section>
```

**Styling:**
- Utiliser les variables CSS du thème
- Style pour les toggles/checkboxes
- Style pour les champs désactivés (opacity, cursor: not-allowed)
- Messages informatifs avec style distinct (couleur info, background)
- Responsive avec media queries

---

## Dependencies

- ✅ Story 2.2 complétée (getWeaponPositions() ou logique similaire)
- ✅ Story 2.3 complétée (grade sélectionné)
- ✅ PassageFilters interface contient includeWeapons et includeRandori (Story 1.4)
- ✅ **Toggle des armes déjà implémenté** - Le système `includeWeaponTime` avec `shouldShowWeaponToggle` et `weaponTime` est déjà en place et fonctionnel. Ne pas modifier cette partie.

---

## Testing Checklist

- [x] Test: Section "Options supplémentaires" s'affiche ✅ **DÉJÀ TESTÉ**
- [x] Test: Toggle includeWeaponTime fonctionne ✅ **DÉJÀ TESTÉ**
- [x] Test: Toggle includeWeaponTime n'est pas affiché pour les grades Kyū (6e à 2e) ✅ **DÉJÀ TESTÉ**
- [x] Test: Toggle includeWeaponTime est affiché pour les grades >= 1er Kyū ✅ **DÉJÀ TESTÉ**
- [x] Test: Contrôle du temps dédié aux armes s'affiche seulement si includeWeaponTime activé ✅ **DÉJÀ TESTÉ**
- [ ] Test: Toggle includeRandori fonctionne (si nouvelle implémentation nécessaire)
- [ ] Test: Champ temps Randori s'affiche seulement si Randori activé (si nouvelle implémentation)
- [ ] Test: Validation temps Randori fonctionne (3-60s) (si nouvelle implémentation)
- [x] Test: Mises à jour lors du changement de grade (armes) ✅ **DÉJÀ TESTÉ**
- [x] Test: Responsive design fonctionne (armes) ✅ **DÉJÀ TESTÉ**
- [x] Test: Accessibilité (labels, navigation clavier) (armes) ✅ **DÉJÀ TESTÉ**

---

## Definition of Done

- ✅ Tous les Acceptance Criteria sont remplis (armes: déjà fait, Randori: à faire)
- ✅ Code compile sans erreurs
- ✅ Tests unitaires passent (couverture minimale 70%)
- ✅ Logique des armes selon grade fonctionne ✅ **DÉJÀ IMPLÉMENTÉ ET TESTÉ**
- ⏳ Randori configuré correctement (booléen + temps) - À implémenter si nécessaire
- ✅ Interface responsive ✅ **DÉJÀ IMPLÉMENTÉ (armes)**
- ✅ Accessibilité de base respectée ✅ **DÉJÀ IMPLÉMENTÉ (armes)**
- ⏳ Code review effectué (pour la partie Randori)
- ⏳ Documentation du code (JSDoc) ajoutée (pour la partie Randori)
- ⏳ Clarification Randori respectée (pas une position) - À vérifier selon implémentation

**Note:** La partie armes étant déjà complète, cette story se concentre uniquement sur la configuration de Randori si nécessaire.
