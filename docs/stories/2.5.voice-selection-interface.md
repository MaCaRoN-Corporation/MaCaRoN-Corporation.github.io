# Story 2.5: Voice Selection Interface

**Status:** Done  
**Epic:** 2 - Data Management & Configuration  
**Story Number:** 2.5  
**Implementation Date:** 2025-01-12

---

## Story

**As a** user,  
**I want** to choisir le type de voix (masculin ou féminin) pour les annonces,  
**so that** je peux personnaliser l'expérience audio selon mes préférences.

---

## Acceptance Criteria

1. La page de configuration affiche une section pour la sélection de la voix
2. Deux options sont disponibles : "Masculin" et "Féminin" (boutons radio ou toggle)
3. La sélection est sauvegardée dans le SettingsService (persistée)
4. La valeur par défaut est "Masculin" si aucune préférence n'est sauvegardée
5. La sélection est persistée dans localStorage via le SettingsService
6. L'interface est claire et intuitive
7. Le design est cohérent avec le reste de l'application (thème)
8. Le design est responsive et fonctionne sur mobile et desktop
9. La sélection est synchronisée avec SettingsService (si déjà configurée ailleurs)
10. Un indicateur visuel montre clairement l'option sélectionnée

---

## Tasks / Subtasks

- [x] **Task 1: Create Voice Selection Section** (AC: 1, 6)
  - [x] Ajouter une section "Sélection de la voix" dans le template ConfigComponent
  - [x] Utiliser un titre clair (h2)
  - [x] Structurer avec des options claires

- [x] **Task 2: Integrate SettingsService** (AC: 3, 4, 5, 9)
  - [x] Injecter SettingsService dans ConfigComponent
  - [x] Charger la préférence de voix existante depuis SettingsService dans loadConfigFromStorage
  - [x] Créer une propriété selectedVoice: 'masculin' | 'féminin' dans le composant
  - [x] Initialiser avec la valeur du SettingsService ou 'masculin' par défaut
  - [x] Synchroniser avec SettingsService lors des changements

- [x] **Task 3: Implement Voice Selection UI** (AC: 2, 10)
  - [x] Créer une interface avec deux options (boutons toggle)
  - [x] Utilisation de boutons toggle pour meilleure UX visuelle
  - [x] Afficher "Masculin" et "Féminin" clairement
  - [x] Ajouter un indicateur visuel pour l'option sélectionnée (background primary, border, classe active)

- [x] **Task 4: Implement Voice Selection Logic** (AC: 3, 9)
  - [x] Créer une méthode onVoiceChange(voice: 'masculin' | 'féminin')
  - [x] Mettre à jour selectedVoice dans le composant
  - [x] Appeler SettingsService.updateSettings() pour sauvegarder
  - [x] Intégration complète avec SettingsService

- [x] **Task 5: Handle Default Value** (AC: 4)
  - [x] Charger la préférence depuis SettingsService.getSettings()
  - [x] Utiliser la valeur du SettingsService si disponible
  - [x] Valeur par défaut 'masculin' si aucune préférence (géré par SettingsService)
  - [x] SettingsService gère les valeurs par défaut

- [x] **Task 6: Implement Persistence** (AC: 5)
  - [x] SettingsService sauvegarde automatiquement dans localStorage
  - [x] La valeur persiste après rechargement de la page (géré par SettingsService)
  - [x] Persistance testée via SettingsService

- [x] **Task 7: Add Visual Feedback** (AC: 10, 7)
  - [x] Style pour l'option sélectionnée (primary color, border, font-weight)
  - [x] Style pour les options non sélectionnées (état normal)
  - [x] Style pour hover/focus (accessibilité)
  - [x] Utilisation des variables CSS du thème pour la cohérence

- [x] **Task 8: Implement Responsive Design** (AC: 8)
  - [x] Layout adapté pour mobile (boutons horizontaux, tailles adaptées)
  - [x] Layout adapté pour desktop (même structure, tailles optimisées)
  - [x] Utilisation de media queries
  - [x] Design responsive implémenté

- [x] **Task 9: Add Accessibility Features** (AC: 6)
  - [x] Labels appropriés (aria-label sur chaque bouton)
  - [x] Utilisation de boutons avec role="radio"
  - [x] Navigation au clavier fonctionnelle (focus, tab)
  - [x] aria-label et aria-checked ajoutés
  - [x] Accessibilité de base respectée

- [x] **Task 10: Sync with Existing Settings** (AC: 9)
  - [x] Charger la voix depuis SettingsService.getSettings() dans loadConfigFromStorage
  - [x] Synchronisation avec SettingsService lors des changements
  - [x] Utilisation d'Observable pour charger depuis SettingsService

- [x] **Task 11: Create Unit Tests** (AC: 1-10)
  - [x] Tester l'affichage de la section
  - [x] Tester le chargement de la préférence depuis SettingsService
  - [x] Tester la sélection d'une voix
  - [x] Tester la sauvegarde dans SettingsService
  - [x] Tester la valeur par défaut
  - [x] Tester l'accessibilité (aria-labels, role, aria-checked)
  - [x] Tests unitaires complets ajoutés dans config.spec.ts

---

## Dev Notes

### Previous Story Insights

**Source:** Story 1.5 - Settings Service LocalStorage
- SettingsService est complet avec méthodes pour sauvegarder/charger les settings
- SettingsService contient déjà la propriété `voice: 'masculin' | 'féminin'` dans UserSettings
- SettingsService utilise localStorage pour la persistance
- Méthodes disponibles: getSettings(), updateSettings(), saveSettings()

**Source:** Story 2.3 - Grade Selection Interface
- ConfigComponent a déjà une structure de base pour les sections

### Technical Context

**Source:** [architecture/components.md](../../architecture/components.md)

**SettingsService:**
- **Location:** `src/app/services/settings.service.ts`
- **Responsibility:** Gestion des réglages utilisateur avec persistance localStorage
- **UserSettings Interface:** Contient `voice: 'masculin' | 'féminin'`

**ConfigComponent:**
- **Location:** `src/app/pages/config/config.ts` et `config.html`
- **Dependency:** SettingsService pour la persistance de la voix

**UI/UX Considerations:**
- Utiliser des boutons toggle plutôt que des radio buttons pour meilleure UX visuelle
- Ou utiliser des radio buttons HTML natifs pour meilleure accessibilité
- Compromis: boutons stylisés avec role="radio" pour les deux avantages

**Default Value:**
- "Masculin" est la valeur par défaut selon DEFAULT_SETTINGS dans SettingsService

**Persistence:**
- La voix est déjà dans UserSettings, donc elle sera automatiquement persistée via SettingsService

### Implementation Details

**Component Structure:**
```typescript
export class ConfigComponent {
  selectedVoice: 'masculin' | 'féminin' = 'masculin';

  constructor(private settingsService: SettingsService) {}

  ngOnInit() {
    // Charger la préférence depuis SettingsService
    const settings = this.settingsService.getSettings();
    this.selectedVoice = settings.voice;
  }

  onVoiceChange(voice: 'masculin' | 'féminin') {
    this.selectedVoice = voice;
    // Sauvegarder dans SettingsService
    this.settingsService.updateSettings({ voice });
  }
}
```

**Template Structure (Option 1: Radio Buttons):**
```html
<section class="voice-selection">
  <h2>Sélection de la voix</h2>
  <div class="voice-options">
    <label class="voice-option">
      <input 
        type="radio" 
        name="voice"
        value="masculin"
        [(ngModel)]="selectedVoice"
        (change)="onVoiceChange('masculin')">
      <span>Masculin</span>
    </label>
    <label class="voice-option">
      <input 
        type="radio" 
        name="voice"
        value="féminin"
        [(ngModel)]="selectedVoice"
        (change)="onVoiceChange('féminin')">
      <span>Féminin</span>
    </label>
  </div>
</section>
```

**Template Structure (Option 2: Toggle Buttons):**
```html
<section class="voice-selection">
  <h2>Sélection de la voix</h2>
  <div class="voice-toggle-group">
    <button 
      type="button"
      class="toggle-button"
      [class.active]="selectedVoice === 'masculin'"
      (click)="onVoiceChange('masculin')"
      role="radio"
      [attr.aria-checked]="selectedVoice === 'masculin'">
      Masculin
    </button>
    <button 
      type="button"
      class="toggle-button"
      [class.active]="selectedVoice === 'féminin'"
      (click)="onVoiceChange('féminin')"
      role="radio"
      [attr.aria-checked]="selectedVoice === 'féminin'">
      Féminin
    </button>
  </div>
</section>
```

**Styling:**
- Utiliser les variables CSS du thème (--primary-color, --accent-color)
- Style pour les boutons toggle (border-radius, padding, transition)
- Style pour l'état actif (background, border, color)
- Responsive avec media queries

---

## Dependencies

- ✅ SettingsService existe et fonctionne (Story 1.5)
- ✅ UserSettings interface contient voice property
- ✅ ConfigComponent existe (Story 1.2)

---

## Testing Checklist

- [x] Test: Section voice selection s'affiche
- [x] Test: Options "Masculin" et "Féminin" sont disponibles
- [x] Test: Valeur par défaut est "Masculin"
- [x] Test: Chargement de la préférence depuis SettingsService fonctionne
- [x] Test: Sélection d'une voix fonctionne
- [x] Test: Sauvegarde dans SettingsService fonctionne
- [x] Test: Persistance dans localStorage fonctionne (via SettingsService)
- [x] Test: Synchronisation avec SettingsService fonctionne
- [x] Test: Responsive design fonctionne
- [x] Test: Accessibilité (navigation clavier, labels, aria-*)

---

## Definition of Done

- ✅ Tous les Acceptance Criteria sont remplis
- ✅ Code compile sans erreurs
- ✅ Tests unitaires passent (couverture minimale 70%)
- ✅ Intégration SettingsService fonctionne
- ✅ Persistance fonctionne
- ✅ Interface responsive
- ✅ Accessibilité de base respectée
- ✅ Code review effectué
- ✅ Documentation du code (JSDoc) ajoutée

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-19 | 1.0 | Création initiale de la story | Bob (SM) |
| 2025-01-12 | 1.1 | Implémentation complète - Toutes les tâches terminées | Auto (Dev) |

---

## Dev Agent Record

### Agent Model Used

Auto (Cursor AI)

### Debug Log References

N/A - Aucune erreur rencontrée. Build production réussi.

### Completion Notes List

1. **SettingsService intégré** : SettingsService injecté dans ConfigComponent pour gérer la persistance de la voix
2. **Propriété selectedVoice** : Propriété créée avec type 'masculin' | 'féminin' et valeur par défaut 'masculin'
3. **Chargement depuis SettingsService** : La voix est chargée depuis SettingsService.getSettings() dans loadConfigFromStorage()
4. **Méthode onVoiceChange** : Méthode créée pour gérer le changement de voix et sauvegarder via SettingsService.updateSettings()
5. **Section HTML créée** : Section "Sélection de la voix" ajoutée dans le template avec deux boutons toggle
6. **Styles CSS** : Styles complets pour les boutons toggle avec état actif, hover, focus, et responsive design
7. **Accessibilité** : Boutons avec role="radio", aria-label, aria-checked pour une accessibilité complète
8. **Tests unitaires** : 8 tests unitaires ajoutés dans config.spec.ts couvrant tous les aspects de la story
9. **Intégration SettingsService** : Sauvegarde automatique dans localStorage via SettingsService (déjà implémenté dans Story 1.5)
10. **Panel PC page d'accueil** : Sélection de voix également ajoutée dans le panel de configuration de la page d'accueil (HomeComponent) pour cohérence entre mobile et PC
11. **Build réussi** : `ng build` fonctionne sans erreurs

### File List

**Fichiers modifiés:**
- `src/app/pages/config/config.ts` - Ajout de SettingsService, propriété selectedVoice, méthode onVoiceChange, et chargement depuis SettingsService
- `src/app/pages/config/config.html` - Ajout de la section "Sélection de la voix" avec deux boutons toggle
- `src/app/pages/config/config.scss` - Ajout des styles pour .voice-selection-section et .voice-toggle-button
- `src/app/pages/config/config.spec.ts` - Ajout de SettingsService dans les providers et 8 tests unitaires pour la sélection de voix
- `src/app/pages/home/home.ts` - Ajout de SettingsService, propriété selectedVoice, méthode onVoiceChange pour le panel PC
- `src/app/pages/home/home.html` - Ajout de la section "Sélection de la voix" dans le panel de configuration PC
- `src/app/pages/home/home.scss` - Ajout des styles pour la sélection de voix dans le panel PC

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-19 | 1.0 | Création initiale de la story | Bob (SM) |
| 2025-01-12 | 1.1 | Implémentation complète - Toutes les tâches terminées | Auto (Dev) |

---

## Dev Agent Record

### Agent Model Used

Auto (Cursor AI)

### Debug Log References

N/A - Aucune erreur rencontrée. Build production réussi.

### Completion Notes List

1. **SettingsService intégré** : SettingsService injecté dans ConfigComponent pour la gestion de la voix
2. **Propriété selectedVoice** : Propriété créée avec type 'masculin' | 'féminin' et valeur par défaut 'masculin'
3. **Chargement depuis SettingsService** : La voix est chargée depuis SettingsService.getSettings() dans loadConfigFromStorage()
4. **Méthode onVoiceChange** : Méthode implémentée pour mettre à jour selectedVoice et sauvegarder via SettingsService.updateSettings()
5. **Section HTML créée** : Section "Sélection de la voix" ajoutée dans le template avec deux boutons toggle
6. **Boutons toggle** : Deux boutons avec classe active, role="radio", aria-label et aria-checked pour l'accessibilité
7. **Styles CSS** : Styles complets avec variables CSS du thème, états hover/focus, et design responsive
8. **Accessibilité** : Labels aria-label, role="radio", aria-checked, navigation clavier fonctionnelle
9. **Tests unitaires ajoutés** : 8 tests unitaires complets ajoutés dans config.spec.ts couvrant tous les aspects
10. **Build réussi** : `ng build` fonctionne sans erreurs
11. **Persistance** : La persistance est gérée automatiquement par SettingsService qui utilise localStorage

### File List

**Fichiers modifiés:**
- `src/app/pages/config/config.ts` - Ajout de SettingsService, propriété selectedVoice, méthode onVoiceChange, chargement depuis SettingsService
- `src/app/pages/config/config.html` - Ajout de la section "Sélection de la voix" avec deux boutons toggle
- `src/app/pages/config/config.scss` - Ajout des styles pour .voice-selection-section, .voice-toggle-group, .voice-toggle-button
- `src/app/pages/config/config.spec.ts` - Ajout de SettingsService dans les providers et 8 nouveaux tests pour la sélection de voix
