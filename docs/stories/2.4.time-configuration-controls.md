# Story 2.4: Time Configuration Controls

**Status:** Done  
**Epic:** 2 - Data Management & Configuration  
**Story Number:** 2.4  
**Implementation Date:** 2025-01-12

---

## Story

**As a** user,  
**I want** to configurer le temps entre chaque technique et la durée totale du passage,  
**so that** je peux adapter le rythme de l'entraînement à mes besoins.

---

## Acceptance Criteria

1. La page de configuration affiche une section "Configuration du temps"
2. Des contrôles sont disponibles pour configurer le temps entre techniques (en secondes)
3. Des contrôles sont disponibles pour configurer la durée totale du passage (en minutes)
4. Les contrôles utilisent des sliders ou des inputs numériques avec validation
5. Des valeurs par défaut sensées sont proposées (ex: 5 secondes entre techniques, 10 minutes total)
6. Les valeurs sont validées (minimum/maximum raisonnables)
7. Les valeurs configurées sont sauvegardées dans le composant ConfigComponent
8. Un aperçu ou indication visuelle montre l'impact des réglages (nombre estimé de techniques)
9. L'interface est claire et intuitive
10. Le design est responsive et fonctionne sur mobile et desktop

---

## Tasks / Subtasks

- [x] **Task 1: Create Time Configuration Section** (AC: 1, 9)
  - [x] Ajouter une section "Configuration du temps" dans le template ConfigComponent
  - [x] Utiliser un titre clair (h2)
  - [x] Structurer avec des sous-sections pour chaque paramètre

- [x] **Task 2: Implement Time Between Techniques Control** (AC: 2, 4, 5, 6, 7)
  - [x] Créer un contrôle avec boutons +/- (choix fait pour meilleure précision mobile)
  - [x] Définir la valeur par défaut: 20 secondes (valeur alignée avec PassageConfig)
  - [x] Définir les limites: minimum 5 secondes, maximum 120 secondes (valeurs alignées avec PassageConfig)
  - [x] Créer une propriété timeBetweenTechniques: number dans le composant
  - [x] Implémenter la validation (min/max)
  - [x] Sauvegarder la valeur dans le composant via ConfigService

- [x] **Task 3: Implement Total Duration Control** (AC: 3, 4, 5, 6, 7)
  - [x] Créer un contrôle avec boutons +/-
  - [x] Définir la valeur par défaut: 10 minutes
  - [x] Définir les limites: minimum 5 minutes, maximum 60 minutes
  - [x] Créer une propriété totalDuration: number dans le composant (en minutes)
  - [x] Implémenter la validation (min/max)
  - [x] Sauvegarder la valeur dans le composant via ConfigService

- [x] **Task 4: Implement Validation Logic** (AC: 6)
  - [x] Créer des méthodes de validation pour chaque paramètre (validateTimeBetween, validateDuration)
  - [x] Validation intégrée dans les méthodes increment/decrement
  - [x] Les valeurs sont limitées automatiquement aux min/max

- [x] **Task 5: Implement Visual Preview/Calculation** (AC: 8)
  - [x] Calculer le nombre estimé de techniques avec getter estimatedTechniqueCount
  - [x] Afficher un aperçu: "Environ X techniques seront annoncées"
  - [x] Mettre à jour l'aperçu en temps réel (getter réactif)
  - [x] Formater l'affichage avec gestion du pluriel

- [x] **Task 6: Choose UI Components** (AC: 4, 10)
  - [x] Choix: Boutons +/- avec affichage de la valeur (pas de slider)
  - [x] Interface optimisée pour mobile avec boutons +/- pour précision
  - [x] Assurer que les contrôles sont accessibles (labels, aria-*)

- [x] **Task 7: Implement Responsive Design** (AC: 10)
  - [x] Layout adapté pour mobile (une colonne)
  - [x] Layout adapté pour desktop (même structure, tailles adaptées)
  - [x] Utiliser media queries dans config.scss
  - [x] Design responsive testé

- [x] **Task 8: Add Input Formatting** (AC: 9)
  - [x] Affichage des valeurs avec unités ("X secondes", "X minutes")
  - [x] Unités clairement affichées après chaque valeur
  - [x] Labels descriptifs pour chaque contrôle

- [x] **Task 9: Implement Two-Way Binding** (AC: 7)
  - [x] Les valeurs sont liées directement aux propriétés du composant
  - [x] Les changements sont immédiatement reflétés via les méthodes increment/decrement
  - [x] Synchronisation automatique avec ConfigService pour la persistance

- [x] **Task 10: Add Accessibility Features** (AC: 9)
  - [x] Labels appropriés pour chaque contrôle
  - [x] aria-label et aria-disabled sur les boutons
  - [x] Navigation au clavier fonctionnelle
  - [x] Attributs ARIA pour les valeurs (aria-valuemin, aria-valuemax, aria-valuenow)

- [x] **Task 11: Create Unit Tests** (AC: 1-10)
  - [x] Tester l'affichage de la section
  - [x] Tester les valeurs par défaut
  - [x] Tester la validation (min/max)
  - [x] Tester le calcul du nombre de techniques
  - [x] Tester les méthodes increment/decrement
  - [x] Tester l'affichage dans le template et l'accessibilité

---

## Dev Notes

### Previous Story Insights

**Source:** Story 2.3 - Grade Selection Interface
- ConfigComponent a déjà une structure de base pour les sections

**Source:** Story 1.5 - Settings Service LocalStorage
- SettingsService existe pour la persistance, mais les réglages de temps peuvent être spécifiques au passage (pas forcément persistés)

### Technical Context

**Source:** [architecture/components.md](../../architecture/components.md)

**ConfigComponent:**
- **Location:** `src/app/pages/config/config.ts` et `config.html`
- **Responsibility:** Configuration complète avant génération du passage

**Passage Model:**
- Le modèle Passage inclut `duration: number` (durée totale en minutes)
- Le modèle Passage inclut `timeBetweenTechniques: number` (en secondes)

**UI/UX Considerations:**
- Utiliser des inputs numériques avec boutons +/- pour meilleure précision
- Afficher les unités clairement (s, min)
- Aperçu visuel pour aider l'utilisateur à comprendre l'impact

**Default Values:**
- Time between techniques: 5 secondes (raisonnable pour suivre les annonces)
- Total duration: 10 minutes (durée standard pour un passage)

**Validation Rules:**
- Time between techniques: 3-30 secondes (minimum pour comprendre, maximum pour ne pas être trop lent)
- Total duration: 5-60 minutes (minimum pour un passage utile, maximum raisonnable)

### Implementation Details

**Component Structure:**
```typescript
export class ConfigComponent {
  timeBetweenTechniques: number = 5; // secondes, default
  totalDuration: number = 10; // minutes, default

  // Validation constants
  readonly MIN_TIME_BETWEEN = 3;
  readonly MAX_TIME_BETWEEN = 30;
  readonly MIN_DURATION = 5;
  readonly MAX_DURATION = 60;

  // Calcul du nombre estimé de techniques
  get estimatedTechniqueCount(): number {
    const totalSeconds = this.totalDuration * 60;
    return Math.floor(totalSeconds / this.timeBetweenTechniques);
  }

  validateTimeBetween(value: number): boolean {
    return value >= this.MIN_TIME_BETWEEN && value <= this.MAX_TIME_BETWEEN;
  }

  validateDuration(value: number): boolean {
    return value >= this.MIN_DURATION && value <= this.MAX_DURATION;
  }
}
```

**Template Structure:**
```html
<section class="time-configuration">
  <h2>Configuration du temps</h2>
  
  <div class="time-control">
    <label for="time-between">Temps entre techniques</label>
    <div class="input-group">
      <button (click)="decrementTimeBetween()" [disabled]="timeBetweenTechniques <= MIN_TIME_BETWEEN">-</button>
      <input 
        type="number" 
        id="time-between"
        [(ngModel)]="timeBetweenTechniques"
        [min]="MIN_TIME_BETWEEN"
        [max]="MAX_TIME_BETWEEN"
        (blur)="validateTimeBetweenInput()">
      <span>secondes</span>
      <button (click)="incrementTimeBetween()" [disabled]="timeBetweenTechniques >= MAX_TIME_BETWEEN">+</button>
    </div>
  </div>

  <div class="time-control">
    <label for="duration">Durée totale</label>
    <div class="input-group">
      <button (click)="decrementDuration()" [disabled]="totalDuration <= MIN_DURATION">-</button>
      <input 
        type="number" 
        id="duration"
        [(ngModel)]="totalDuration"
        [min]="MIN_DURATION"
        [max]="MAX_DURATION"
        (blur)="validateDurationInput()">
      <span>minutes</span>
      <button (click)="incrementDuration()" [disabled]="totalDuration >= MAX_DURATION">+</button>
    </div>
  </div>

  <div class="preview">
    <p>Environ <strong>{{ estimatedTechniqueCount }}</strong> techniques seront annoncées</p>
  </div>
</section>
```

**Styling:**
- Utiliser les variables CSS du thème
- Style pour les inputs numériques (border, padding)
- Style pour les boutons +/-
- Style pour l'aperçu (mise en évidence)
- Responsive avec media queries

---

## Dependencies

- ✅ ConfigComponent existe (Story 1.2)
- ✅ Passage model défini avec duration et timeBetweenTechniques

---

## Testing Checklist

- [x] Test: Section time configuration s'affiche
- [x] Test: Valeurs par défaut sont correctes (20s, 10min - valeurs alignées avec PassageConfig)
- [x] Test: Validation min/max fonctionne
- [x] Test: Calcul du nombre de techniques est correct
- [x] Test: Aperçu se met à jour lors des changements
- [x] Test: Boutons +/- fonctionnent
- [x] Test: Responsive design fonctionne
- [x] Test: Accessibilité (labels, navigation clavier, aria-*)
- [x] Test: Tests unitaires complets ajoutés dans config.spec.ts

---

## Definition of Done

- ✅ Tous les Acceptance Criteria sont remplis
- ✅ Code compile sans erreurs
- ✅ Tests unitaires passent (couverture minimale 70%)
- ✅ Validation fonctionne correctement
- ✅ Aperçu/calcul fonctionne
- ✅ Interface responsive
- ✅ Accessibilité de base respectée
- ✅ Code review effectué
- ✅ Documentation du code (JSDoc) ajoutée

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-19 | 1.0 | Création initiale de la story | Bob (SM) |
| 2025-01-12 | 1.1 | Implémentation complète - Toutes les tâches terminées | Auto (Dev) |

---

## Dev Agent Record

### Agent Model Used

Auto (Cursor AI)

### Debug Log References

N/A - Aucune erreur rencontrée. Build production réussi.

### Completion Notes List

1. **Implémentation déjà complète** : La Story 2.4 était déjà implémentée dans le code, avec tous les contrôles de temps fonctionnels
2. **Valeurs réelles utilisées** : Les valeurs diffèrent légèrement de la spécification initiale mais sont alignées avec PassageConfig :
   - MIN_TIME_BETWEEN = 5s (spécification: 3s)
   - MAX_TIME_BETWEEN = 120s (spécification: 30s)
   - Default = 20s (spécification: 5s)
   - MIN_DURATION = 5min (conforme)
   - MAX_DURATION = 60min (conforme)
   - Default = 10min (conforme)
3. **Contrôles implémentés** : Boutons +/- pour timeBetweenTechniques et totalDuration avec affichage des valeurs et unités
4. **Validation** : Méthodes validateTimeBetween() et validateDuration() implémentées
5. **Aperçu visuel** : Getter estimatedTechniqueCount calculant le nombre estimé de techniques avec gestion du temps dédié aux armes et randori
6. **Styles responsive** : Styles CSS complets avec media queries dans config.scss
7. **Accessibilité** : Labels, aria-label, aria-disabled, aria-valuemin/max/now implémentés
8. **Tests unitaires ajoutés** : 19 tests unitaires complets ajoutés dans config.spec.ts couvrant tous les aspects de la story
9. **Intégration ConfigService** : Sauvegarde automatique via ConfigService.updateTimeBetweenTechniques() et updateTotalDuration()
10. **Build réussi** : `ng build` fonctionne sans erreurs

### File List

**Fichiers existants (déjà implémentés):**
- `src/app/pages/config/config.ts` - ConfigComponent avec propriétés et méthodes de contrôle du temps
- `src/app/pages/config/config.html` - Template avec section "Configuration du temps"
- `src/app/pages/config/config.scss` - Styles pour les contrôles de temps

**Fichiers modifiés:**
- `src/app/pages/config/config.spec.ts` - Tests unitaires ajoutés pour les contrôles de temps (19 nouveaux tests)

---

## Notes Importantes

### Valeurs Différentes de la Spécification

Les valeurs utilisées dans l'implémentation diffèrent de celles spécifiées initialement dans la story, mais elles sont alignées avec le modèle `PassageConfig` défini dans l'architecture :

- **Time Between Techniques** : 
  - Spécification : 3-30s, default 5s
  - Implémentation : 5-120s, default 20s (aligné avec PassageConfig)
  
- **Total Duration** :
  - Spécification : 5-60min, default 10min
  - Implémentation : 5-60min, default 10min (conforme)

Ces valeurs plus larges pour le temps entre techniques permettent une meilleure flexibilité pour l'utilisateur, notamment pour les passages plus longs où plus de temps entre chaque technique peut être nécessaire.

### Fonctionnalités Supplémentaires

L'implémentation inclut également des fonctionnalités supplémentaires :
- Calcul du nombre estimé de techniques excluant le temps dédié aux armes (si activé)
- Calcul excluant le temps de randori (si activé)
- Pas d'incrémentation de 5 secondes pour timeBetweenTechniques (TIME_STEP)
- Intégration complète avec ConfigService pour la persistance
