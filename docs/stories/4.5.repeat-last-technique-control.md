# Story 4.5: Repeat Last Technique Control

**Status:** Draft  
**Epic:** 4 - Audio System & User Controls  
**Story Number:** 4.5  

---

## Story

**As a** user,  
**I want** pouvoir répéter la dernière technique annoncée,  
**so that** je peux réécouter si je n'ai pas bien compris.

---

## Acceptance Criteria

1. Un bouton "Répéter" est visible sur la page de passage
2. Le bouton répète l'annonce audio de la dernière technique (ou technique en cours)
3. Le bouton peut être utilisé même si le passage est en pause
4. Le raccourci clavier **Entrée** fonctionne pour répéter (à implémenter dans Story 4.7)
5. L'interface indique clairement quelle technique sera répétée
6. La répétition ne perturbe pas le flux du passage (ne remet pas en pause si en cours)

---

## Tasks / Subtasks

- [ ] **Task 1: Add Repeat Button to Passage UI** (AC: 1)
  - [ ] Ajouter un bouton "Répéter" dans `passage.html`
  - [ ] Placer le bouton à côté du bouton pause/resume dans les contrôles
  - [ ] Ajouter l'icône appropriée (replay/refresh icon)
  - [ ] Styliser le bouton de manière cohérente avec les autres contrôles

- [ ] **Task 2: Implement Repeat Functionality** (AC: 2, 3)
  - [ ] Créer une méthode `repeatLastTechnique()` dans PassageComponent
  - [ ] Appeler `audioService.repeatLastTechnique()` (déjà implémenté dans Story 4.1)
  - [ ] S'assurer que la répétition fonctionne même en pause
  - [ ] Stocker la dernière technique annoncée pour la répétition

- [ ] **Task 3: Handle Repeat During Pause** (AC: 3, 6)
  - [ ] Vérifier que la répétition ne remet pas le passage en cours si il était en pause
  - [ ] Vérifier que la répétition ne perturbe pas le flux normal si le passage est en cours
  - [ ] Tester les différents états (pause, play, fin de passage)

- [ ] **Task 4: Visual Feedback** (AC: 5)
  - [ ] Afficher un indicateur visuel quand la répétition est en cours (optionnel)
  - [ ] S'assurer que le bouton est désactivé si aucune technique n'a été annoncée
  - [ ] Ajouter un tooltip/title au bouton pour clarifier son action

- [ ] **Task 5: Integration with AudioService** (AC: 2)
  - [ ] Vérifier que `audioService.repeatLastTechnique()` est correctement implémenté
  - [ ] S'assurer que la répétition utilise la même voix que la technique originale
  - [ ] Tester que la répétition joue l'attaque ET la technique (comme l'original)

- [ ] **Task 6: Test Repeat Functionality** (AC: 1-6)
  - [ ] Tester le bouton répéter dans différents états (pause, play, fin)
  - [ ] Tester que la répétition ne perturbe pas le flux
  - [ ] Tester visuellement que l'interface est claire
  - [ ] Tester avec différentes techniques

---

## Dev Notes

### Previous Story Insights

**Source:** Story 4.1 - Audio Service with Local Audio Files
- AudioService implémente `repeatLastTechnique()` qui répète la dernière technique annoncée
- La méthode stocke automatiquement la dernière technique et voiceId
- La répétition utilise la même logique que `playTechnique()`

**Source:** Story 4.3 - Audio Playback During Passage
- AudioService est intégré dans PassageComponent et PassageService
- Les techniques sont annoncées automatiquement lors des transitions

**Source:** Story 3.3 - Passage Page Layout and Timer
- PassageComponent a déjà les contrôles (pause/resume, skip)
- Le bouton répéter doit s'intégrer dans cette section de contrôles
- Layout responsive (PC et mobile)

### Technical Context

**Source:** [architecture/components.md](../../architecture/components.md)
- AudioService expose `repeatLastTechnique()` pour répéter la dernière technique

**UI Considerations:**
- Le bouton doit être visible et accessible pendant le passage
- Placement : à côté du bouton pause/resume dans la section contrôles
- Design : cohérent avec les autres boutons (glassmorphism, icônes SVG)
- Responsive : visible sur PC et mobile

**Behavior:**
- La répétition doit fonctionner même si le passage est en pause
- La répétition ne doit pas affecter l'état du passage (ne pas reprendre si en pause)
- Si aucune technique n'a été annoncée, le bouton doit être désactivé

### Testing

**Test file location:** `src/app/pages/passage/passage.spec.ts`

**Test standards:**
- Tester que le bouton est visible et cliquable
- Tester que `audioService.repeatLastTechnique()` est appelé
- Tester que la répétition fonctionne en pause
- Tester que la répétition ne perturbe pas le flux
- Tester le désactivation du bouton si aucune technique

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-13 | 1.0 | Création initiale de la story | SM |

---

## Dev Agent Record

### Agent Model Used
_À remplir par le dev agent_

### Completion Notes List
_À remplir par le dev agent_

### File List
_À remplir par le dev agent_

---

## QA Results
_À remplir par le QA agent_
