# Story 4.3: Audio Playback During Passage

**Status:** Done  
**Epic:** 4 - Audio System & User Controls  
**Story Number:** 4.3  

---

## Story

**As a** user,  
**I want** entendre l'annonce audio de chaque technique et attaque pendant le passage,  
**so that** l'expérience simule fidèlement un vrai passage de grade.

---

## Acceptance Criteria

1. Pendant le passage, chaque technique est annoncée audio au moment approprié
2. L'annonce audio se synchronise avec l'affichage visuel de la technique
3. L'audio joue après le compte à rebours (ou pendant selon le design)
4. L'audio est clair et compréhensible
5. Le volume audio est approprié (configurable via les réglages système)
6. L'audio ne se chevauche pas (un audio se termine avant que le suivant commence)
7. L'audio respecte la sélection de voix (masculin/féminin)

---

## Tasks / Subtasks

- [x] **Task 1: Integrate AudioService in PassageComponent** (AC: 1, 2)
  - [x] Injecter AudioService dans PassageComponent
  - [x] Appeler `audioService.resetComparisonState()` au début d'un nouveau passage
  - [x] Appeler `audioService.playTechnique()` quand une nouvelle technique est affichée
  - [x] Synchroniser avec l'affichage visuel (quand `currentTechnique` change)

- [x] **Task 2: Integrate AudioService in PassageService** (AC: 1, 6)
  - [x] Pas besoin d'injecter dans PassageService (géré dans PassageComponent)
  - [x] L'audio est appelé depuis PassageComponent lors des changements de technique
  - [x] La file d'attente du service gère déjà les chevauchements

- [x] **Task 3: Timing Integration with Countdown** (AC: 3)
  - [x] Audio joue immédiatement quand la technique change (avant countdown)
  - [x] Intégré avec le système de countdown existant dans PassageComponent
  - [x] L'audio se joue dès l'affichage de la technique pour que l'utilisateur entende l'annonce au début

- [x] **Task 4: Voice Selection Integration** (AC: 7)
  - [x] Récupérer la voix sélectionnée depuis SettingsService
  - [x] Passer le VoiceId correct à `audioService.playTechnique()`
  - [x] S'assurer que la voix est mise à jour si l'utilisateur change de voix pendant le passage (subscription)

- [x] **Task 5: Audio Volume Management** (AC: 5)
  - [x] Utiliser le volume système par défaut (pas de contrôle volume dans l'app)
  - [x] Le volume est géré par le système (HTMLAudioElement utilise le volume système)

- [x] **Task 6: Handle Audio Errors Gracefully** (AC: 4)
  - [x] Gérer les erreurs audio sans interrompre le passage (catch avec console.warn)
  - [x] Logger les erreurs pour le debugging
  - [x] Continuer le passage même si un audio échoue

- [x] **Task 7: Pause/Resume Audio Integration** (AC: 1, 6)
  - [x] Intégrer pause/resume audio avec les contrôles du passage
  - [x] Arrêter l'audio quand le passage se termine
  - [x] Nettoyer l'audio dans ngOnDestroy

- [ ] **Task 8: Test Audio Playback Integration** (AC: 1-7)
  - [ ] Tester que l'audio joue pour chaque technique
  - [ ] Tester la synchronisation avec l'affichage visuel
  - [ ] Tester que les audios ne se chevauchent pas
  - [ ] Tester avec différentes voix
  - [ ] Tester la gestion d'erreurs

---

## Dev Notes

### Previous Story Insights

**Source:** Story 4.1 - Audio Service with Local Audio Files
- AudioService implémenté avec `playTechnique(technique: Technique, voiceId: VoiceId): Promise<void>`
- **Logique hiérarchique** : compare avec la technique précédente et joue seulement ce qui a changé
- Ordre strict : Position → Attaque → Technique
- Méthode `resetComparisonState()` pour réinitialiser l'état au début d'un nouveau passage
- Service gère la file d'attente et les erreurs
- Service expose des observables pour les événements audio

**Source:** Story 3.2 - Passage State Management
- PassageService gère l'état du passage avec `getPassageState(): Observable<PassageState>`
- Méthode `nextTechnique(skip: boolean)` pour passer à la technique suivante
- PassageState contient `currentTechniqueIndex` et `currentPassage`

**Source:** Story 3.3 - Passage Page Layout and Timer
- PassageComponent gère le countdown visuel
- `startCountdown()` démarre le compte à rebours
- `handlePassageState()` met à jour l'affichage quand l'état change

**Source:** Story 2.5 - Voice Selection Interface
- SettingsService expose `getSettings(): Observable<UserSettings>`
- UserSettings contient `voice: VoiceId` (format `{language}_{id}`)

### Technical Context

**Source:** [architecture/components.md](../../architecture/components.md)
- PassageService dépend d'AudioService pour les annonces
- AudioService doit être appelé lors des transitions de techniques

**Timing considerations:**
- Le countdown actuel dure `configuredCountdownSeconds` (par défaut 20 secondes)
- L'audio doit jouer au bon moment pour ne pas perturber l'utilisateur
- Option 1 : Audio immédiatement quand la technique change (avant countdown)
- Option 2 : Audio après le countdown (quand on passe à la technique suivante)
- Option 3 : Audio pendant le countdown (au début)

**Recommandation:** Audio immédiatement quand la technique change (Option 1) pour que l'utilisateur entende l'annonce dès le début de la période de préparation.

### Testing

**Test file location:** 
- `src/app/services/passage.service.spec.ts` (pour PassageService)
- `src/app/pages/passage/passage.spec.ts` (pour PassageComponent)

**Test standards:**
- Mocker AudioService dans les tests
- Tester que `playTechnique()` est appelé au bon moment
- Tester la synchronisation avec l'affichage visuel
- Tester que les audios ne se chevauchent pas
- Tester avec différentes voix

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-13 | 1.0 | Création initiale de la story | SM |
| 2025-01-15 | 1.1 | Implémentation complète de l'intégration audio | Dev |

---

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (Auto)

### Debug Log References
- Build réussi sans erreurs
- AudioService intégré dans PassageComponent

### Completion Notes List
- AudioService injecté dans PassageComponent
- `resetComparisonState()` appelé au début d'un nouveau passage
- `playTechnique()` appelé automatiquement quand `currentTechnique` change
- Audio joue immédiatement quand la technique change (avant le countdown)
- Intégration pause/resume : l'audio se met en pause/reprend avec le passage
- Arrêt de l'audio quand le passage se termine
- Nettoyage de l'audio dans ngOnDestroy
- Gestion d'erreurs gracieuse : les erreurs audio n'interrompent pas le passage
- Subscription à SettingsService pour mettre à jour la voix si elle change

### File List
- `src/app/pages/passage/passage.ts` - Intégration AudioService complète

---

## QA Results
_À remplir par le QA agent_
